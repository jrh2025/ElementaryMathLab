<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­‰é‡å…¬ç†äº’å‹•å¯¦é©—å®¤ v3.3</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        .animate-shake {
            animation: shake 0.4s ease-in-out;
        }

        /* ç¢ºä¿ç®—å¼ä¸æ›è¡Œ */
        .equation-text {
            white-space: nowrap;
        }
    </style>
</head>

<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icon Components ---
        const Scale = ({ className, size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" /><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" /><path d="M7 21h10" /><path d="M12 3v18" /><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2" />
            </svg>
        );

        const ArrowRight = ({ className, size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M5 12h14" /><path d="m12 5 7 7-7 7" />
            </svg>
        );

        const RotateCcw = ({ className, size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" />
            </svg>
        );

        const UndoIcon = ({ className, size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M9 14 4 9l5-5" /><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11" />
            </svg>
        );

        const Lightbulb = ({ className, size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5 0-2.2-1.8-4-4-4s-4 1.8-4 4c0 1.5.5 2.5 1.5 3.5.8.8 1.3 1.5 1.5 2.5" /><path d="M9 18h6" /><path d="M10 22h4" />
            </svg>
        );

        const HelpCircle = ({ className, size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="12" cy="12" r="10" /><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" /><path d="M12 17h.01" />
            </svg>
        );

        const Trophy = ({ className, size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" /><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" /><path d="M4 22h16" /><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" /><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" /><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" />
            </svg>
        );

        const Calculator = ({ className, size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <rect width="16" height="20" x="4" y="2" rx="2" /><line x1="8" x2="16" y1="6" y2="6" /><line x1="16" x2="16" y1="14" y2="18" /><path d="M16 10h.01" /><path d="M12 10h.01" /><path d="M8 10h.01" /><path d="M12 14h.01" /><path d="M8 14h.01" /><path d="M12 18h.01" /><path d="M8 18h.01" />
            </svg>
        );

        const BookOpen = ({ className, size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" /><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
            </svg>
        );

        // --- Main Component ---
        const EquationSolver = () => {
            // éŠæˆ²ç‹€æ…‹ (ax + b = cx + d)
            const [level, setLevel] = useState(1);
            const [equation, setEquation] = useState({ la: 1, lb: 0, ra: 0, rb: 0 });
            const [problemText, setProblemText] = useState({ story: "", explanation: "" });

            // æ­·å²ç´€éŒ„ (ç”¨æ–¼é¡¯ç¤º) èˆ‡ ç‹€æ…‹å †ç–Š (ç”¨æ–¼å¾©åŸ)
            const [history, setHistory] = useState([]);
            const [undoStack, setUndoStack] = useState([]);

            const [solved, setSolved] = useState(false);
            const [userFeedback, setUserFeedback] = useState("");
            const [shake, setShake] = useState(false);

            // ç”¨æˆ¶è¼¸å…¥ç‹€æ…‹
            const [selectedOp, setSelectedOp] = useState(null); // '+', '-', '*', '/'
            const [inputVal, setInputVal] = useState('');
            const [isVariableTerm, setIsVariableTerm] = useState(false); // true è¡¨ç¤ºæ“ä½œ "xé …", false è¡¨ç¤º "æ•¸å­—"

            // åˆå§‹åŒ–é¡Œç›®
            useEffect(() => {
                generateProblem();
            }, [level]);

            // ç”¢ç”Ÿæ‡‰ç”¨é¡Œæ–‡æ¡ˆ
            const generateStory = (type, params) => {
                const { x, a, b, c, d } = params;
                const items = ["è˜‹æœ", "ç³–æœ", "åŸå­ç­†", "è²¼ç´™", "å½ˆç "];
                const item = items[Math.floor(Math.random() * items.length)];

                if (type === 1) { // x + b = d
                    if (b > 0) {
                        return { story: `å°æ˜æœ‰ä¸€äº›${item}(x)ï¼Œåˆè²·äº† ${b} å€‹ï¼Œç¾åœ¨ç¸½å…±æœ‰ ${d} å€‹ã€‚`, explanation: `åˆ—å¼ï¼šx + ${b} = ${d}` };
                    } else {
                        return { story: `å°æ˜æœ‰ä¸€äº›${item}(x)ï¼Œé€çµ¦æœ‹å‹ ${Math.abs(b)} å€‹å¾Œï¼Œé‚„å‰©ä¸‹ ${d} å€‹ã€‚`, explanation: `åˆ—å¼ï¼šx - ${Math.abs(b)} = ${d}` };
                    }
                } else if (type === 2) { // ax = d
                    return { story: `ä¸€ç›’${item}æœ‰ x å€‹ï¼Œè€å¸«è²·äº† ${a} ç›’ï¼Œç¸½å…±æœ‰ ${d} å€‹${item}ã€‚`, explanation: `åˆ—å¼ï¼š${a}x = ${d}` };
                } else if (type === 3) { // ax + b = d
                    if (b > 0) {
                        return { story: `è¨ˆç¨‹è»Šèµ·è·³åƒ¹ ${b} å…ƒï¼Œä¹‹å¾Œæ¯å…¬é‡Œ ${a} å…ƒã€‚å°è¯æ­äº† x å…¬é‡Œï¼Œç¸½å…±ä»˜äº† ${d} å…ƒã€‚`, explanation: `åˆ—å¼ï¼š${a}x + ${b} = ${d}` };
                    } else {
                        return { story: `å•†åº—ä¿ƒéŠ·ï¼Œæ¯åŒ…é¤…ä¹¾ ${a} å…ƒ (è²·xåŒ…)ï¼ŒæŠ˜åƒ¹ ${Math.abs(b)} å…ƒå¾Œï¼Œå¯¦ä»˜ ${d} å…ƒã€‚`, explanation: `åˆ—å¼ï¼š${a}x - ${Math.abs(b)} = ${d}` };
                    }
                } else if (type === 4) { // ax + b = cx + d
                    return { story: `ç”²ç®±æœ‰ ${a} åŒ…${item}å’Œ ${b} å€‹æ•£è£ï¼Œä¹™ç®±æœ‰ ${c} åŒ…${item}å’Œ ${d} å€‹æ•£è£ã€‚å…©ç®±ç¸½æ•¸ä¸€æ¨£å¤šã€‚`, explanation: `åˆ—å¼ï¼š${a}x + ${b} = ${c}x + ${d}` };
                }
                return { story: "", explanation: "" };
            };

            const generateProblem = () => {
                setHistory([]);
                setUndoStack([]);
                setSolved(false);
                setUserFeedback("è«‹è§€å¯Ÿé¡Œç›®èˆ‡ç®—å¼ï¼Œæ€è€ƒå¦‚ä½•å°‡ x èˆ‡æ•¸å­—åˆ†é–‹ã€‚");
                setInputVal('');
                setSelectedOp(null);
                setIsVariableTerm(false);

                let la = 1, lb = 0, ra = 0, rb = 0;
                let x = Math.floor(Math.random() * 9) + 2;
                let storyData = { story: "", explanation: "" };

                // ç”¢ç”ŸåŸºæœ¬åƒæ•¸
                if (level === 1) {
                    la = 1;
                    lb = Math.floor(Math.random() * 19) - 9;
                    if (lb === 0) lb = 5;
                    ra = 0;
                } else if (level === 2) {
                    la = Math.floor(Math.random() * 8) + 2;
                    lb = 0;
                    ra = 0;
                } else if (level === 3) {
                    la = Math.floor(Math.random() * 5) + 2;
                    lb = Math.floor(Math.random() * 19) - 9;
                    if (lb === 0) lb = 3;
                    ra = 0;
                } else {
                    // Level 4: ax + b = cx + d
                    // ä¿è­‰æ­£æ•´æ•¸è§£ä¸”ä¿‚æ•¸ç‚ºæ­£
                    let diffA = Math.floor(Math.random() * 3) + 1;
                    ra = Math.floor(Math.random() * 3) + 1;
                    la = ra + diffA;
                    let rhsDiff = diffA * x;
                    lb = Math.floor(Math.random() * 10) + 1; // 1~10 æ­£æ•¸
                    rb = lb + rhsDiff;
                }

                // ä¿®æ­£ 1: ç¢ºä¿ç®—å¼çµæœ rb ä¸ç‚ºè² æ•¸ (åœ‹å°ç¯„åœä¸å‡ºç¾è² æ•¸çµæœ)
                if (level === 1 || level === 3) {
                    // è¨ˆç®—çµæœ
                    rb = la * x + lb;

                    // å¦‚æœçµæœå°æ–¼ 0ï¼Œå¼·åˆ¶å°‡å¸¸æ•¸é …è½‰ç‚ºæ­£æ•¸ (æ”¹æˆåŠ æ³•é¡Œ)
                    if (rb < 0) {
                        lb = Math.abs(lb);
                        rb = la * x + lb;
                    }
                } else if (level === 2) {
                    rb = la * x;
                }
                // Level 4 çš„ rb å·²ç¶“åœ¨ä¸Šæ–¹è¨ˆç®—ä¸”ä¿è­‰ç‚ºæ­£æ•¸

                // ç”¢ç”Ÿ Story
                if (level === 1) storyData = generateStory(1, { x, a: la, b: lb, c: ra, d: rb });
                else if (level === 2) storyData = generateStory(2, { x, a: la, b: lb, c: ra, d: rb });
                else if (level === 3) storyData = generateStory(3, { x, a: la, b: lb, c: ra, d: rb });
                else storyData = generateStory(4, { x, a: la, b: lb, c: ra, d: rb });

                setEquation({ la, lb, ra, rb });
                setProblemText(storyData);
            };

            const formatSide = (a, b) => {
                let parts = [];
                if (a !== 0) {
                    if (a === 1) parts.push("x");
                    else if (a === -1) parts.push("-x");
                    else parts.push(`${a}x`);
                }
                if (b !== 0) {
                    if (b > 0) {
                        if (parts.length > 0) parts.push(`+ ${b}`);
                        else parts.push(`${b}`);
                    } else {
                        if (parts.length > 0) parts.push(`- ${Math.abs(b)}`);
                        else parts.push(`${b}`);
                    }
                }
                if (a === 0 && b === 0) return "0";
                return parts.join(" ");
            };

            const formatEquationFull = (eq) => {
                return {
                    left: formatSide(eq.la, eq.lb),
                    right: formatSide(eq.ra, eq.rb)
                };
            };

            // åŸ·è¡Œ Undo
            const handleUndo = () => {
                if (undoStack.length === 0) {
                    triggerShake("å·²ç¶“æ˜¯æœ€åˆç‹€æ…‹ï¼Œç„¡æ³•å¾©åŸå›‰ï¼");
                    return;
                }
                const prev = undoStack[undoStack.length - 1];

                // é‚„åŸç‹€æ…‹
                setEquation(prev.equation);
                setSolved(false); // å¾©åŸå¾Œä¸€å®šæœªå®Œæˆ (é™¤éå¾©åŸåˆ°å®Œæˆç‹€æ…‹ï¼Œä½†é‚è¼¯ä¸Šå¾©åŸé€šå¸¸æ˜¯æƒ³ä¿®æ­£)

                // ç§»é™¤æœ€å¾Œä¸€ç­†å †ç–Š
                setUndoStack(undoStack.slice(0, -1));

                // ç§»é™¤é¡¯ç¤ºçš„æ­·å²ç´€éŒ„
                setHistory(history.slice(0, -1));

                setUserFeedback("å·²å¾©åŸåˆ°ä¸Šä¸€æ­¥ã€‚");
            };

            // åŸ·è¡Œ æç¤º (Hint)
            const handleHint = () => {
                const { la, lb, ra, rb } = equation;

                // 1. æª¢æŸ¥å…©é‚Šæ˜¯å¦éƒ½æœ‰ x (é‡å° Level 4)
                if (la !== 0 && ra !== 0) {
                    // å»ºè­°æ¶ˆæ‰ä¿‚æ•¸è¼ƒå°çš„ x
                    const minCoeff = Math.min(Math.abs(la), Math.abs(ra));
                    const target = (Math.abs(la) === minCoeff) ? "å·¦é‚Š" : "å³é‚Š";
                    setUserFeedback(`ğŸ’¡ æç¤ºï¼šå…©é‚Šéƒ½æœ‰ xï¼Œå»ºè­°ä½¿ç”¨ã€Œæ¸›æ³•ã€æ¶ˆæ‰${target}çš„ ${minCoeff}xã€‚`);
                    return;
                }

                // 2. æª¢æŸ¥å…©é‚Šæ˜¯å¦éƒ½æœ‰å¸¸æ•¸ (é€šå¸¸é€™ä¸€æ­¥æœƒåœ¨æ¶ˆ x ä¹‹å¾Œï¼Œæˆ–æ˜¯ä¸€é–‹å§‹)
                // æˆ‘å€‘çš„ç›®æ¨™æ ¼å¼é€šå¸¸æ˜¯ ax = b æˆ– x = b
                // å¦‚æœç›®å‰æ˜¯ ax + b = c
                if (la !== 0 && lb !== 0 && rb !== 0) {
                    // å»ºè­°æ¶ˆæ‰è·Ÿ x åŒé‚Šçš„å¸¸æ•¸
                    const op = lb > 0 ? "æ¸›" : "åŠ ";
                    setUserFeedback(`ğŸ’¡ æç¤ºï¼šx çš„æ—é‚Šé‚„æœ‰å¸¸æ•¸ ${lb}ï¼Œè©¦è‘—ç”¨ã€Œ${op}æ³•ã€æŠŠå®ƒæŠµéŠ·æ‰ï¼Ÿ`);
                    return;
                }

                // 3. å¦‚æœæ˜¯ ax = b çš„å½¢å¼
                if (la !== 0 && lb === 0) {
                    if (la === 1) {
                        setUserFeedback("ğŸ’¡ æç¤ºï¼šx ä¿‚æ•¸å·²ç¶“æ˜¯ 1 äº†ï¼Œçœ‹çœ‹å¦ä¸€é‚Šæ˜¯å¤šå°‘ï¼Ÿ");
                    } else {
                        setUserFeedback(`ğŸ’¡ æç¤ºï¼šç¾åœ¨æ˜¯ ${la} å€‹ xï¼Œè¦è®Šå› 1 å€‹ xï¼Œå¯ä»¥ã€Œé™¤ä»¥ ${la}ã€å–”ï¼`);
                    }
                    return;
                }

                // é è¨­æç¤º
                setUserFeedback("ğŸ’¡ æç¤ºï¼šè§€å¯Ÿçœ‹çœ‹ï¼Œä½ çš„ç›®æ¨™æ˜¯è®“ x å–®ç¨ç•™åœ¨ç­‰è™Ÿä¸€é‚Šã€‚");
            };

            // åŸ·è¡Œé‹ç®—
            const handleOperation = () => {
                if (!selectedOp || !inputVal) {
                    triggerShake("è«‹å…ˆé¸æ“‡é‹ç®—ç¬¦è™Ÿä¸¦è¼¸å…¥æ•¸å­—ï¼");
                    return;
                }

                const val = parseFloat(inputVal);
                if (isNaN(val) || val === 0) {
                    triggerShake("è«‹è¼¸å…¥æœ‰æ•ˆçš„éé›¶æ•¸å­—ã€‚");
                    return;
                }

                // æº–å‚™è¨˜éŒ„ Undo
                const currentEqState = { equation: { ...equation } };

                let newEq = { ...equation };
                let actionDesc = "";

                if (isVariableTerm) {
                    // æ“ä½œæœªçŸ¥æ•¸é …
                    if (selectedOp === '+') {
                        newEq.la += val;
                        newEq.ra += val;
                        actionDesc = `å…©é‚ŠåŒæ™‚åŠ  ${val}x`;
                    } else if (selectedOp === '-') {
                        newEq.la -= val;
                        newEq.ra -= val;
                        actionDesc = `å…©é‚ŠåŒæ™‚æ¸› ${val}x`;
                    } else if (selectedOp === '*') {
                        // ä¹˜æ³•ï¼šç”¢ç”Ÿ x^2ï¼Œé˜»æ­¢ä¸¦æç¤º
                        triggerShake("é€™æ¨£ x æœƒè®Šæˆå¹³æ–¹ (xÂ²)ï¼Œé€™å¤ªè¤‡é›œå›‰ï¼æˆ‘å€‘å…ˆå­¸ç·šæ€§çš„ã€‚");
                        return;
                    } else if (selectedOp === '/') {
                        // é™¤æ³•ï¼šç”¢ç”Ÿ 1/xï¼Œé˜»æ­¢ä¸¦æç¤º
                        triggerShake("é€™æ¨£ x æœƒè·‘åˆ°åˆ†æ¯ (1/x)ï¼Œé€™ä»¥å¾Œæ‰æœƒå­¸åˆ°å–”ï¼");
                        return;
                    }
                } else {
                    // æ“ä½œå¸¸æ•¸
                    switch (selectedOp) {
                        case '+':
                            newEq.lb += val;
                            newEq.rb += val;
                            actionDesc = `å…©é‚ŠåŒæ™‚åŠ  ${val}`;
                            break;
                        case '-':
                            newEq.lb -= val;
                            newEq.rb -= val;
                            actionDesc = `å…©é‚ŠåŒæ™‚æ¸› ${val}`;
                            break;
                        case '*':
                            newEq.la *= val;
                            newEq.lb *= val;
                            newEq.ra *= val;
                            newEq.rb *= val;
                            actionDesc = `å…©é‚ŠåŒæ™‚ä¹˜ä»¥ ${val}`;
                            break;
                        case '/':
                            if (newEq.la % val !== 0 || newEq.lb % val !== 0 ||
                                newEq.ra % val !== 0 || newEq.rb % val !== 0) {
                                // ä¿®æ­£ 2: ä½¿ç”¨ triggerShake è§¸ç™¼æ–æ™ƒå‹•ç•«
                                triggerShake("é€™æ¨£é™¤èµ·ä¾†æœƒæœ‰é¤˜æ•¸æˆ–å°æ•¸ï¼Œè©¦è©¦çœ‹åˆ¥çš„æ–¹æ³•ï¼Ÿ");
                                return;
                            }
                            newEq.la /= val;
                            newEq.lb /= val;
                            newEq.ra /= val;
                            newEq.rb /= val;
                            actionDesc = `å…©é‚ŠåŒæ™‚é™¤ä»¥ ${val}`;
                            break;
                    }
                }

                // æˆåŠŸåŸ·è¡Œå¾Œï¼Œæ›´æ–° Undo Stack
                setUndoStack([...undoStack, currentEqState]);

                // æ›´æ–°æ­·å²ç´€éŒ„èˆ‡ç‹€æ…‹
                setHistory([...history, {
                    prev: formatEquationFull(equation),
                    action: actionDesc,
                    next: formatEquationFull(newEq)
                }]);
                setEquation(newEq);

                checkProgress(newEq, equation);
                setInputVal('');
            };

            const checkProgress = (curr, prev) => {
                const leftSolved = (curr.la === 1 && curr.lb === 0 && curr.ra === 0);
                const rightSolved = (curr.ra === 1 && curr.rb === 0 && curr.la === 0);

                if (leftSolved || rightSolved) {
                    setSolved(true);
                    setUserFeedback("ğŸ‰ å¤ªæ£’äº†ï¼ä½ æˆåŠŸè§£å‡ºäº† x çš„å€¼ï¼");
                    return;
                }

                // ç°¡å–®çš„åé¥‹é‚è¼¯
                if (level === 4 && curr.la !== 0 && curr.ra !== 0) {
                    if (Math.abs(curr.la) > Math.abs(prev.la) && Math.abs(curr.ra) > Math.abs(prev.ra)) {
                        setUserFeedback("ğŸ¤” x çš„ä¿‚æ•¸å¥½åƒè®Šå¤§äº†ï¼Œè©¦è‘—ã€Œæ¸›æ‰ã€æŸä¸€é‚Šçš„ xï¼Ÿ");
                        return;
                    }
                }

                setUserFeedback("âœ… è¨ˆç®—å®Œæˆï¼Œè«‹ç¹¼çºŒä¸‹ä¸€æ­¥ï¼");
            };

            const triggerShake = (msg) => {
                setUserFeedback(`âš ï¸ ${msg}`);
                setShake(true);
                setTimeout(() => setShake(false), 500);
            };

            const currentDisplay = formatEquationFull(equation);

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-20">
                    <div className="p-4 md:p-6">
                        {/* Header */}
                        <header className="max-w-5xl mx-auto mb-6 text-center">
                            <h1 className="text-2xl md:text-4xl font-black text-indigo-600 mb-2 flex items-center justify-center gap-2">
                                <Scale className="w-8 h-8 md:w-10 md:h-10" />
                                ç­‰é‡å…¬ç†å¯¦é©—å®¤ v3.3
                            </h1>
                        </header>

                        {/* Main Content Grid */}
                        <div className="max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">

                            {/* Left Panel: Game Controls & Visuals */}
                            <div className="lg:col-span-2 space-y-5">

                                <div className="bg-white p-3 md:p-4 rounded-2xl shadow-sm border border-slate-200 flex flex-wrap gap-2 justify-between items-center">
                                    <div className="flex flex-wrap gap-2">
                                        {[1, 2, 3, 4].map((lvl) => (
                                            <button
                                                key={lvl}
                                                onClick={() => setLevel(lvl)}
                                                className={`px-3 py-1.5 rounded-full text-xs md:text-sm font-bold transition-all ${level === lvl
                                                        ? 'bg-indigo-600 text-white shadow-md transform scale-105'
                                                        : 'bg-slate-100 text-slate-500 hover:bg-slate-200'
                                                    }`}
                                            >
                                                {lvl === 1 ? 'åŸºç¤(ä¸€æ­¥)' : lvl === 2 ? 'é€²éš(ä¿‚æ•¸)' : lvl === 3 ? 'æŒ‘æˆ°(æ··åˆ)' : 'å¤§å¸«(é›™é‚Š)'}
                                            </button>
                                        ))}
                                    </div>
                                    <button
                                        onClick={generateProblem}
                                        className="p-2 text-slate-400 hover:text-indigo-600 transition-colors bg-slate-50 rounded-full"
                                        title="é‡æ–°å‡ºé¡Œ"
                                    >
                                        <RotateCcw size={20} />
                                    </button>
                                </div>

                                <div className="bg-amber-50 border border-amber-200 p-4 rounded-2xl shadow-sm relative">
                                    <div className="flex items-start gap-3">
                                        <div className="bg-amber-100 p-2 rounded-lg text-amber-600 mt-1">
                                            <BookOpen size={20} />
                                        </div>
                                        <div>
                                            <h3 className="font-bold text-amber-800 mb-1">æ‡‰ç”¨é¡Œæƒ…å¢ƒ</h3>
                                            <p className="text-amber-900 text-sm md:text-base leading-relaxed mb-2">
                                                {problemText.story}
                                            </p>
                                            <details className="text-xs md:text-sm text-amber-700 cursor-pointer group">
                                                <summary className="font-bold hover:text-amber-600 select-none list-none flex items-center gap-1">
                                                    <span className="bg-amber-200/50 px-2 py-0.5 rounded text-amber-800">æŸ¥çœ‹åˆ—å¼è§£èªª</span>
                                                </summary>
                                                <div className="mt-2 p-3 bg-white/60 rounded-lg border border-amber-100 text-slate-700">
                                                    {problemText.explanation}
                                                </div>
                                            </details>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white p-6 md:p-8 rounded-3xl shadow-lg border-2 border-indigo-50 relative overflow-hidden">
                                    <div className={`transition-all duration-300 ${shake ? 'animate-shake' : ''}`}>
                                        <div className="flex justify-center items-center gap-2 md:gap-6 mb-4 overflow-x-auto pb-2">
                                            <div className="flex-1 flex justify-end min-w-0">
                                                <div className="equation-text bg-indigo-50 border-2 border-indigo-100 text-indigo-800 font-mono text-3xl md:text-5xl font-bold py-4 px-6 rounded-xl shadow-inner text-right">
                                                    {currentDisplay.left}
                                                </div>
                                            </div>
                                            <div className="flex-shrink-0 flex flex-col items-center">
                                                <div className="text-4xl md:text-6xl font-black text-slate-300 mx-2">=</div>
                                            </div>
                                            <div className="flex-1 flex justify-start min-w-0">
                                                <div className="equation-text bg-emerald-50 border-2 border-emerald-100 text-emerald-800 font-mono text-3xl md:text-5xl font-bold py-4 px-6 rounded-xl shadow-inner text-left">
                                                    {currentDisplay.right}
                                                </div>
                                            </div>
                                        </div>

                                        <div className="flex justify-center -mt-2 opacity-30">
                                            <div className="w-0 h-0 border-l-[20px] border-l-transparent border-r-[20px] border-r-transparent border-b-[20px] border-b-slate-400"></div>
                                        </div>
                                    </div>

                                    <div className="mt-4 flex items-center gap-2">
                                        <div className={`flex-1 p-3 rounded-lg text-center font-medium text-lg flex items-center justify-center gap-2 transition-colors duration-300 ${solved ? 'bg-yellow-100 text-yellow-800' : 'bg-slate-100 text-slate-600'
                                            }`}>
                                            {solved ? <Trophy className="text-yellow-600" /> : <HelpCircle size={20} />}
                                            <span className="text-sm md:text-base">{userFeedback}</span>
                                        </div>
                                        {!solved && (
                                            <button
                                                onClick={handleHint}
                                                className="bg-yellow-100 text-yellow-600 p-3 rounded-xl hover:bg-yellow-200 transition-colors shadow-sm"
                                                title="ä¸çŸ¥å¦‚ä½•ä¸‹æ‰‹ï¼Ÿé»æˆ‘çœ‹æç¤º"
                                            >
                                                <Lightbulb size={24} />
                                            </button>
                                        )}
                                    </div>
                                </div>

                                {!solved && (
                                    <div className="bg-white p-5 rounded-2xl shadow-md border border-slate-200 relative">
                                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-3">
                                            <h3 className="text-slate-500 font-bold flex items-center gap-2">
                                                <Calculator size={18} />
                                                æ“ä½œé¢æ¿
                                            </h3>

                                            <div className="flex items-center gap-2 self-end md:self-auto">
                                                <div className="flex bg-slate-100 p-1 rounded-lg">
                                                    <button
                                                        onClick={() => setIsVariableTerm(false)}
                                                        className={`px-3 py-1 text-sm font-bold rounded-md transition-all flex items-center gap-1 ${!isVariableTerm ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}
                                                    >
                                                        <span>#</span> æ•¸å­—
                                                    </button>
                                                    <button
                                                        onClick={() => setIsVariableTerm(true)}
                                                        className={`px-3 py-1 text-sm font-bold rounded-md transition-all flex items-center gap-1 ${isVariableTerm ? 'bg-indigo-600 text-white shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}
                                                    >
                                                        <span>x</span> è®Šæ•¸é …
                                                    </button>
                                                </div>

                                                {/* Undo Button - Moved here to prevent overlap */}
                                                <button
                                                    onClick={handleUndo}
                                                    disabled={undoStack.length === 0}
                                                    className={`p-2 rounded-lg transition-all flex items-center gap-1 text-xs font-bold border ${undoStack.length === 0
                                                            ? 'text-slate-300 border-slate-100 cursor-not-allowed'
                                                            : 'text-slate-500 border-slate-200 hover:bg-slate-100 hover:text-indigo-600 hover:border-indigo-200'
                                                        }`}
                                                >
                                                    <UndoIcon size={16} /> å¾©åŸ
                                                </button>
                                            </div>
                                        </div>

                                        <div className="flex flex-col md:flex-row gap-3 items-stretch md:items-center">
                                            <div className="flex gap-2 justify-center md:justify-start">
                                                {['+', '-', '*', '/'].map(op => (
                                                    <button
                                                        key={op}
                                                        onClick={() => setSelectedOp(op)}
                                                        className={`w-12 h-12 rounded-xl text-2xl font-bold flex items-center justify-center transition-all border-2 ${selectedOp === op
                                                                ? 'bg-indigo-600 text-white border-indigo-600 shadow-lg scale-110'
                                                                : 'bg-white text-slate-600 border-slate-200 hover:border-indigo-300 hover:bg-indigo-50'
                                                            }`}
                                                    >
                                                        {op === '*' ? 'Ã—' : op === '/' ? 'Ã·' : op}
                                                    </button>
                                                ))}
                                            </div>

                                            {/* Input Area - Adjusted width and layout */}
                                            <div className="relative flex items-center justify-center md:justify-start">
                                                <input
                                                    type="number"
                                                    value={inputVal}
                                                    onChange={(e) => setInputVal(e.target.value)}
                                                    placeholder={isVariableTerm ? "ä¿‚æ•¸" : "æ•¸å­—"}
                                                    className="w-32 h-12 px-4 rounded-xl border-2 border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none text-xl font-mono text-center"
                                                    onKeyDown={(e) => e.key === 'Enter' && handleOperation()}
                                                />
                                                {/* Distinct X display next to input */}
                                                {isVariableTerm && (
                                                    <div className="ml-2 text-4xl font-serif italic font-bold text-indigo-600 animate-pulse">x</div>
                                                )}
                                            </div>

                                            {/* Execute Button - Grows to fill space */}
                                            <button
                                                onClick={handleOperation}
                                                className="flex-1 h-12 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-md active:scale-95 transition-all flex items-center justify-center gap-2"
                                            >
                                                åŸ·è¡Œ <ArrowRight size={18} />
                                            </button>
                                        </div>
                                        {isVariableTerm && (
                                            <div className="text-xs text-indigo-500 mt-2 font-medium">
                                                ğŸ’¡ å°æé†’ï¼šåœ¨åœ‹å°éšæ®µï¼Œæˆ‘å€‘é€šå¸¸åªå°è®Šæ•¸é …(x)åšåŠ æ¸›æ³•å–”ï¼(è©¦è©¦çœ‹ä¹˜é™¤æœƒç™¼ç”Ÿä»€éº¼äº‹ï¼Ÿ)
                                            </div>
                                        )}
                                    </div>
                                )}

                                {solved && (
                                    <div className="flex justify-center">
                                        <button
                                            onClick={generateProblem}
                                            className="px-8 py-3 bg-gradient-to-r from-yellow-400 to-orange-500 text-white font-bold rounded-full shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all text-xl flex items-center gap-2 animate-bounce"
                                        >
                                            <RotateCcw /> ä¸‹ä¸€é¡ŒæŒ‘æˆ°
                                        </button>
                                    </div>
                                )}
                            </div>

                            {/* Right Panel: History Log */}
                            <div className="lg:col-span-1">
                                <div className="bg-slate-800 text-slate-200 p-6 rounded-2xl shadow-lg h-full max-h-[600px] overflow-y-auto custom-scrollbar">
                                    <h3 className="font-bold text-slate-400 mb-4 uppercase tracking-wider text-sm border-b border-slate-700 pb-2">
                                        è¨ˆç®—éç¨‹ç´€éŒ„
                                    </h3>

                                    {history.length === 0 ? (
                                        <div className="text-slate-500 text-center py-10 italic">
                                            é‚„æ²’æœ‰æ­¥é©Ÿ...<br />
                                            {level === 4 ? "è©¦è‘—å…ˆæŠŠ x ç§»åˆ°åŒä¸€é‚Šï¼" : "è©¦è‘—æ“ä½œçœ‹çœ‹ï¼"}
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            {history.map((step, idx) => (
                                                <div key={idx} className="bg-slate-700/50 p-3 rounded-lg border border-slate-600 text-sm">
                                                    <div className="flex justify-between text-slate-400 text-xs mb-1">
                                                        <span>æ­¥é©Ÿ {idx + 1}</span>
                                                        <span className="text-indigo-300 font-bold">{step.action}</span>
                                                    </div>
                                                    <div className="font-mono text-center opacity-50 mb-1 whitespace-nowrap overflow-x-auto">
                                                        {step.prev.left} = {step.prev.right}
                                                    </div>
                                                    <div className="flex justify-center text-slate-500 my-1">
                                                        â†“
                                                    </div>
                                                    <div className="font-mono text-center text-lg text-emerald-400 font-bold whitespace-nowrap overflow-x-auto">
                                                        {step.next.left} = {step.next.right}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}

                                    {solved && (
                                        <div className="mt-4 bg-emerald-900/50 border border-emerald-500/50 p-4 rounded-lg text-center animate-pulse">
                                            <div className="text-emerald-400 font-bold text-xl mb-1">
                                                x = {equation.ra === 0 ? equation.rb : equation.lb}
                                            </div>
                                            <div className="text-emerald-200 text-xs">å®Œç¾è§£ç­”</div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Footer: Usage & Axioms Card */}
                    <footer className="max-w-5xl mx-auto px-4 mt-8 pb-10">
                        <div className="bg-white rounded-3xl p-6 md:p-8 shadow-sm border border-slate-200">
                            <h2 className="text-2xl font-bold text-slate-700 mb-6 text-center">
                                ğŸ“š ç­‰é‡å…¬ç†æ•™å­¸æŒ‡å—
                            </h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                {[
                                    { title: "ç­‰é‡åŠ æ³•å…¬ç†", op: "+", desc: "ç­‰è™Ÿå…©é‚ŠåŒæ™‚åŠ ä¸ŠåŒä¸€å€‹æ•¸ï¼Œç­‰å¼ä¾ç„¶æˆç«‹ã€‚", ex: "è‹¥ a = bï¼Œå‰‡ a + c = b + c" },
                                    { title: "ç­‰é‡æ¸›æ³•å…¬ç†", op: "-", desc: "ç­‰è™Ÿå…©é‚ŠåŒæ™‚æ¸›å»åŒä¸€å€‹æ•¸ï¼Œç­‰å¼ä¾ç„¶æˆç«‹ã€‚", ex: "è‹¥ a = bï¼Œå‰‡ a - c = b - c" },
                                    { title: "ç­‰é‡ä¹˜æ³•å…¬ç†", op: "Ã—", desc: "ç­‰è™Ÿå…©é‚ŠåŒæ™‚ä¹˜ä»¥åŒä¸€å€‹æ•¸ï¼Œç­‰å¼ä¾ç„¶æˆç«‹ã€‚", ex: "è‹¥ a = bï¼Œå‰‡ a Ã— c = b Ã— c" },
                                    { title: "ç­‰é‡é™¤æ³•å…¬ç†", op: "Ã·", desc: "ç­‰è™Ÿå…©é‚ŠåŒæ™‚é™¤ä»¥åŒä¸€å€‹ä¸ç‚º 0 çš„æ•¸ï¼Œç­‰å¼æˆç«‹ã€‚", ex: "è‹¥ a = bï¼Œå‰‡ a Ã· c = b Ã· c" }
                                ].map((rule, idx) => (
                                    <div key={idx} className="bg-slate-50 p-5 rounded-xl border border-slate-100 hover:shadow-md transition-shadow">
                                        <div className="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-xl font-bold mb-3">
                                            {rule.op}
                                        </div>
                                        <h3 className="font-bold text-slate-800 mb-2">{rule.title}</h3>
                                        <p className="text-slate-500 text-sm mb-3 leading-relaxed">
                                            {rule.desc}
                                        </p>
                                        <div className="text-xs bg-white p-2 rounded border border-slate-200 font-mono text-slate-600">
                                            {rule.ex}
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="mt-8 pt-6 border-t border-slate-100">
                                <h3 className="font-bold text-slate-700 mb-3">ä½¿ç”¨èªªæ˜</h3>
                                <ul className="list-disc list-inside text-slate-600 space-y-2 text-sm md:text-base">
                                    <li><strong>ç›®æ¨™ï¼š</strong>è®“ x å–®ç¨ç•™åœ¨ç­‰è™Ÿçš„ä¸€é‚Š (ä¾‹å¦‚ x = 5)ã€‚</li>
                                    <li><strong>æ¨¡å¼åˆ‡æ›ï¼š</strong>
                                        <ul className="pl-6 mt-1 list-[square] text-slate-500">
                                            <li><span className="font-bold text-indigo-600"># æ•¸å­—æ¨¡å¼</span>ï¼šå°å…©é‚Šçš„ã€Œå¸¸æ•¸ã€åšé‹ç®— (ä¾‹å¦‚ï¼šå…©é‚ŠåŒæ™‚æ¸› 5)ã€‚</li>
                                            <li><span className="font-bold text-indigo-600">x è®Šæ•¸æ¨¡å¼</span>ï¼šå°å…©é‚Šçš„ã€ŒæœªçŸ¥æ•¸ã€åšé‹ç®— (ä¾‹å¦‚ï¼šå…©é‚ŠåŒæ™‚æ¸› 2x)ã€‚</li>
                                        </ul>
                                    </li>
                                    <li><strong>æç¤ºèˆ‡å¾©åŸï¼š</strong>åšéŒ¯äº†å¯ä»¥æŒ‰å³ä¸Šè§’çš„ <UndoIcon className="inline w-4 h-4" /> å¾©åŸï¼›å¡é—œæ™‚å¯ä»¥æŒ‰ <Lightbulb className="inline w-4 h-4 text-yellow-500" /> ç‡ˆæ³¡çœ‹æç¤ºã€‚</li>
                                </ul>
                            </div>
                        </div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EquationSolver />);
    </script>
</body>

</html>