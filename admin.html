<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理者後台 | 數學實驗室</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- 載入目前的資料 -->
    <script src="data.js"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f1f5f9;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import {
            LayoutDashboard, Plus, Save, Trash2, Edit, X, Download,
            FileCode, ExternalLink, RefreshCw
        } from 'https://esm.sh/lucide-react@0.263.1';

        function AdminApp() {
            const [tools, setTools] = useState([]);
            const [editingId, setEditingId] = useState(null);
            const [formData, setFormData] = useState({});
            const [showModal, setShowModal] = useState(false);

            // 初始化讀取 window.MATH_TOOLS_DATA
            useEffect(() => {
                if (window.MATH_TOOLS_DATA) {
                    setTools(window.MATH_TOOLS_DATA);
                }
            }, []);

            // 開啟新增/編輯視窗
            const handleEdit = (tool = null) => {
                if (tool) {
                    setEditingId(tool.id);
                    setFormData({ ...tool });
                } else {
                    setEditingId(null);
                    setFormData({
                        id: `tool_${Date.now()}`,
                        title: '',
                        grade: '五年級',
                        description: '',
                        link: '',
                        icon: 'BookOpen',
                        color: 'blue'
                    });
                }
                setShowModal(true);
            };

            // 儲存單一項目
            const handleSaveItem = (e) => {
                e.preventDefault();
                let newTools;
                if (editingId) {
                    newTools = tools.map(t => t.id === editingId ? formData : t);
                } else {
                    newTools = [...tools, formData];
                }
                setTools(newTools);
                setShowModal(false);
            };

            // 刪除項目
            const handleDelete = (id) => {
                if (confirm('確定要刪除這個教學項目嗎？')) {
                    setTools(tools.filter(t => t.id !== id));
                }
            };

            // 匯出設定檔 (核心功能)
            const handleExport = () => {
                const dataStr = `/**\n * 國小數學互動教學實驗室 - 系統設定檔\n * 此檔案由 admin.html 生成，請勿手動修改格式。\n */\nwindow.MATH_TOOLS_DATA = ${JSON.stringify(tools, null, 2)};`;

                const blob = new Blob([dataStr], { type: 'text/javascript' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'data.js';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                alert('設定檔已下載！\n請將下載的 "data.js" 覆蓋掉網站資料夾中的舊檔案即可完成更新。');
            };

            return (
                <div className="min-h-screen flex flex-col">
                    {/* Admin Header */}
                    <header className="bg-slate-800 text-white shadow-md sticky top-0 z-50">
                        <div className="max-w-6xl mx-auto px-6 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <LayoutDashboard className="text-emerald-400" />
                                <h1 className="text-xl font-bold">數學實驗室 - 管理後台</h1>
                            </div>
                            <div className="flex gap-4">
                                <a href="index.html" target="_blank" className="flex items-center gap-2 text-sm text-slate-300 hover:text-white transition-colors">
                                    <ExternalLink size={16} /> 預覽學生首頁
                                </a>
                                <button
                                    onClick={handleExport}
                                    className="flex items-center gap-2 bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-1.5 rounded-lg font-bold text-sm transition-colors shadow-lg shadow-emerald-500/20"
                                >
                                    <Download size={16} /> 下載設定檔 (更新網站)
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="flex-grow p-6 max-w-5xl mx-auto w-full">

                        <div className="flex justify-between items-end mb-6">
                            <div>
                                <h2 className="text-2xl font-bold text-slate-800">教材項目管理</h2>
                                <p className="text-slate-500 text-sm mt-1">目前共有 {tools.length} 個互動教材</p>
                            </div>
                            <button
                                onClick={() => handleEdit(null)}
                                className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl font-bold shadow-md transition-all active:scale-95"
                            >
                                <Plus size={20} /> 新增教材
                            </button>
                        </div>

                        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                            <table className="w-full text-left border-collapse">
                                <thead className="bg-slate-50 border-b border-slate-200">
                                    <tr>
                                        <th className="px-6 py-4 font-bold text-slate-600 text-sm">圖示</th>
                                        <th className="px-6 py-4 font-bold text-slate-600 text-sm">標題 / 描述</th>
                                        <th className="px-6 py-4 font-bold text-slate-600 text-sm">檔案連結</th>
                                        <th className="px-6 py-4 font-bold text-slate-600 text-sm">操作</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {tools.map(tool => (
                                        <tr key={tool.id} className="hover:bg-slate-50 transition-colors">
                                            <td className="px-6 py-4">
                                                <div className={`w-10 h-10 rounded-lg flex items-center justify-center text-white bg-${tool.color}-500 bg-gray-400`}>
                                                    {/* 簡單顯示第一個字當 icon 示意 */}
                                                    <span className="font-mono text-xs">{tool.icon.substring(0, 2)}</span>
                                                </div>
                                            </td>
                                            <td className="px-6 py-4">
                                                <div className="font-bold text-slate-800">{tool.title}</div>
                                                <div className="text-xs text-slate-500 mt-1 line-clamp-1">{tool.description}</div>
                                                <span className="inline-block mt-1 px-2 py-0.5 bg-slate-100 text-slate-600 text-[10px] rounded font-bold">
                                                    {tool.grade}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4">
                                                <div className="flex items-center gap-2 text-sm text-slate-600 font-mono bg-slate-100 px-2 py-1 rounded max-w-[200px] truncate">
                                                    <FileCode size={14} /> {tool.link}
                                                </div>
                                            </td>
                                            <td className="px-6 py-4">
                                                <div className="flex gap-2">
                                                    <button onClick={() => handleEdit(tool)} className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
                                                        <Edit size={18} />
                                                    </button>
                                                    <button onClick={() => handleDelete(tool.id)} className="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                                                        <Trash2 size={18} />
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            {tools.length === 0 && (
                                <div className="p-10 text-center text-slate-400">
                                    目前沒有任何教材，請點擊右上角新增。
                                </div>
                            )}
                        </div>
                    </main>

                    {/* Modal Form */}
                    {showModal && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-in">
                                <div className="bg-slate-50 px-6 py-4 border-b border-slate-200 flex justify-between items-center">
                                    <h3 className="font-bold text-lg text-slate-800">
                                        {editingId ? '編輯教材' : '新增教材'}
                                    </h3>
                                    <button onClick={() => setShowModal(false)} className="text-slate-400 hover:text-slate-600">
                                        <X size={20} />
                                    </button>
                                </div>
                                <form onSubmit={handleSaveItem} className="p-6 space-y-4">
                                    <div>
                                        <label className="block text-sm font-bold text-slate-700 mb-1">標題</label>
                                        <input
                                            required
                                            type="text"
                                            value={formData.title}
                                            onChange={e => setFormData({ ...formData, title: e.target.value })}
                                            className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                            placeholder="例如：三角形面積計算"
                                        />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-bold text-slate-700 mb-1">適用年級</label>
                                            <select
                                                value={formData.grade}
                                                onChange={e => setFormData({ ...formData, grade: e.target.value })}
                                                className="w-full px-4 py-2 border border-slate-300 rounded-lg outline-none"
                                            >
                                                <option>一年級</option><option>二年級</option><option>三年級</option>
                                                <option>四年級</option><option>五年級</option><option>六年級</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-slate-700 mb-1">主題顏色</label>
                                            <select
                                                value={formData.color}
                                                onChange={e => setFormData({ ...formData, color: e.target.value })}
                                                className="w-full px-4 py-2 border border-slate-300 rounded-lg outline-none"
                                            >
                                                <option value="blue">藍色 (幾何)</option>
                                                <option value="sky">天藍 (測量)</option>
                                                <option value="indigo">靛青 (運算)</option>
                                                <option value="green">綠色 (代數)</option>
                                                <option value="orange">橘色 (統計)</option>
                                                <option value="rose">玫瑰 (其他)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-slate-700 mb-1">檔案連結 (HTML檔名)</label>
                                        <input
                                            required
                                            type="text"
                                            value={formData.link}
                                            onChange={e => setFormData({ ...formData, link: e.target.value })}
                                            className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-mono text-sm"
                                            placeholder="例如：new_game.html"
                                        />
                                        <p className="text-xs text-slate-500 mt-1">請輸入您上傳的 HTML 檔案名稱，或外部網址。</p>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-slate-700 mb-1">圖示名稱 (Lucide Icon)</label>
                                        <input
                                            type="text"
                                            value={formData.icon}
                                            onChange={e => setFormData({ ...formData, icon: e.target.value })}
                                            className="w-full px-4 py-2 border border-slate-300 rounded-lg outline-none font-mono text-sm"
                                            placeholder="例如：Calculator, Shapes, Ruler..."
                                        />
                                        <a href="https://lucide.dev/icons" target="_blank" className="text-xs text-blue-500 hover:underline mt-1 inline-block">查詢圖示名稱</a>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-slate-700 mb-1">簡短描述</label>
                                        <textarea
                                            value={formData.description}
                                            onChange={e => setFormData({ ...formData, description: e.target.value })}
                                            className="w-full px-4 py-2 border border-slate-300 rounded-lg outline-none h-24 resize-none"
                                            placeholder="這個單元的主要學習目標是..."
                                        />
                                    </div>
                                    <div className="pt-4 flex gap-3">
                                        <button type="button" onClick={() => setShowModal(false)} className="flex-1 py-2.5 bg-slate-100 text-slate-600 font-bold rounded-xl hover:bg-slate-200">取消</button>
                                        <button type="submit" className="flex-1 py-2.5 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 shadow-md">確認儲存</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<AdminApp />);
    </script>
</body>

</html>