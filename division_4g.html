<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™¤æ³•æ¢éšªå®¶(å››å¹´ç´š) - é¤˜æ•¸çš„å‘½é‹æ±ºå®š | åœ‹å°æ•¸å­¸äº’å‹•æ•™å­¸å¯¦é©—å®¤</title>

    <!-- è¼‰å…¥ React, ReactDOM, Babel, Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* æ“´å……è‡ªè¨‚å‹•ç•« */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .animate-slide-in {
            animation: slideInRight 0.4s ease-out forwards;
        }

        @keyframes bounce-subtle {

            0%,
            100% {
                transform: translateY(-5%);
            }

            50% {
                transform: translateY(0);
            }
        }

        .animate-bounce-subtle {
            animation: bounce-subtle 2s infinite;
        }

        @keyframes pulse-subtle {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.8;
                transform: scale(1.02);
            }
        }

        .animate-pulse {
            animation: pulse-subtle 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* éš±è—åŸç”Ÿæ²è»¸ */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        body {
            background-color: #f1f5f9;
            overflow: hidden;
        }

        /* ç»ç’ƒæ“¬æ…‹èƒŒæ™¯ */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
    </style>
</head>

<body class="text-slate-800 font-sans antialiased h-screen w-screen">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // ==========================================
        // å…±ç”¨ UX å·¥å…·ï¼šæ–¹å‘éµèˆ‡ Enter éµçš„ç„¡ç¸«æ¬„ä½åˆ‡æ›
        // ==========================================
        const handleKeyNavigation = (e) => {
            const isSelect = e.target.tagName.toLowerCase() === 'select';
            const isButton = e.target.tagName.toLowerCase() === 'button';

            // 1. è‹¥ç‚ºä¸‹æ‹‰é¸å–®ï¼Œä¿ç•™ä¸Šä¸‹å·¦å³éµçš„åŸç”Ÿé¸é …åˆ‡æ›åŠŸèƒ½ï¼Œåƒ…ç”¨ Enter è·³è‡³ä¸‹ä¸€æ ¼
            if (isSelect && ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                return;
            }

            // 2. è‹¥ç‚ºæŒ‰éˆ•ï¼Œä¿ç•™ Enter èˆ‡ç©ºç™½éµçš„åŸç”Ÿé»æ“Šè§¸ç™¼åŠŸèƒ½
            if (isButton && (e.key === 'Enter' || e.key === ' ')) {
                return;
            }

            let direction = 0;
            if (e.key === 'Enter' || e.key === 'ArrowDown' || e.key === 'ArrowRight') {
                direction = 1;
            } else if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') {
                direction = -1;
            }

            if (direction !== 0) {
                e.preventDefault(); // é˜»æ­¢åŸç”Ÿçš„æ•¸å€¼å¢æ¸›æˆ–æ¸¸æ¨™ä½ç§»

                const container = e.target.closest('.focus-container') || document.body;
                const focusableStr = 'input:not([disabled]), select:not([disabled]), button:not([disabled])';
                const elements = Array.from(container.querySelectorAll(focusableStr));
                const index = elements.indexOf(e.target);

                if (direction === 1 && index > -1 && index < elements.length - 1) {
                    elements[index + 1].focus();
                } else if (direction === -1 && index > 0) {
                    elements[index - 1].focus();
                }
            }
        };

        // ==========================================
        // 1. è³‡æ–™åº«èˆ‡è¨­å®š (Data & Configuration for 4th Grade)
        // ==========================================
        const MISSIONS = [
            {
                id: 1, type: 'partitive', fate: 'roundUp', title: 'ä»»å‹™ä¸€ï¼šæ ¡å¤–æ•™å­¸æ­è»Š (é€²ä¸€æ³•)',
                story: [
                    { text: 'å­¸æ ¡èˆ‰è¾¦æ ¡å¤–æ•™å­¸ï¼Œå…±æœ‰ ', isNoise: false }, { text: '250 ä½å­¸ç”Ÿ', isNoise: false, isKey: true }, { text: 'åƒåŠ ã€‚', isNoise: false },
                    { text: 'ä»Šå¤©å¤©æ°£å¾ˆå¥½ï¼Œå¤§å®¶éƒ½å¸¶äº†é›¶é£Ÿã€‚', isNoise: true },
                    { text: 'å¦‚æœ', isNoise: false }, { text: 'æ¯ 8 äººæ­ä¹˜ä¸€è¼›å°å·´å£«', isNoise: false, highlight: true }, { text: 'ï¼Œ', isNoise: false },
                    { text: 'è«‹å•', isNoise: false }, { text: 'è‡³å°‘è¦å«å¹¾è¼›å°å·´å£«', isNoise: false, highlight: true }, { text: 'æ‰å¤ ï¼Ÿ', isNoise: false },
                ],
                total: 250, divisor: 8, quotient: 31, remainder: 2, finalAns: 32,
                itemEmoji: 'ğŸ‘¨â€ğŸ“', containerEmoji: 'ğŸšŒ', itemUnit: 'äºº', containerUnit: 'è¼›',
                fateQuestion: 'ç®—å‡ºä¾†å‰©ä¸‹ 2 å€‹äººï¼Œé€™ 2 å€‹äººå¯ä»¥ä¸Ÿåœ¨è·¯é‚Šä¸æ­è»Šå—ï¼Ÿ',
                fateAction: 'ä¸è¡Œï¼Œä»–å€‘ä¹Ÿè¦æ­è»Šï¼æ‰€ä»¥å¿…é ˆå¤šå« 1 è¼›è»Šã€‚',
                calcHint: '31 + 1 = 32'
            },
            {
                id: 2, type: 'quotitive', fate: 'truncate', title: 'ä»»å‹™äºŒï¼šåŒ…è£ç²¾ç¾ç¦®ç‰© (æ¨å»æ³•)',
                story: [
                    { text: 'æ–‡å…·åº—æœ‰ä¸€æ²é•· ', isNoise: false }, { text: '100 å…¬åˆ†çš„çµ²å¸¶', isNoise: false, isKey: true }, { text: 'ã€‚', isNoise: false },
                    { text: 'é€™æ²çµ²å¸¶æ˜¯ç´…è‰²çš„ï¼Œå”®åƒ¹ 50 å…ƒã€‚', isNoise: true },
                    { text: 'åº—å“¡æƒ³è¦åŒ…è£ç¦®ç‰©ï¼Œ', isNoise: false }, { text: 'æ¯ 30 å…¬åˆ†å¯ä»¥åšæˆä¸€å€‹è´è¶çµ', isNoise: false, highlight: true }, { text: 'ã€‚', isNoise: false },
                    { text: 'è«‹å•é€™æ²çµ²å¸¶', isNoise: false }, { text: 'æœ€å¤šå¯ä»¥åšæˆå¹¾å€‹', isNoise: false, highlight: true }, { text: 'å®Œæ•´çš„è´è¶çµï¼Ÿ', isNoise: false },
                ],
                total: 100, divisor: 30, quotient: 3, remainder: 10, finalAns: 3,
                itemEmoji: 'ğŸ€', containerEmoji: 'ğŸ', itemUnit: 'å…¬åˆ†', containerUnit: 'å€‹',
                fateQuestion: 'ç®—å‡ºä¾†å‰©ä¸‹ 10 å…¬åˆ†çš„çµ²å¸¶ï¼Œé€™ 10 å…¬åˆ†å¤ ä¸å¤ å†åšä¸€å€‹å®Œæ•´çš„è´è¶çµï¼Ÿ',
                fateAction: 'ä¸å¤ ï¼æ‰€ä»¥å‰©ä¸‹çš„çµ²å¸¶åªèƒ½æ¨æ£„ä¸ç”¨ã€‚',
                calcHint: 'ç¶­æŒ 3 å€‹'
            },
            {
                id: 3, type: 'partitive', fate: 'roundUp', title: 'ä»»å‹™ä¸‰ï¼šéœ²ç‡Ÿåˆ†é…å¸³ç¯· (é€²ä¸€æ³•)',
                story: [
                    { text: 'ç«¥è»åœ˜æœ‰ ', isNoise: false }, { text: '135 ä½éšŠå“¡', isNoise: false, isKey: true }, { text: 'è¦å»éœ²ç‡Ÿã€‚', isNoise: false },
                    { text: 'æ¯å€‹éšŠå“¡éƒ½å¸¶äº†ç¡è¢‹å’Œæ‰‹é›»ç­’ã€‚', isNoise: true },
                    { text: 'è¦å®š', isNoise: false }, { text: 'æ¯ 6 äººç¡ä¸€é ‚å¸³ç¯·', isNoise: false, highlight: true }, { text: 'ï¼Œ', isNoise: false },
                    { text: 'ç‚ºäº†è®“å¤§å®¶éƒ½', isNoise: false }, { text: 'æœ‰åœ°æ–¹ç¡', isNoise: false, highlight: true }, { text: 'ï¼Œè«‹å•è¦æº–å‚™å¹¾é ‚å¸³ç¯·ï¼Ÿ', isNoise: false },
                ],
                total: 135, divisor: 6, quotient: 22, remainder: 3, finalAns: 23,
                itemEmoji: 'ğŸ•ï¸', containerEmoji: 'â›º', itemUnit: 'äºº', containerUnit: 'é ‚',
                fateQuestion: 'å‰©ä¸‹çš„ 3 å€‹äººæ²’æœ‰å¸³ç¯·ç¡æ€éº¼è¾¦ï¼Ÿ',
                fateAction: 'å¿…é ˆå†å¤šæ­ 1 é ‚å¸³ç¯·çµ¦ä»–å€‘ï¼',
                calcHint: '22 + 1 = 23'
            },
            {
                id: 4, type: 'quotitive', fate: 'truncate', title: 'ä»»å‹™å››ï¼šè³¼è²·é™é‡åœ–æ›¸ (æ¨å»æ³•)',
                story: [
                    { text: 'åœ–æ›¸é¤¨ç²å¾—äº† ', isNoise: false }, { text: '500 å…ƒçš„è£œåŠ©é‡‘', isNoise: false, isKey: true }, { text: 'ã€‚', isNoise: false },
                    { text: 'é¤¨é•·ä»Šå¹´ 50 æ­²ï¼Œéå¸¸å–œæ­¡çœ‹æ›¸ã€‚', isNoise: true },
                    { text: 'ä»–æƒ³è³¼è²·ä¸€å¥—ç§‘å­¸ç™¾ç§‘ï¼Œ', isNoise: false }, { text: 'æ¯ä¸€æœ¬è¦ 120 å…ƒ', isNoise: false, highlight: true }, { text: 'ã€‚', isNoise: false },
                    { text: 'è«‹å•é€™ç­†éŒ¢', isNoise: false }, { text: 'æœ€å¤šå¯ä»¥è²·å¹¾æœ¬', isNoise: false, highlight: true }, { text: 'ç™¾ç§‘å…¨æ›¸ï¼Ÿ', isNoise: false },
                ],
                total: 500, divisor: 120, quotient: 4, remainder: 20, finalAns: 4,
                itemEmoji: 'ğŸª™', containerEmoji: 'ğŸ“š', itemUnit: 'å…ƒ', containerUnit: 'æœ¬',
                fateQuestion: 'è²·äº† 4 æœ¬å¾Œå‰©ä¸‹ 20 å…ƒï¼Œé€™ 20 å…ƒå¤ ä¸å¤ å†è²·ä¸€æœ¬ 120 å…ƒçš„æ›¸ï¼Ÿ',
                fateAction: 'éŒ¢ä¸å¤ äº†ï¼åªèƒ½è²· 4 æœ¬ï¼Œå‰©ä¸‹çš„éŒ¢æ”¶èµ·ä¾†ã€‚',
                calcHint: 'ç¶­æŒ 4 æœ¬'
            },
            {
                id: 5, type: 'quotitive', fate: 'truncate', title: 'ä»»å‹™äº”ï¼šè¶…ç´šæ¡è³¼ (æ¨å»æ³•)',
                story: [
                    { text: 'å­¸æ ¡æ’¥äº† ', isNoise: false }, { text: '1500 å…ƒçš„ç¶“è²»', isNoise: false, isKey: true }, { text: 'ã€‚', isNoise: false },
                    { text: 'é€™ç­†ç¶“è²»æ˜¯å®¶é•·æœƒç‰¹åˆ¥è´ŠåŠ©çš„ã€‚', isNoise: true },
                    { text: 'é«”è‚²è€å¸«è¦è²·èº²é¿çƒï¼Œ', isNoise: false }, { text: 'æ¯é¡†èº²é¿çƒ 180 å…ƒ', isNoise: false, highlight: true }, { text: 'ã€‚', isNoise: false },
                    { text: 'è«‹å•é€™äº›éŒ¢', isNoise: false }, { text: 'æœ€å¤šå¯ä»¥è²·å¹¾é¡†', isNoise: false, highlight: true }, { text: 'èº²é¿çƒï¼Ÿ', isNoise: false },
                ],
                total: 1500, divisor: 180, quotient: 8, remainder: 60, finalAns: 8,
                itemEmoji: 'ğŸ’°', containerEmoji: 'ğŸ', itemUnit: 'å…ƒ', containerUnit: 'é¡†',
                fateQuestion: 'è²·äº† 8 é¡†å¾Œå‰©ä¸‹ 60 å…ƒï¼Œé€™ 60 å…ƒå¤ ä¸å¤ å†è²·ä¸€é¡† 180 å…ƒçš„èº²é¿çƒï¼Ÿ',
                fateAction: 'ä¸å¤ ï¼æ‰€ä»¥å‰©ä¸‹çš„éŒ¢åªèƒ½å­˜èµ·ä¾†ï¼Œä¸èƒ½å†è²·ã€‚',
                calcHint: 'ç¶­æŒ 8 é¡†'
            },
            {
                id: 6, type: 'partitive', fate: 'roundUp', title: 'ä»»å‹™å…­ï¼šè˜‹æœå¤§å‡ºè²¨ (é€²ä¸€æ³•)',
                story: [
                    { text: 'æœåœ’ä»Šå¹´å¤§è±æ”¶ï¼Œç¸½å…±æ¡æ”¶äº† ', isNoise: false }, { text: '845 é¡†è˜‹æœ', isNoise: false, isKey: true }, { text: 'ã€‚', isNoise: false },
                    { text: 'æœåœ’è£¡é‚„æœ‰ç¨®æ¤æ©˜å­å’Œæ°´èœœæ¡ƒã€‚', isNoise: true },
                    { text: 'è¾²å¤«è¦æŠŠå®ƒå€‘è£ç®±ï¼Œ', isNoise: false }, { text: 'æ¯ 36 é¡†è£æˆä¸€ç®±', isNoise: false, highlight: true }, { text: 'ã€‚', isNoise: false },
                    { text: 'ç‚ºäº†æŠŠè˜‹æœ', isNoise: false }, { text: 'å…¨éƒ¨éƒ½é‹é€å‡ºå»', isNoise: false, highlight: true }, { text: 'ï¼Œè‡³å°‘éœ€è¦æº–å‚™å¹¾å€‹ç´™ç®±ï¼Ÿ', isNoise: false },
                ],
                total: 845, divisor: 36, quotient: 23, remainder: 17, finalAns: 24,
                itemEmoji: 'ğŸ', containerEmoji: 'ğŸ“¦', itemUnit: 'é¡†', containerUnit: 'å€‹',
                fateQuestion: 'è£æ»¿ 23 ç®±å¾Œï¼Œé‚„å‰©ä¸‹ 17 é¡†è˜‹æœï¼Œé€™ 17 é¡†è˜‹æœå¯ä»¥ä¸è³£å—ï¼Ÿ',
                fateAction: 'ä¸è¡Œï¼Œå…¨éƒ¨éƒ½è¦å‡ºè²¨ï¼æ‰€ä»¥é€™ 17 é¡†ä¹Ÿéœ€è¦ç”¨ 1 å€‹ç´™ç®±è£èµ·ä¾†ã€‚',
                calcHint: '23 + 1 = 24'
            },
            {
                id: 7, type: 'quotitive', fate: 'truncate', title: 'ä»»å‹™ä¸ƒï¼šåˆ†è£é®®å¥¶ (æ¨å»æ³•)',
                story: [
                    { text: 'ç‰§å ´ä»Šå¤©ç”Ÿç”¢äº† ', isNoise: false }, { text: '2500 æ¯«å‡çš„é®®å¥¶', isNoise: false, isKey: true }, { text: 'ã€‚', isNoise: false },
                    { text: 'ç‰§å ´è£¡é¤Šäº† 50 é ­å¥åº·çš„ä¹³ç‰›ã€‚', isNoise: true },
                    { text: 'å·¥äººè¦å°‡é®®å¥¶åˆ†è£åˆ°ç“¶å­è£¡ï¼Œ', isNoise: false }, { text: 'æ¯å€‹ç“¶å­å¯ä»¥è£ 350 æ¯«å‡', isNoise: false, highlight: true }, { text: 'ã€‚', isNoise: false },
                    { text: 'è«‹å•é€™äº›é®®å¥¶', isNoise: false }, { text: 'æœ€å¤šå¯ä»¥è£æ»¿å¹¾ç“¶', isNoise: false, highlight: true }, { text: 'ï¼Ÿ', isNoise: false },
                ],
                total: 2500, divisor: 350, quotient: 7, remainder: 50, finalAns: 7,
                itemEmoji: 'ğŸ¥›', containerEmoji: 'ğŸ¼', itemUnit: 'æ¯«å‡', containerUnit: 'ç“¶',
                fateQuestion: 'è£æ»¿ 7 ç“¶å¾Œï¼Œå‰©ä¸‹ 50 æ¯«å‡çš„é®®å¥¶ï¼Œé€™ 50 æ¯«å‡èƒ½ç®—ä½œã€Œè£æ»¿ã€çš„ä¸€ç“¶å—ï¼Ÿ',
                fateAction: 'ä¸èƒ½ï¼å› ç‚ºé¡Œç›®å•çš„æ˜¯ã€Œè£æ»¿ã€ï¼Œæ‰€ä»¥å‰©ä¸‹çš„é®®å¥¶ä¸èƒ½ç®—ä½œä¸€ç“¶ã€‚',
                calcHint: 'ç¶­æŒ 7 ç“¶'
            },
            {
                id: 8, type: 'partitive', fate: 'roundUp', title: 'ä»»å‹™å…«ï¼šå¤§å‹æ™šå®´æ¡Œæ•¸ (é€²ä¸€æ³•)',
                story: [
                    { text: 'ç¤¾å€èˆ‰è¾¦æ­²æœ«å¤§å‹æ™šå®´ï¼Œå…±æœ‰ ', isNoise: false }, { text: '450 ä½è³“å®¢', isNoise: false, isKey: true }, { text: 'å ±åã€‚', isNoise: false },
                    { text: 'æ™šå®´çš„èœè‰²éå¸¸è±å¯Œï¼Œå…±æœ‰ 10 é“ä½³é¤šã€‚', isNoise: true },
                    { text: 'é¤å»³çš„åœ“æ¡Œ', isNoise: false }, { text: 'æ¯æ¡Œå¯ä»¥å 12 äºº', isNoise: false, highlight: true }, { text: 'ã€‚', isNoise: false },
                    { text: 'ç‚ºäº†è®“æ‰€æœ‰è³“å®¢éƒ½', isNoise: false }, { text: 'æœ‰ä½å­å', isNoise: false, highlight: true }, { text: 'ï¼Œä¸»è¾¦å–®ä½è‡³å°‘è¦è¨‚å¹¾æ¡Œï¼Ÿ', isNoise: false },
                ],
                total: 450, divisor: 12, quotient: 37, remainder: 6, finalAns: 38,
                itemEmoji: 'ğŸ§‘â€ğŸ¤â€ğŸ§‘', containerEmoji: 'ğŸ½ï¸', itemUnit: 'äºº', containerUnit: 'æ¡Œ',
                fateQuestion: 'å®‰æ’äº† 37 æ¡Œå¾Œï¼Œé‚„å‰©ä¸‹ 6 ä½è³“å®¢ï¼Œé€™ 6 ä½è³“å®¢å¯ä»¥ç«™è‘—åƒé£¯å—ï¼Ÿ',
                fateAction: 'ä¸è¡Œï¼Œå¤§å®¶éƒ½è¦æœ‰ä½å­åï¼æ‰€ä»¥å¿…é ˆç‚ºä»–å€‘å¤šè¨‚ 1 æ¡Œã€‚',
                calcHint: '37 + 1 = 38'
            }
        ];

        // éš¨æ©Ÿé¡Œåº«ç”Ÿæˆè³‡æ–™ (æ¡ç”¨å°ˆå±¬å‡½æ•¸ç”Ÿæˆæµæš¢ä¸”ç¬¦åˆèªæ„çš„å¥å­)
        const PCG_DATA = {
            roundUp: [
                {
                    subject: 'ç‰©æµå¸æ©Ÿ', itemNoun: 'è²¨ç‰©', totalMin: 150, totalMax: 600, divMin: 15, divMax: 40,
                    unitItem: 'ç®±', unitContainer: 'è¶Ÿ', containerName: 'å¡è»Š',
                    getStep1: (t) => [`ç‰©æµå…¬å¸æœ‰ ${t} ç®±è²¨ç‰©éœ€è¦é‹é€ã€‚`],
                    getStep2: (p1, p2) => [`ç‰©æµå…¬å¸åŸæœ¬æœ‰ ${p1} ç®±è²¨ç‰©ï¼Œ`, `å¾Œä¾†åˆæ¥åˆ° ${p2} ç®±çš„è¨‚å–®ã€‚`],
                    getStep3: (p1, p2, p3) => [`ç‰©æµå…¬å¸æ—©ä¸Šæ”¶åˆ° ${p1} ç®±è²¨ç‰©ï¼Œ`, `ä¸‹åˆæ”¶åˆ° ${p2} ç®±ï¼Œ`, `æ™šä¸Šåˆè¿½åŠ äº† ${p3} ç®±ã€‚`],
                    getRule: (d) => `å¦‚æœä¸€è¶Ÿå¡è»Šæœ€å¤šåªèƒ½è¼‰ ${d} ç®±è²¨ç‰©ã€‚`,
                    kw: 'è‡³å°‘è¦è¼‰å¹¾è¶Ÿæ‰è¼‰å¾—å®Œ'
                },
                {
                    subject: 'è€å¸«', itemNoun: 'å­¸ç”Ÿ', totalMin: 80, totalMax: 300, divMin: 6, divMax: 15,
                    unitItem: 'å', unitContainer: 'çµ„', containerName: 'çµ„åˆ¥',
                    getStep1: (t) => [`å­¸æ ¡æœ‰ ${t} åå­¸ç”Ÿè¦é€²è¡Œæˆ¶å¤–é—–é—œã€‚`],
                    getStep2: (p1, p2) => [`å››å¹´ç´šåŸæœ¬æœ‰ ${p1} åå­¸ç”ŸåƒåŠ ï¼Œ`, `å¾Œä¾†ä¸‰å¹´ç´šåˆåŠ å…¥äº† ${p2} åå­¸ç”Ÿã€‚`],
                    getStep3: (p1, p2, p3) => [`ç”²ç­æœ‰ ${p1} åå­¸ç”Ÿï¼Œ`, `ä¹™ç­æœ‰ ${p2} åå­¸ç”Ÿï¼Œ`, `ä¸™ç­æœ‰ ${p3} åå­¸ç”Ÿè¦ä¸€èµ·åƒèˆ‡æ´»å‹•ã€‚`],
                    getRule: (d) => `è¦å®šæ¯ ${d} åå­¸ç”Ÿå¿…é ˆåˆ†æˆä¸€çµ„ã€‚`,
                    kw: 'è‡³å°‘è¦åˆ†å¹¾çµ„æ‰èƒ½è®“æ¯å€‹äººéƒ½æœ‰çµ„åˆ¥'
                },
                {
                    subject: 'æœè¾²', itemNoun: 'è˜‹æœ', totalMin: 300, totalMax: 900, divMin: 25, divMax: 50,
                    unitItem: 'é¡†', unitContainer: 'å€‹', containerName: 'ç´™ç®±',
                    getStep1: (t) => [`æœåœ’æ¡æ”¶äº† ${t} é¡†è˜‹æœéœ€è¦è£ç®±ã€‚`],
                    getStep2: (p1, p2) => [`æœè¾²ä¸Šåˆæ¡äº† ${p1} é¡†è˜‹æœï¼Œ`, `ä¸‹åˆåˆæ¡äº† ${p2} é¡†ã€‚`],
                    getStep3: (p1, p2, p3) => [`ç¬¬ä¸€å€æ¡äº† ${p1} é¡†è˜‹æœï¼Œ`, `ç¬¬äºŒå€æ¡äº† ${p2} é¡†ï¼Œ`, `ç¬¬ä¸‰å€æ¡äº† ${p3} é¡†ã€‚`],
                    getRule: (d) => `æ¯å€‹ç´™ç®±æœ€å¤šå¯ä»¥è£ ${d} é¡†è˜‹æœã€‚`,
                    kw: 'å…¨éƒ¨è£å®Œè‡³å°‘éœ€è¦æº–å‚™å¹¾å€‹ç´™ç®±'
                }
            ],
            truncate: [
                {
                    subject: 'ç³•é»å¸«å‚…', itemNoun: 'éºµç²‰', totalMin: 500, totalMax: 2000, divMin: 60, divMax: 200,
                    unitItem: 'å…‹', unitContainer: 'å€‹', containerName: 'è›‹ç³•',
                    getStep1: (t) => [`ç³•é»å¸«å‚…æº–å‚™äº† ${t} å…‹éºµç²‰è¦çƒ¤è›‹ç³•ã€‚`],
                    getStep2: (p1, p2) => [`å»šæˆ¿è£¡åŸæœ¬æœ‰ ${p1} å…‹éºµç²‰ï¼Œ`, `å¾Œä¾†åˆè²·äº† ${p2} å…‹ã€‚`],
                    getStep3: (p1, p2, p3) => [`å¸«å‚…å…ˆæ‹¿å‡ºäº† ${p1} å…‹éºµç²‰ï¼Œ`, `åŠ©æ‰‹åˆæ‰¾å‡ºäº† ${p2} å…‹ï¼Œ`, `æœ€å¾Œåˆæ‹†äº†ä¸€åŒ… ${p3} å…‹çš„éºµç²‰ã€‚`],
                    getRule: (d) => `çƒ¤ä¸€å€‹å®Œæ•´çš„è›‹ç³•éœ€è¦ç”¨æ‰ ${d} å…‹éºµç²‰ã€‚`,
                    kw: 'æœ€å¤šå¯ä»¥çƒ¤å‡ºå¹¾å€‹å®Œæ•´çš„è›‹ç³•'
                },
                {
                    subject: 'è£ç¸«å¸«', itemNoun: 'å¸ƒæ–™', totalMin: 200, totalMax: 800, divMin: 45, divMax: 100,
                    unitItem: 'å…¬åˆ†', unitContainer: 'ä»¶', containerName: 'è¡£æœ',
                    getStep1: (t) => [`è£ç¸«å¸«æœ‰ ${t} å…¬åˆ†çš„å¸ƒæ–™ç”¨ä¾†åšè¡£æœã€‚`],
                    getStep2: (p1, p2) => [`å€‰åº«è£¡æœ‰ä¸€å¡Š ${p1} å…¬åˆ†çš„å¸ƒæ–™ï¼Œ`, `å¾Œä¾†åˆé€²è²¨äº† ${p2} å…¬åˆ†ã€‚`],
                    getStep3: (p1, p2, p3) => [`è£ç¸«å¸«æ‰¾åˆ°äº†ä¸‰å¡Šå¸ƒæ–™ï¼Œ`, `åˆ†åˆ¥æ˜¯ ${p1} å…¬åˆ†ã€`, `${p2} å…¬åˆ†å’Œ ${p3} å…¬åˆ†ã€‚`],
                    getRule: (d) => `åšä¸€ä»¶å®Œæ•´çš„è¡£æœéœ€è¦å‰ªè£ ${d} å…¬åˆ†çš„å¸ƒæ–™ã€‚`,
                    kw: 'æœ€å¤šå¯ä»¥åšå¹¾ä»¶å®Œæ•´çš„è¡£æœ'
                },
                {
                    subject: 'å°æ™º', itemNoun: 'é›¶ç”¨éŒ¢', totalMin: 300, totalMax: 1500, divMin: 35, divMax: 120,
                    unitItem: 'å…ƒ', unitContainer: 'å€‹', containerName: 'æ–‡å…·ç›’',
                    getStep1: (t) => [`å°æ™ºå­˜äº† ${t} å…ƒçš„é›¶ç”¨éŒ¢è¦å»æ–‡å…·åº—ã€‚`],
                    getStep2: (p1, p2) => [`å°æ™ºçš„æ’²æ»¿è£¡æœ‰ ${p1} å…ƒï¼Œ`, `éå¹´æ™‚åˆæ‹¿åˆ°äº† ${p2} å…ƒçš„ç´…åŒ…ã€‚`],
                    getStep3: (p1, p2, p3) => [`å°æ™ºç¬¬ä¸€å€‹æœˆå­˜äº† ${p1} å…ƒï¼Œ`, `ç¬¬äºŒå€‹æœˆå­˜äº† ${p2} å…ƒï¼Œ`, `ç¬¬ä¸‰å€‹æœˆåˆå­˜äº† ${p3} å…ƒã€‚`],
                    getRule: (d) => `æ–‡å…·åº—è£¡ä¸€å€‹æ–‡å…·ç›’è³£ ${d} å…ƒã€‚`,
                    kw: 'æœ€å¤šå¯ä»¥è²·å¹¾å€‹æ–‡å…·ç›’'
                }
            ],
            // å¹²æ“¾è³‡è¨Šå…¨éƒ¨æ›¿æ›ç‚ºèˆ‡é¡Œç›®é‡‘éŒ¢ã€æ•¸é‡ä¸è¡çªçš„æ•˜è¿°
            noises: [
                'ä»–çš„å¹¸é‹æ•¸å­—æ˜¯ 7ã€‚', 'æ—é‚Šæœ‰ 3 éš»å¯æ„›çš„è²“å’ªåœ¨ç¡è¦ºã€‚', 'ä»–ä»Šå¹´å‰›æ»¿ 45 æ­²ã€‚',
                'é€™ä»¶äº‹æƒ…é è¨ˆè¦èŠ± 2 å°æ™‚æ‰èƒ½å®Œæˆã€‚', 'ä»Šå¤©æ—©ä¸Š 8 é»ä¸‹äº†ä¸€å ´å¤§é›¨ã€‚', 'ä»–å®¶è£¡é¤Šäº† 5 æ¢é‡‘é­šã€‚',
                'é€™æ£Ÿå¤§æ¨“æœ‰ 12 å±¤æ¨“é«˜ã€‚', 'ä»Šå¤©çš„æ°£æº«é«˜é” 32 åº¦ã€‚', 'ä»–æ˜¨å¤©è·‘äº† 800 å…¬å°ºçš„æ“å ´ã€‚'
            ]
        };

        // å–®ä¸€é¡Œç›®ç”Ÿæˆå™¨ (æ”¯æ´é‡æ¸¬æ™‚ä½¿ç”¨ç›¸åŒé…ç½®)
        const generateSingleQuestion = (level, forcedFateType = null) => {
            let steps = 1; let noiseCount = 0;
            if (level === 1) { steps = 1; noiseCount = 1; }
            else if (level === 2) { steps = 2; noiseCount = 1; }
            else if (level === 3) { steps = 2; noiseCount = 2; }
            else if (level === 4) { steps = 3; noiseCount = 2; }
            else if (level === 5) { steps = 3; noiseCount = 3; }

            const fateType = forcedFateType || (Math.random() > 0.5 ? 'roundUp' : 'truncate');
            const templatePool = PCG_DATA[fateType];
            const tmpl = templatePool[Math.floor(Math.random() * templatePool.length)];

            const divisor = Math.floor(Math.random() * (tmpl.divMax - tmpl.divMin)) + tmpl.divMin;
            const total = Math.floor(Math.random() * (tmpl.totalMax - tmpl.totalMin)) + tmpl.totalMin;

            const quotient = Math.floor(total / divisor);
            const remainder = total % divisor;

            let finalAns = quotient;
            if (fateType === 'roundUp' && remainder > 0) finalAns = quotient + 1;

            let storySentences = [];
            if (steps === 1) {
                storySentences = tmpl.getStep1(total);
            } else if (steps === 2) {
                const p1 = Math.floor(total / 2) + Math.floor(Math.random() * 50);
                const p2 = total - p1;
                storySentences = tmpl.getStep2(p1, p2);
            } else if (steps === 3) {
                const p1 = Math.floor(total / 3);
                const p2 = Math.floor(total / 3);
                const p3 = total - p1 - p2;
                storySentences = tmpl.getStep3(p1, p2, p3);
            }

            const shuffledNoises = [...PCG_DATA.noises].sort(() => 0.5 - Math.random());
            const selectedNoises = shuffledNoises.slice(0, noiseCount);

            let combinedSentences = [...storySentences];
            for (let noise of selectedNoises) {
                const insertIdx = Math.floor(Math.random() * (combinedSentences.length + 1));
                combinedSentences.splice(insertIdx, 0, noise);
            }

            const ruleText = tmpl.getRule(divisor);
            const text = combinedSentences.join('') + ruleText + `è«‹å•ï¼Œ${tmpl.kw}ï¼Ÿ`;

            return {
                id: Date.now() + Math.random(),
                level, fateType, text, total, divisor, quotient, remainder, finalAns,
                unitContainer: tmpl.unitContainer, unitItem: tmpl.unitItem, ruleText: ruleText, containerName: tmpl.containerName
            };
        };

        // ==========================================
        // 2. ä¸»æ‡‰ç”¨ç¨‹å¼ (App Router & Sidebar Layout)
        // ==========================================
        function App() {
            const [theme, setTheme] = useState('missions');

            const menuItems = [
                { id: 'guide', icon: 'ğŸ“–', title: 'é™¤æ³•ç§˜ç¬ˆ', desc: 'é€²ä¸€æ³•èˆ‡æ¨å»æ³•çš„è§€å¿µ' },
                { id: 'missions', icon: 'ğŸ¯', title: 'ä»»å‹™æŒ‘æˆ°', desc: 'é™å™ªã€è¨ˆç®—èˆ‡é¤˜æ•¸åˆ¤æ–·' },
                { id: 'life', icon: 'ğŸŒ', title: 'ç”Ÿæ´»æƒ…å¢ƒ', desc: 'æƒ…å¢ƒç¯„ä¾‹èˆ‡è‡ªè¨‚å‡ºé¡Œæ©Ÿ' },
                { id: 'challenge', icon: 'âš”ï¸', title: 'ç´ é¤Šå¤§æŒ‘æˆ°', desc: 'ç¶œåˆæƒ…å¢ƒé¡Œé©—æ”¶' },
            ];

            return (
                <div className="flex flex-col md:flex-row h-full w-full bg-slate-100 font-sans text-slate-800 overflow-hidden">
                    {/* Sidebar */}
                    <div className="w-full md:w-72 lg:w-80 bg-teal-900 text-white flex flex-col shadow-2xl z-20 flex-shrink-0">
                        <div className="p-6 bg-teal-950 shadow-md relative overflow-hidden">
                            <div className="absolute top-0 right-0 opacity-10 text-6xl transform translate-x-4 -translate-y-4">âš–ï¸</div>
                            <h1 className="text-xl lg:text-2xl font-black tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-amber-200 to-amber-500 drop-shadow-sm leading-tight">
                                é¤˜æ•¸çš„å‘½é‹æ±ºå®š
                            </h1>
                            <p className="text-teal-200 text-xs mt-2 font-bold tracking-wide">å››å¹´ç´š | é™¤æ³•èˆ‡ç´ é¤Šæ‡‰ç”¨</p>
                        </div>

                        <nav className="flex-1 overflow-y-auto py-2 md:py-6 flex md:flex-col overflow-x-auto md:overflow-x-hidden hide-scrollbar">
                            {menuItems.map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => setTheme(item.id)}
                                    className={`flex-shrink-0 md:w-full text-left px-5 lg:px-6 py-4 flex flex-col transition-all border-b-4 md:border-b-0 md:border-l-4 relative group ${theme === item.id
                                        ? 'bg-teal-800 border-amber-400'
                                        : 'border-transparent hover:bg-teal-800/60'
                                        }`}
                                >
                                    <div className="flex items-center gap-3 mb-1">
                                        <span className="text-2xl drop-shadow-sm">{item.icon}</span>
                                        <span className={`font-bold text-base lg:text-lg whitespace-nowrap ${theme === item.id ? 'text-white' : 'text-teal-100 group-hover:text-white'}`}>
                                            {item.title}
                                        </span>
                                    </div>
                                    <span className={`text-xs md:pl-9 hidden md:block ${theme === item.id ? 'text-teal-200' : 'text-teal-300/70 group-hover:text-teal-200'}`}>
                                        {item.desc}
                                    </span>
                                </button>
                            ))}
                        </nav>
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 flex flex-col h-full overflow-hidden relative bg-slate-50">
                        <header className="glass-panel p-4 md:px-8 md:py-5 shadow-sm z-10 flex items-center border-b border-slate-200 sticky top-0">
                            <h2 className="text-2xl md:text-3xl font-black text-slate-800 flex items-center gap-3">
                                <span>{menuItems.find(i => i.id === theme)?.icon}</span>
                                {menuItems.find(i => i.id === theme)?.title}
                            </h2>
                        </header>

                        <main className="flex-1 overflow-y-auto p-4 md:p-8 relative scroll-smooth">
                            <div key={theme} className="max-w-5xl mx-auto h-full pb-10">
                                {theme === 'guide' && <ThemeGuide />}
                                {theme === 'missions' && <ThemeMissions />}
                                {theme === 'life' && <ThemeLife />}
                                {theme === 'challenge' && <ThemeChallenge />}
                            </div>
                        </main>
                    </div>
                </div>
            );
        }

        // ==========================================
        // 3. ä¸»é¡Œä¸€ï¼šé™¤æ³•ç§˜ç¬ˆ (é€²ä¸€ vs æ¨å»)
        // ==========================================
        function ThemeGuide() {
            return (
                <div className="animate-fade-in space-y-8">
                    <div className="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                        <h2 className="bg-sky-100 text-sky-800 text-2xl font-black p-4 px-6 border-b border-sky-200 flex items-center gap-2">
                            <span>â¬†ï¸</span> å‘½é‹ä¸€ï¼šé€²ä¸€æ³• (å¤§å®¶éƒ½ä¸èƒ½å°‘)
                        </h2>
                        <div className="p-6 md:p-8 flex flex-col md:flex-row gap-6 items-center">
                            <div className="flex-1">
                                <p className="text-slate-700 text-lg mb-4 leading-relaxed">
                                    ç•¶é¡Œç›®è¦æ±‚ã€Œ<span className="font-bold text-red-500">å…¨éƒ¨éƒ½è¦è£ä¸‹</span>ã€æˆ–å•ã€Œ<span className="font-bold text-red-500">è‡³å°‘è¦å¤šå°‘æ‰å¤ </span>ã€æ™‚ï¼Œæˆ‘å€‘å¿…é ˆç…§é¡§åˆ°é¤˜æ•¸ã€‚
                                </p>
                                <div className="bg-sky-50 p-4 rounded-xl border border-sky-100 mb-4">
                                    <h4 className="font-bold text-sky-800 mb-2">ğŸˆ æƒ…å¢ƒç¯„ä¾‹ï¼š25 äººæ­è»Šï¼Œ1 è¼›è»Šå 4 äºº</h4>
                                    <p className="font-mono text-lg font-bold text-slate-700">25 Ã· 4 = 6 ... 1</p>
                                    <p className="text-sm text-slate-600 mt-2">å•† 6 ä»£è¡¨åæ»¿ 6 è¼›è»Šï¼Œé¤˜æ•¸ 1 ä»£è¡¨å‰©ä¸‹ 1 å€‹äººã€‚</p>
                                </div>
                                <div className="bg-amber-100 border-l-4 border-amber-500 p-4 rounded-r-xl">
                                    <p className="font-bold text-amber-900">æ€è€ƒï¼šå‰©ä¸‹çš„ 1 å€‹äººå¯ä»¥ä¸æ­è»Šå—ï¼Ÿ</p>
                                    <p className="text-amber-800 text-sm mt-1">ä¸è¡Œï¼æ‰€ä»¥å¿…é ˆå¤šå« 1 è¼›è»Šã€‚ç­”æ¡ˆæ˜¯ <span className="font-black text-lg">6 + 1 = 7 (è¼›)</span></p>
                                </div>
                            </div>
                            <div className="text-center w-full md:w-1/3">
                                <div className="text-6xl mb-4 animate-bounce-subtle">ğŸšğŸƒ</div>
                                <span className="inline-block bg-sky-600 text-white font-bold px-4 py-2 rounded-full shadow-md">å•† + 1</span>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                        <h2 className="bg-pink-100 text-pink-800 text-2xl font-black p-4 px-6 border-b border-pink-200 flex items-center gap-2">
                            <span>âœ‚ï¸</span> å‘½é‹äºŒï¼šæ¨å»æ³• / å»å°¾æ³• (ä¸å¤ åšä¸€å€‹)
                        </h2>
                        <div className="p-6 md:p-8 flex flex-col md:flex-row gap-6 items-center">
                            <div className="text-center w-full md:w-1/3 order-2 md:order-1">
                                <div className="text-6xl mb-4 animate-bounce-subtle">ğŸ€âœ‚ï¸</div>
                                <span className="inline-block bg-pink-600 text-white font-bold px-4 py-2 rounded-full shadow-md">ç¶­æŒå•†ä¸è®Š</span>
                            </div>
                            <div className="flex-1 order-1 md:order-2">
                                <p className="text-slate-700 text-lg mb-4 leading-relaxed">
                                    ç•¶é¡Œç›®å•ã€Œ<span className="font-bold text-red-500">æœ€å¤šå¯ä»¥åšå¹¾å€‹å®Œæ•´çš„...</span>ã€æ™‚ï¼Œå¦‚æœå‰©ä¸‹çš„ææ–™ä¸å¤ åšæˆä¸€å€‹å®Œæ•´çš„æˆå“ï¼Œæˆ‘å€‘åªèƒ½æ”¾æ£„å®ƒã€‚
                                </p>
                                <div className="bg-pink-50 p-4 rounded-xl border border-pink-100 mb-4">
                                    <h4 className="font-bold text-pink-800 mb-2">ğŸˆ æƒ…å¢ƒç¯„ä¾‹ï¼š25 å…¬åˆ†ç·å¸¶ï¼Œ4 å…¬åˆ†åšä¸€å€‹è´è¶çµ</h4>
                                    <p className="font-mono text-lg font-bold text-slate-700">25 Ã· 4 = 6 ... 1</p>
                                    <p className="text-sm text-slate-600 mt-2">å•† 6 ä»£è¡¨å¯ä»¥åš 6 å€‹ï¼Œé¤˜æ•¸ 1 ä»£è¡¨å‰©ä¸‹ 1 å…¬åˆ†ã€‚</p>
                                </div>
                                <div className="bg-slate-100 border-l-4 border-slate-400 p-4 rounded-r-xl">
                                    <p className="font-bold text-slate-700">æ€è€ƒï¼šå‰©ä¸‹çš„ 1 å…¬åˆ†å¤ ä¸å¤ å†åšä¸€å€‹è´è¶çµï¼Ÿ</p>
                                    <p className="text-slate-600 text-sm mt-1">ä¸å¤ ï¼æ‰€ä»¥åªèƒ½ä¸Ÿæ£„æˆ–æ”¶èµ·ä¾†ã€‚ç­”æ¡ˆæ˜¯ <span className="font-black text-lg">6 (å€‹)</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ==========================================
        // 4. ä¸»é¡ŒäºŒï¼šä»»å‹™æŒ‘æˆ°
        // ==========================================
        function ThemeMissions() {
            const [currentIdx, setCurrentIdx] = useState(null);
            const [step, setStep] = useState(0);
            const [crossedOut, setCrossedOut] = useState([]);

            const startProblem = (idx) => {
                setCurrentIdx(idx);
                setCrossedOut(Array(MISSIONS[idx].story.length).fill(false));
                setStep(1);
            };
            const nextStep = () => setStep(s => s + 1);

            if (step === 0) {
                return (
                    <div className="animate-fade-in">
                        <div className="bg-teal-50 p-6 rounded-2xl border border-teal-100 mb-8 flex flex-col md:flex-row gap-4 justify-between items-center shadow-inner">
                            <div>
                                <h3 className="text-xl font-bold text-teal-900 mb-2">å››å¹´ç´šé‹ç®—è©¦ç…‰ï¼š</h3>
                                <p className="text-teal-700 font-medium text-sm">å…ˆæ‰¾å‡ºé—œéµæ•¸å­—ï¼Œè¨ˆç®—å•†å’Œé¤˜æ•¸ï¼Œæœ€å¾Œæ±ºå®šé¤˜æ•¸çš„å‘½é‹ï¼</p>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {MISSIONS.map((p, idx) => (
                                <button key={p.id} onClick={() => startProblem(idx)} className="bg-white p-6 rounded-2xl shadow-sm border-2 border-slate-200 hover:border-teal-500 hover:shadow-lg transition-all text-left flex items-center gap-6 group">
                                    <div className="text-6xl group-hover:scale-110 transition-transform bg-slate-50 p-4 rounded-2xl">{p.containerEmoji}</div>
                                    <div className="flex-1">
                                        <span className={`text-xs font-bold px-3 py-1 rounded-full mb-2 inline-block shadow-inner ${p.fate === 'roundUp' ? 'bg-sky-100 text-sky-800' : 'bg-pink-100 text-pink-800'}`}>
                                            {p.fate === 'roundUp' ? 'é€²ä¸€æ³•' : 'æ¨å»æ³•'}
                                        </span>
                                        <h3 className="text-lg font-bold text-slate-800 group-hover:text-teal-700 transition-colors">{p.title}</h3>
                                    </div>
                                    <div className="text-slate-300 group-hover:text-teal-500 font-bold text-2xl">â”</div>
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }

            const problem = MISSIONS[currentIdx];

            return (
                <div className="flex flex-col h-full animate-fade-in relative pb-10">
                    <button onClick={() => setStep(0)} className="absolute top-0 right-0 text-slate-400 hover:text-slate-600 font-bold bg-white px-4 py-2 rounded-lg border border-slate-200 shadow-sm transition-colors z-10 flex items-center gap-1">
                        <span>âœ–</span> <span>è¿”å›é¸å–®</span>
                    </button>

                    <div className="w-full pt-4">
                        {step === 1 && <DenoiseStep problem={problem} initialSelections={crossedOut} onComplete={(sel) => { setCrossedOut(sel); nextStep(); }} />}
                        {step === 2 && <CalculateStep problem={problem} crossedOut={crossedOut} onComplete={nextStep} />}
                        {step === 3 && <FateDecisionStep problem={problem} crossedOut={crossedOut} onComplete={nextStep} />}
                        {step === 4 && (
                            <div className="text-center py-20 animate-fade-in bg-white rounded-3xl shadow-lg border-4 border-amber-300 mt-8 relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-full bg-gradient-to-b from-amber-50 to-white opacity-50"></div>
                                <div className="relative z-10">
                                    <div className="text-8xl mb-6 drop-shadow-md">ğŸ†</div>
                                    <h2 className="text-4xl font-black text-amber-600 mb-4">åˆ¤æ–·æ­£ç¢ºï¼ä»»å‹™éé—œï¼</h2>
                                    <p className="text-xl text-slate-600 mb-8 font-medium">ä½ æˆåŠŸæŒæ¡äº†ã€Œé¤˜æ•¸çš„å‘½é‹ã€ï¼</p>
                                    <button onClick={() => setStep(0)} className="bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white font-bold py-4 px-10 rounded-full text-xl shadow-lg transition-transform active:scale-95">
                                        æŒ‘æˆ°ä¸‹ä¸€å€‹æƒ…å¢ƒ
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function ProblemText({ story, crossedOut, interactive = false, onToggle = null }) {
            return (
                <div className="bg-white p-6 rounded-2xl shadow-sm border-l-8 border-teal-500 mb-6">
                    <div className="text-lg md:text-xl leading-relaxed font-medium select-none">
                        {story.map((part, idx) => {
                            const isCrossed = crossedOut[idx];
                            return (
                                <span key={idx} onClick={() => interactive && onToggle(idx)} className={`
                                    transition-all duration-200 px-1 py-1 rounded-lg mx-0.5 inline-block mb-1 leading-snug
                                    ${interactive ? 'cursor-pointer hover:bg-teal-50' : ''}
                                    ${isCrossed ? 'bg-slate-200 text-slate-400 line-through decoration-red-500 decoration-4 opacity-60' : 'text-slate-800'}
                                    ${part.highlight && !isCrossed ? 'bg-amber-100 border-b-4 border-amber-400 font-bold' : ''}
                                    ${part.isKey && !isCrossed ? 'text-teal-800 font-black bg-teal-50 px-2' : ''}
                                `}>
                                    {part.text}
                                </span>
                            );
                        })}
                    </div>
                </div>
            );
        }

        function DenoiseStep({ problem, initialSelections, onComplete }) {
            const [selections, setSelections] = useState(initialSelections);
            const [errorMsg, setErrorMsg] = useState("");

            const toggleSelection = (idx) => {
                const newSel = [...selections];
                newSel[idx] = !newSel[idx];
                setSelections(newSel);
                setErrorMsg("");
            };

            const checkAnswers = () => {
                const isCorrect = problem.story.every((part, idx) => (part.isNoise ? selections[idx] : !selections[idx]));
                if (isCorrect) onComplete(selections);
                else setErrorMsg("ä»”ç´°çœ‹å–”ï¼è«‹é»æ“ŠåŠƒæ‰ã€Œèˆ‡æ•¸å­—è¨ˆç®—ç„¡é—œã€çš„å¹²æ“¾è³‡è¨Šï¼");
            };

            return (
                <div className="animate-fade-in mt-4">
                    <h2 className="text-2xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <span className="bg-slate-800 text-white w-8 h-8 flex items-center justify-center rounded-full text-sm">1</span>
                        æ­¥é©Ÿä¸€ï¼šè³‡è¨Šé™å™ª (æ‰¾å‡ºå»¢è©±)
                    </h2>
                    <ProblemText story={problem.story} crossedOut={selections} interactive={true} onToggle={toggleSelection} />
                    {errorMsg && <p className="text-red-600 font-bold mb-4 animate-bounce-subtle text-center bg-red-50 py-3 rounded-lg border border-red-200">{errorMsg}</p>}
                    <div className="focus-container">
                        <button onKeyDown={handleKeyNavigation} onClick={checkAnswers} className="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold text-xl py-4 rounded-xl shadow-md transition-transform active:scale-95">ç¢ºèªä¸¦é€²å…¥ç®—å¼åˆ—å¼ â”</button>
                    </div>
                </div>
            );
        }

        function CalculateStep({ problem, crossedOut, onComplete }) {
            const [vals, setVals] = useState({ v1: '', v2: '', v3: '', v4: '' });
            const [errorMsg, setErrorMsg] = useState('');

            // è®“é›»è…¦å¹«å¿™ç®—çš„åŠŸèƒ½
            const autoCalculate = () => {
                const v1 = parseInt(vals.v1);
                const v2 = parseInt(vals.v2);
                if (v1 === problem.total && v2 === problem.divisor) {
                    setVals({ ...vals, v3: problem.quotient.toString(), v4: problem.remainder.toString() });
                    setErrorMsg('');
                } else {
                    setErrorMsg("è«‹å…ˆå¡«å¯«æ­£ç¢ºçš„ã€Œè¢«é™¤æ•¸ã€èˆ‡ã€Œé™¤æ•¸ã€ï¼Œé›»è…¦æ‰èƒ½å¹«ä½ ç®—å–”ï¼");
                }
            };

            const check = () => {
                const v1 = parseInt(vals.v1); const v2 = parseInt(vals.v2);
                const v3 = parseInt(vals.v3); const v4 = parseInt(vals.v4) || 0;
                if (v1 === problem.total && v2 === problem.divisor && v3 === problem.quotient && v4 === problem.remainder) {
                    onComplete();
                } else {
                    if (v1 !== problem.total || v2 !== problem.divisor) setErrorMsg("ç¸½æ•¸æˆ–é™¤æ•¸å¡«éŒ¯å›‰ï¼è«‹çœ‹é¡Œç›®ä¸Šæ¨™è¨˜çš„æ•¸å­—ã€‚");
                    else setErrorMsg("è¨ˆç®—éŒ¯èª¤ï¼è«‹é‡æ–°è¨ˆç®— å•† å’Œ é¤˜æ•¸ã€‚");
                }
            };

            return (
                <div className="animate-slide-in flex flex-col h-full mt-4">
                    <h2 className="text-2xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <span className="bg-slate-800 text-white w-8 h-8 flex items-center justify-center rounded-full text-sm">2</span>
                        æ­¥é©ŸäºŒï¼šåˆ—å‡ºé™¤æ³•ç®—å¼
                    </h2>
                    <ProblemText story={problem.story} crossedOut={crossedOut} />

                    <div className="bg-white p-8 rounded-3xl shadow-sm border-2 border-slate-200 flex flex-col items-center focus-container">
                        <div className="bg-teal-50 px-6 py-2 rounded-lg mb-8 text-teal-800 font-bold border border-teal-100 flex items-center gap-2">
                            <span>ğŸ“</span> è®€å–é—œéµè³‡è¨Šï¼Œè«‹å¡«å¯«å¤šä½æ•¸é™¤æ³•çµæœï¼š
                        </div>

                        <div className="flex flex-wrap items-center justify-center gap-2 md:gap-4 mb-8 text-2xl font-black text-slate-700 w-full">
                            <div className="flex flex-col items-center">
                                <input autoFocus type="number" onKeyDown={handleKeyNavigation} value={vals.v1} onChange={e => setVals({ ...vals, v1: e.target.value })} className="w-20 md:w-24 h-16 md:h-20 text-center border-4 border-slate-200 rounded-xl md:rounded-2xl focus:border-teal-500 bg-slate-50 outline-none" />
                                <span className="text-sm text-slate-500 mt-2 font-bold">è¢«é™¤æ•¸</span>
                            </div>
                            <span className="mb-6">Ã·</span>
                            <div className="flex flex-col items-center">
                                <input type="number" onKeyDown={handleKeyNavigation} value={vals.v2} onChange={e => setVals({ ...vals, v2: e.target.value })} className="w-20 md:w-24 h-16 md:h-20 text-center border-4 border-slate-200 rounded-xl md:rounded-2xl focus:border-teal-500 bg-slate-50 outline-none" />
                                <span className="text-sm text-slate-500 mt-2 font-bold">é™¤æ•¸</span>
                            </div>
                            <span className="mb-6">=</span>
                            <div className="flex flex-col items-center">
                                <input type="number" onKeyDown={handleKeyNavigation} value={vals.v3} onChange={e => setVals({ ...vals, v3: e.target.value })} className="w-20 md:w-24 h-16 md:h-20 text-center border-4 border-sky-300 rounded-xl md:rounded-2xl focus:border-sky-500 bg-sky-50 text-sky-700 outline-none" />
                                <span className="text-sm text-sky-600 mt-2 font-bold">å•†</span>
                            </div>
                            <span className="mb-6 tracking-widest text-slate-400">...</span>
                            <div className="flex flex-col items-center">
                                <input type="number" onKeyDown={handleKeyNavigation} value={vals.v4} onChange={e => setVals({ ...vals, v4: e.target.value })} placeholder="0" className="w-20 md:w-24 h-16 md:h-20 text-center border-4 border-pink-300 rounded-xl md:rounded-2xl focus:border-pink-500 bg-pink-50 text-pink-600 outline-none" />
                                <span className="text-sm font-bold text-pink-600 mt-2">é¤˜æ•¸</span>
                            </div>
                        </div>

                        {errorMsg && <p className="text-red-500 font-bold mb-6 bg-red-50 px-4 py-3 rounded-lg border border-red-200 shadow-sm">{errorMsg}</p>}

                        <div className="flex flex-col md:flex-row gap-4 w-full md:w-auto mt-2">
                            <button onKeyDown={handleKeyNavigation} onClick={autoCalculate} className="bg-indigo-500 hover:bg-indigo-600 text-white font-bold text-xl py-3 px-8 rounded-full shadow-md transition-transform active:scale-95 flex items-center justify-center gap-2">
                                <span>ğŸ’»</span> è®“é›»è…¦å¹«æˆ‘ç®—
                            </button>
                            <button onKeyDown={handleKeyNavigation} onClick={check} className="bg-teal-600 hover:bg-teal-700 text-white font-bold text-xl py-3 px-16 rounded-full shadow-md transition-transform active:scale-95 flex items-center justify-center">
                                æª¢æŸ¥ç®—å¼ â”
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function FateDecisionStep({ problem, crossedOut, onComplete }) {
            const [finalAns, setFinalAns] = useState('');
            const [errorMsg, setErrorMsg] = useState('');
            const [showHint, setShowHint] = useState(false);

            const isRoundUp = problem.fate === 'roundUp';

            const check = () => {
                if (parseInt(finalAns) === problem.finalAns) {
                    onComplete();
                } else {
                    setErrorMsg("ä¸å°å–”ï¼è«‹ä»”ç´°æƒ³ä¸€æƒ³é¤˜æ•¸çš„å‘½é‹ã€‚");
                    setShowHint(true);
                }
            };

            return (
                <div className="animate-slide-in flex flex-col h-full mt-4">
                    <h2 className="text-2xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <span className="bg-amber-500 text-white w-8 h-8 flex items-center justify-center rounded-full text-sm shadow-md">3</span>
                        æ­¥é©Ÿä¸‰ï¼šé¤˜æ•¸çš„å‘½é‹æ±ºå®šï¼
                    </h2>

                    {/* éœ€æ±‚2: ä¿ç•™é¡Œç›®ï¼Œæ–¹ä¾¿å°ç…§ */}
                    <ProblemText story={problem.story} crossedOut={crossedOut} />

                    <div className="bg-white p-6 md:p-8 rounded-3xl shadow-md border-2 border-amber-300 flex flex-col items-center focus-container relative overflow-hidden">

                        {/* ç®—å¼å›é¡§ */}
                        <div className="bg-slate-100 px-6 py-4 rounded-xl w-full text-center border border-slate-200 mb-6">
                            <p className="text-sm text-slate-500 font-bold mb-1">å‰›å‰›çš„è¨ˆç®—çµæœï¼š</p>
                            <p className="font-mono text-2xl font-black text-slate-800">
                                {problem.total} Ã· {problem.divisor} = {problem.quotient} <span className="text-sm text-slate-500 mx-1">({problem.containerUnit})</span> ... <span className="text-pink-600 bg-pink-100 px-2 rounded">{problem.remainder}</span> <span className="text-sm text-slate-500">({problem.itemUnit})</span>
                            </p>
                        </div>

                        {/* æƒ…å¢ƒå°è©±æ¡† */}
                        <div className="flex w-full gap-4 items-start mb-6 bg-amber-50 p-6 rounded-2xl border border-amber-200 shadow-inner">
                            <div className="text-5xl bg-white p-2 rounded-full shadow-sm">{problem.itemEmoji}</div>
                            <div className="flex-1">
                                <h4 className="font-black text-amber-900 text-lg mb-2">é—œéµæå•ï¼š</h4>
                                <p className="text-lg text-amber-800 font-medium leading-relaxed">
                                    {problem.fateQuestion}
                                </p>
                                {showHint && (
                                    <div className="mt-4 p-3 bg-white rounded-lg border-l-4 border-amber-400 animate-fade-in text-slate-700 font-bold text-sm">
                                        ğŸ’¡ æç¤ºï¼š{problem.fateAction}
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* æœ€çµ‚æ±ºç­– */}
                        <div className="flex flex-col items-center justify-center gap-4 w-full pt-6 border-t border-slate-100 mt-2">
                            <span className="text-xl font-bold text-slate-700">æ‰€ä»¥ï¼Œæ ¹æ“šé¡Œç›®æƒ…å¢ƒï¼Œæœ€çµ‚ç­”æ¡ˆæ˜¯ï¼š</span>

                            {isRoundUp ? (
                                <div className="flex flex-wrap items-center justify-center gap-2 md:gap-4 bg-sky-50 px-6 py-4 rounded-2xl border-2 border-sky-200 mt-2 w-full max-w-2xl">
                                    <span className="text-xl font-bold text-sky-800">é€²ä¸€æ³•åˆ—å¼ï¼š</span>
                                    <span className="text-3xl font-black text-slate-700">{problem.quotient}</span>
                                    <span className="text-3xl font-black text-sky-600">+</span>
                                    <span className="text-3xl font-black text-sky-600">1</span>
                                    <span className="text-3xl font-black text-slate-400">=</span>
                                    <div className="flex items-center gap-2">
                                        <input autoFocus type="number" onKeyDown={handleKeyNavigation} value={finalAns} onChange={e => setFinalAns(e.target.value)} className="w-24 p-3 border-4 border-amber-300 rounded-xl text-center text-2xl font-black focus:border-amber-500 bg-white outline-none shadow-inner text-amber-900" />
                                        <span className="text-xl font-bold text-slate-600">{problem.containerUnit}</span>
                                    </div>
                                </div>
                            ) : (
                                <div className="flex flex-wrap items-center justify-center gap-2 md:gap-4 bg-pink-50 px-6 py-4 rounded-2xl border-2 border-pink-200 mt-2 w-full max-w-2xl">
                                    <span className="text-xl font-bold text-pink-800">æ¨å»æ³•åˆ—å¼ï¼š</span>
                                    <span className="text-xl font-bold text-slate-500">ç¶­æŒåŸæœ¬çš„å•†</span>
                                    <span className="text-3xl font-black text-slate-700">{problem.quotient}</span>
                                    <span className="text-3xl font-black text-slate-400">=</span>
                                    <div className="flex items-center gap-2">
                                        <input autoFocus type="number" onKeyDown={handleKeyNavigation} value={finalAns} onChange={e => setFinalAns(e.target.value)} className="w-24 p-3 border-4 border-amber-300 rounded-xl text-center text-2xl font-black focus:border-amber-500 bg-white outline-none shadow-inner text-amber-900" />
                                        <span className="text-xl font-bold text-slate-600">{problem.containerUnit}</span>
                                    </div>
                                </div>
                            )}
                        </div>

                        {errorMsg && <p className="text-red-500 font-bold mt-6 bg-red-50 px-4 py-2 rounded-lg">{errorMsg}</p>}

                        <button onKeyDown={handleKeyNavigation} onClick={check} className="mt-8 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white font-bold text-xl py-4 px-16 rounded-full shadow-lg transition-transform active:scale-95 w-full md:w-auto">
                            é€å‡ºæœ€çµ‚ç­”æ¡ˆï¼
                        </button>
                    </div>
                </div>
            );
        }

        // ==========================================
        // 5. ä¸»é¡Œä¸‰ï¼šç”Ÿæ´»æƒ…å¢ƒ (å‹•æ…‹ç¯„ä¾‹ & å‡ºé¡Œæ©Ÿ)
        // ==========================================
        function ThemeLife() {
            const [mode, setMode] = useState('read'); // 'read' or 'create'

            return (
                <div className="animate-fade-in focus-container">
                    <div className="flex justify-center gap-4 mb-8 bg-white p-2 rounded-full shadow-sm border border-slate-200 w-max mx-auto">
                        <button onKeyDown={handleKeyNavigation} onClick={() => setMode('read')} className={`px-6 py-3 rounded-full font-bold transition-all ${mode === 'read' ? 'bg-amber-500 text-white shadow-md' : 'bg-transparent text-slate-500 hover:bg-slate-100'}`}>
                            ğŸ“– é–±è®€æƒ…å¢ƒç¯„ä¾‹
                        </button>
                        <button onKeyDown={handleKeyNavigation} onClick={() => setMode('create')} className={`px-6 py-3 rounded-full font-bold transition-all ${mode === 'create' ? 'bg-amber-500 text-white shadow-md' : 'bg-transparent text-slate-500 hover:bg-slate-100'}`}>
                            âœï¸ å°å°å‡ºé¡Œå®¶
                        </button>
                    </div>
                    {mode === 'read' ? <LifeScenarios /> : <LifeProblemBuilder />}
                </div>
            );
        }

        // 5-1. ç”Ÿæ´»æƒ…å¢ƒï¼šå‹•æ…‹ç¯„ä¾‹
        function LifeScenarios() {
            const scenarios = [
                {
                    type: 'roundUp', title: 'ã€é€²ä¸€æ³•ã€‘æ­ä¹˜éŠè¦½è»Š', icon: 'ğŸšŒ',
                    desc: 'å­¸æ ¡æœ‰ 250 ä½å¸«ç”Ÿè¦åƒåŠ æˆ¶å¤–æ•™å­¸ï¼Œä¸€è¼›éŠè¦½è»Šæœ€å¤šåªèƒ½å 40 äººã€‚ç‚ºäº†è®“å¤§å®¶éƒ½èƒ½å»ï¼Œç¸½å…±éœ€è¦å«å¹¾è¼›è»Šï¼Ÿ',
                    calc: '250 Ã· 40 = 6 ... 10',
                    explainCalc: 'å•†æ•¸ 6 ä»£è¡¨å¯ä»¥åæ»¿ 6 è¼›è»Šã€‚é¤˜æ•¸ 10 ä»£è¡¨é‚„å‰©ä¸‹ 10 å€‹äººæ²’æœ‰ä½å­ã€‚',
                    fateQuestion: 'é€™å‰©ä¸‹çš„ 10 å€‹äººå¯ä»¥ä¸å»æˆ¶å¤–æ•™å­¸å—ï¼Ÿ',
                    fateAction: 'ä¸è¡Œï¼Œå¤§å®¶éƒ½è¦å»ï¼æ‰€ä»¥å¿…é ˆç‚ºä»–å€‘å¤šå« 1 è¼›è»Šã€‚',
                    finalAns: '6 + 1 = 7 (è¼›)'
                },
                {
                    type: 'truncate', title: 'ã€æ¨å»æ³•ã€‘æ¡è³¼ç­†è¨˜æœ¬', icon: 'ğŸ““',
                    desc: 'è€å¸«ç²å¾—äº† 500 å…ƒçš„ç­ç´šç¶“è²»ï¼Œä¸€æœ¬ç­†è¨˜æœ¬è³£ 120 å…ƒã€‚è«‹å•é€™ç­†ç¶“è²»æœ€å¤šå¯ä»¥è²·å¹¾æœ¬ç­†è¨˜æœ¬ç•¶ä½œçå“ï¼Ÿ',
                    calc: '500 Ã· 120 = 4 ... 20',
                    explainCalc: 'å•†æ•¸ 4 ä»£è¡¨å¯ä»¥è²· 4 æœ¬ã€‚é¤˜æ•¸ 20 ä»£è¡¨é‚„å‰©ä¸‹ 20 å…ƒã€‚',
                    fateQuestion: 'å‰©ä¸‹çš„ 20 å…ƒå¤ ä¸å¤ å†è²·ä¸€æœ¬ 120 å…ƒçš„ç­†è¨˜æœ¬ï¼Ÿ',
                    fateAction: 'ä¸å¤ ï¼æ‰€ä»¥å‰©ä¸‹çš„éŒ¢åªèƒ½å­˜èµ·ä¾†ã€‚',
                    finalAns: 'ç¶­æŒ 4 (æœ¬)'
                },
                {
                    type: 'roundUp', title: 'ã€é€²ä¸€æ³•ã€‘è£ç®±å‡ºè²¨', icon: 'ğŸ“¦',
                    desc: 'æœè¾²æ¡æ”¶äº† 845 é¡†é ‚ç´šè˜‹æœï¼Œè¦å®šæ¯ 36 é¡†è£æˆä¸€å€‹ç¦®ç›’å‡ºè²¨ã€‚ç‚ºäº†æŠŠè˜‹æœå…¨éƒ¨é‹é€å‡ºå»ï¼Œè‡³å°‘éœ€è¦æº–å‚™å¹¾å€‹ç´™ç®±ï¼Ÿ',
                    calc: '845 Ã· 36 = 23 ... 17',
                    explainCalc: 'å•†æ•¸ 23 ä»£è¡¨å¯ä»¥è£æ»¿ 23 å€‹ç´™ç®±ã€‚é¤˜æ•¸ 17 ä»£è¡¨é‚„å‰©ä¸‹ 17 é¡†è˜‹æœæ²’è£ã€‚',
                    fateQuestion: 'å‰©ä¸‹çš„ 17 é¡†è˜‹æœå¯ä»¥ä¸è³£å—ï¼Ÿ',
                    fateAction: 'ä¸è¡Œï¼Œé ‚ç´šè˜‹æœå…¨éƒ¨éƒ½è¦å‡ºè²¨ï¼æ‰€ä»¥é€™ 17 é¡†ä¹Ÿéœ€è¦ç”¨ 1 å€‹æ–°ç´™ç®±è£èµ·ä¾†ã€‚',
                    finalAns: '23 + 1 = 24 (ç®±)'
                },
                {
                    type: 'truncate', title: 'ã€æ¨å»æ³•ã€‘é®®å¥¶è£ç“¶', icon: 'ğŸ¼',
                    desc: 'ç‰§å ´ä»Šå¤©ç”Ÿç”¢äº† 2500 æ¯«å‡çš„é®®å¥¶ï¼Œå·¥äººè¦å°‡é®®å¥¶åˆ†è£åˆ°ç“¶å­è£¡ï¼Œæ¯å€‹ç“¶å­è¦å®šè¦è£æ»¿ 350 æ¯«å‡ã€‚æœ€å¤šå¯ä»¥è£æ»¿å¹¾ç“¶ï¼Ÿ',
                    calc: '2500 Ã· 350 = 7 ... 50',
                    explainCalc: 'å•†æ•¸ 7 ä»£è¡¨å¯ä»¥è£æ»¿ 7 ç“¶ã€‚é¤˜æ•¸ 50 ä»£è¡¨é‚„å‰©ä¸‹ 50 æ¯«å‡çš„é®®å¥¶ã€‚',
                    fateQuestion: 'å‰©ä¸‹çš„ 50 æ¯«å‡èƒ½ç®—ä½œã€Œè£æ»¿ã€çš„ä¸€ç“¶å—ï¼Ÿ',
                    fateAction: 'ä¸èƒ½ï¼Œå› ç‚ºè¦å®šä¸€å®šè¦è£æ»¿ 350 æ¯«å‡ã€‚æ‰€ä»¥é€™ 50 æ¯«å‡ä¸èƒ½ç®—é€²å®Œæ•´çš„ç“¶æ•¸è£¡ã€‚',
                    finalAns: 'ç¶­æŒ 7 (ç“¶)'
                }
            ];

            return (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 animate-fade-in">
                    {scenarios.map((sc, i) => <ScenarioCard key={i} scenario={sc} />)}
                </div>
            );
        }

        function ScenarioCard({ scenario }) {
            const [step, setStep] = useState(0);
            const isRoundUp = scenario.type === 'roundUp';

            return (
                <div className={`bg-white rounded-3xl p-6 border-4 shadow-sm flex flex-col ${isRoundUp ? 'border-sky-200' : 'border-pink-200'} transition-all`}>
                    <div className="flex items-center gap-4 mb-4">
                        <div className="text-5xl">{scenario.icon}</div>
                        <h3 className={`text-xl font-black ${isRoundUp ? 'text-sky-800' : 'text-pink-800'}`}>{scenario.title}</h3>
                    </div>

                    <p className="text-slate-700 text-lg mb-6 leading-relaxed font-medium min-h-[80px]">
                        {scenario.desc}
                    </p>

                    <div className="flex-1 flex flex-col gap-4 mb-6">
                        {step >= 1 && (
                            <div className={`p-4 rounded-xl border animate-slide-in ${isRoundUp ? 'bg-sky-50 border-sky-100' : 'bg-pink-50 border-pink-100'}`}>
                                <p className="font-mono text-xl font-black text-slate-800 text-center mb-2">{scenario.calc}</p>
                                <p className="text-slate-600 text-sm font-medium">{scenario.explainCalc}</p>
                            </div>
                        )}
                        {step >= 2 && (
                            <div className="p-4 rounded-xl bg-amber-50 border border-amber-200 animate-slide-in">
                                <p className="font-bold text-amber-900 mb-1">ğŸ¤” æ€è€ƒï¼š{scenario.fateQuestion}</p>
                                <p className="text-amber-800 text-sm">{scenario.fateAction}</p>
                            </div>
                        )}
                        {step >= 3 && (
                            <div className={`p-4 rounded-xl text-center border-2 animate-slide-in ${isRoundUp ? 'bg-sky-600 border-sky-700' : 'bg-pink-600 border-pink-700'}`}>
                                <span className="text-white font-medium">æœ€çµ‚ç­”æ¡ˆï¼š</span>
                                <span className="text-white font-black text-2xl mx-2 tracking-widest">{scenario.finalAns}</span>
                            </div>
                        )}
                    </div>

                    <div className="mt-auto text-center border-t border-slate-100 pt-4">
                        {step === 0 && <button onKeyDown={handleKeyNavigation} onClick={() => setStep(1)} className={`w-full font-bold py-3 rounded-xl text-white shadow-md active:scale-95 transition-transform ${isRoundUp ? 'bg-sky-500 hover:bg-sky-600' : 'bg-pink-500 hover:bg-pink-600'}`}>1. é€²è¡Œè¨ˆç®— â”</button>}
                        {step === 1 && <button onKeyDown={handleKeyNavigation} onClick={() => setStep(2)} className={`w-full font-bold py-3 rounded-xl text-white shadow-md active:scale-95 transition-transform ${isRoundUp ? 'bg-sky-600 hover:bg-sky-700' : 'bg-pink-600 hover:bg-pink-700'}`}>2. æ€è€ƒé¤˜æ•¸å‘½é‹ â”</button>}
                        {step === 2 && <button onKeyDown={handleKeyNavigation} onClick={() => setStep(3)} className={`w-full font-bold py-3 rounded-xl text-white shadow-md active:scale-95 transition-transform ${isRoundUp ? 'bg-sky-700 hover:bg-sky-800' : 'bg-pink-700 hover:bg-pink-800'}`}>3. ç¢ºèªæœ€çµ‚ç­”æ¡ˆ âœ…</button>}
                        {step === 3 && <button onKeyDown={handleKeyNavigation} onClick={() => setStep(0)} className="text-slate-400 font-bold hover:text-slate-600 text-sm underline">é‡æ–°çœ‹ä¸€æ¬¡</button>}
                    </div>
                </div>
            );
        }

        // 5-2. ç”Ÿæ´»æƒ…å¢ƒï¼šè‡ªè¨‚å‡ºé¡Œæ©Ÿ
        function LifeProblemBuilder() {
            const [total, setTotal] = useState('');
            const [divisor, setDivisor] = useState('');
            const [fateType, setFateType] = useState('roundUp');

            const roundUpContexts = [
                { name: 'å­¸ç”Ÿæ­å·´å£«', unitItem: 'äºº', containerName: 'è»Š', unitContainer: 'è¼›', emoji: 'ğŸšŒ' },
                { name: 'è˜‹æœè£ç®±å­', unitItem: 'é¡†', containerName: 'ç®±å­', unitContainer: 'å€‹', emoji: 'ğŸ“¦' },
                { name: 'æ—…å®¢ä½å®¢æˆ¿', unitItem: 'äºº', containerName: 'å®¢æˆ¿', unitContainer: 'é–“', emoji: 'ğŸ¨' },
                { name: 'ç«¥è»åˆ†å¸³ç¯·', unitItem: 'äºº', containerName: 'å¸³ç¯·', unitContainer: 'é ‚', emoji: 'â›º' },
                { name: 'å·¥äººæ­é›»æ¢¯', unitItem: 'äºº', containerName: 'é›»æ¢¯', unitContainer: 'éƒ¨', emoji: 'ğŸ¢' },
                { name: 'é›è›‹è£ç´™ç›’', unitItem: 'é¡†', containerName: 'é›è›‹ç›’', unitContainer: 'å€‹', emoji: 'ğŸ¥š' }
            ];
            const truncateContexts = [
                { name: 'ç·å¸¶åšè´è¶çµ', unitItem: 'å…¬åˆ†', containerName: 'è´è¶çµ', unitContainer: 'å€‹', emoji: 'ğŸ€' },
                { name: 'éºµç²‰çƒ¤è›‹ç³•', unitItem: 'å…‹', containerName: 'è›‹ç³•', unitContainer: 'å€‹', emoji: 'ğŸ‚' },
                { name: 'é›¶ç”¨éŒ¢è²·å¥½æ›¸', unitItem: 'å…ƒ', containerName: 'æ›¸', unitContainer: 'æœ¬', emoji: 'ğŸ“š' },
                { name: 'ç¶“è²»è²·èº²é¿çƒ', unitItem: 'å…ƒ', containerName: 'èº²é¿çƒ', unitContainer: 'é¡†', emoji: 'ğŸ' },
                { name: 'é®®å¥¶è£ç“¶å­', unitItem: 'æ¯«å‡', containerName: 'ç“¶å­', unitContainer: 'ç“¶', emoji: 'ğŸ¼' },
                { name: 'æ¯›ç·šç¹”åœå·¾', unitItem: 'å…¬å°º', containerName: 'åœå·¾', unitContainer: 'æ¢', emoji: 'ğŸ§£' }
            ];

            const [contextIdx, setContextIdx] = useState(0);
            const [result, setResult] = useState(null);

            useEffect(() => { setContextIdx(0); setResult(null); }, [fateType]);

            const activeContexts = fateType === 'roundUp' ? roundUpContexts : truncateContexts;
            const currentContext = activeContexts[contextIdx];

            const calculate = () => {
                const t = parseInt(total); const d = parseInt(divisor);
                if (!t || !d || t <= 0 || d <= 0) return alert('è«‹è¼¸å…¥å¤§æ–¼ 0 çš„æ­£ç¢ºæ•¸å­—ï¼');
                if (d > t) return alert('æ¢ä»¶æ•¸å­—ä¸èƒ½å¤§æ–¼ç¸½æ•¸é‡å–”ï¼');

                const q = Math.floor(t / d);
                const r = t % d;
                let finalAns = q;
                if (fateType === 'roundUp' && r > 0) finalAns = q + 1;

                setResult({ q, r, finalAns, t, d });
            };

            return (
                <div className="bg-white p-8 rounded-3xl shadow-sm border-2 border-slate-200">
                    <h2 className="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2"><span>âš™ï¸</span> é›»è…¦å‡ºé¡Œæ©Ÿï¼šçœ‹çœ‹é¤˜æ•¸çš„è®ŠåŒ–</h2>

                    <div className="space-y-6 bg-slate-50 p-6 md:p-8 rounded-2xl border border-slate-200">

                        <div className="flex flex-wrap items-center gap-4 text-lg">
                            <label className="font-bold text-slate-600">æ­¥é©Ÿ 1ï¼šé¸æ“‡æƒ…å¢ƒé¡å‹</label>
                            <select onKeyDown={handleKeyNavigation} value={fateType} onChange={e => setFateType(e.target.value)} className="p-3 border-2 rounded-xl font-bold bg-white text-indigo-800 outline-none focus:border-indigo-500 shadow-sm">
                                <option value="roundUp">éœ€è¦ã€Œå…¨éƒ¨è£å®Œã€(é€²ä¸€æ³•)</option>
                                <option value="truncate">éœ€è¦ã€Œå®Œæ•´æˆå“ã€(æ¨å»æ³•)</option>
                            </select>

                            <select onKeyDown={handleKeyNavigation} value={contextIdx} onChange={e => setContextIdx(Number(e.target.value))} className="p-3 border-2 rounded-xl font-bold bg-white outline-none focus:border-indigo-500 shadow-sm">
                                {activeContexts.map((ctx, idx) => <option key={idx} value={idx}>{ctx.emoji} {ctx.name}</option>)}
                            </select>
                        </div>

                        <div className="flex flex-wrap items-center gap-4 text-lg border-t border-slate-200 pt-6">
                            <label className="font-bold text-slate-600">æ­¥é©Ÿ 2ï¼šè¼¸å…¥æ•¸å­—</label>
                            <span>ç¸½å…±æœ‰</span>
                            <input autoFocus type="number" onKeyDown={handleKeyNavigation} value={total} onChange={e => { setTotal(e.target.value); setResult(null); }} className="w-24 p-2 border-2 rounded-lg text-center font-bold focus:border-indigo-500 outline-none shadow-inner" placeholder="ç¸½æ•¸" />
                            <span className="font-bold text-slate-700">{currentContext.unitItem}</span>

                            <span>ï¼Œæ¯</span>
                            <input type="number" onKeyDown={handleKeyNavigation} value={divisor} onChange={e => { setDivisor(e.target.value); setResult(null); }} className="w-24 p-2 border-2 rounded-lg text-center font-bold focus:border-indigo-500 outline-none shadow-inner" placeholder="æ¢ä»¶" />
                            <span className="font-bold text-slate-700">{currentContext.unitItem}</span>
                            <span>ç‚ºä¸€{currentContext.unitContainer}{currentContext.containerName}ã€‚</span>
                        </div>

                        <div className="w-full text-center pt-4">
                            <button onKeyDown={handleKeyNavigation} onClick={calculate} className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-xl py-3 px-12 rounded-xl shadow-md transition-transform active:scale-95">é€å‡ºçµ¦é›»è…¦ç®—</button>
                        </div>
                    </div>

                    {result && (
                        <div className="mt-8 bg-slate-800 text-white p-8 rounded-3xl animate-slide-in shadow-xl relative overflow-hidden">
                            <div className="absolute -right-10 -bottom-10 opacity-20 text-[150px]">{currentContext.emoji}</div>
                            <h3 className="text-xl font-bold text-amber-400 mb-6 flex items-center gap-2 relative z-10"><span>ğŸ’»</span> é›»è…¦è§£æå ±å‘Šï¼š</h3>

                            <div className="bg-slate-900 p-4 rounded-xl border border-slate-700 mb-6 relative z-10">
                                <p className="font-mono text-2xl font-black text-center tracking-widest">
                                    {result.t} Ã· {result.d} = <span className="text-sky-400">{result.q}</span> <span className="text-sm font-sans text-slate-400">({currentContext.unitContainer})</span> ... <span className="text-pink-400">{result.r}</span> <span className="text-sm font-sans text-slate-400">({currentContext.unitItem})</span>
                                </p>
                            </div>

                            <div className="space-y-4 relative z-10">
                                <p className="text-lg flex items-start gap-2">
                                    <span className="text-slate-400 mt-1">ğŸ“Œ</span>
                                    <span>å•†ä»£è¡¨å¯ä»¥æ»¿ <strong className="text-sky-300">{result.q} {currentContext.unitContainer}</strong>{currentContext.containerName}ã€‚é¤˜æ•¸ä»£è¡¨å‰©ä¸‹ <strong className="text-pink-300">{result.r} {currentContext.unitItem}</strong>ã€‚</span>
                                </p>
                                <div className={`p-4 rounded-xl border-l-4 ${fateType === 'roundUp' ? 'bg-sky-900/50 border-sky-400' : 'bg-pink-900/50 border-pink-400'}`}>
                                    <p className="font-bold mb-1 text-amber-200">âš–ï¸ å‘½é‹åˆ¤å®šï¼š</p>
                                    <p className="text-lg">
                                        {fateType === 'roundUp'
                                            ? (result.r > 0 ? `å› ç‚ºè¦æ±‚ã€Œå…¨éƒ¨è™•ç†å®Œã€ï¼Œå‰©ä¸‹çš„ ${result.r} ${currentContext.unitItem} ä¹Ÿéœ€è¦ 1 ${currentContext.unitContainer}${currentContext.containerName}ï¼Œæ‰€ä»¥è¦ ${result.q} + 1 = ${result.finalAns}ã€‚` : 'å› ç‚ºå‰›å‰›å¥½åˆ†å®Œæ²’æœ‰é¤˜æ•¸ï¼Œæ‰€ä»¥ä¸éœ€è¦åŠ  1ã€‚')
                                            : (result.r > 0 ? `å› ç‚ºè¦æ±‚ã€Œå®Œæ•´ã€ï¼Œå‰©ä¸‹çš„ ${result.r} ${currentContext.unitItem} ä¸å¤ åšä¸€å€‹æ–°çš„ï¼Œåªèƒ½æ¨æ£„ã€‚æ‰€ä»¥ç¶­æŒ ${result.finalAns} ${currentContext.unitContainer}ã€‚` : 'å› ç‚ºå‰›å‰›å¥½åˆ†å®Œæ²’æœ‰é¤˜æ•¸ï¼Œæ²’æœ‰å‰©ä¸‹ææ–™ã€‚')
                                        }
                                    </p>
                                </div>
                                <p className="text-2xl font-black mt-4 text-center pt-4 border-t border-slate-700">
                                    æœ€çµ‚ç­”æ¡ˆï¼š<span className="text-amber-400 text-3xl mx-2">{result.finalAns}</span> {currentContext.unitContainer}
                                </p>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ==========================================
        // 6. ä¸»é¡Œå››ï¼šç´ é¤Šå¤§æŒ‘æˆ° (PCG å‡ç´šå‘½é‹é¸æ“‡èˆ‡é‡æ¸¬æ©Ÿåˆ¶)
        // ==========================================
        function ThemeChallenge() {
            const [gameState, setGameState] = useState('start');
            const [questions, setQuestions] = useState([]);
            const [currentQIdx, setCurrentQIdx] = useState(0);
            const [score, setScore] = useState(0);
            const [retryCount, setRetryCount] = useState(0);
            const [retryState, setRetryState] = useState('none'); // 'none' | 'hint' | 'failed' | 'success'

            // å°å¹«æ‰‹ç®—å¼å€ç‹€æ…‹
            const [equations, setEquations] = useState([{ id: Date.now(), v1: '', op: 'Ã·', v2: '' }]);
            // åŒ…å«å‘½é‹é¸æ“‡ fateDecision ('addOne' | 'keep')
            const [ansVals, setAnsVals] = useState({ q: '', r: '', fateDecision: '', final: '' });
            const [feedback, setFeedback] = useState(null);

            const initQuestions = useCallback(() => {
                const qs = [];
                for (let i = 0; i < 5; i++) qs.push(generateSingleQuestion(i + 1));
                setQuestions(qs); setCurrentQIdx(0); setScore(0); setGameState('playing'); resetRound();
            }, []);

            const resetRound = () => {
                setEquations([{ id: Date.now(), v1: '', op: 'Ã·', v2: '' }]);
                setAnsVals({ q: '', r: '', fateDecision: '', final: '' });
                setFeedback(null);
                setRetryCount(0);
                setRetryState('none');
            };

            const handleRetry = () => {
                // ç”¢ç”ŸåŒç­‰ç´šã€åŒé¡å‹çš„æ–°é¡Œç›®æ›¿æ›ç›®å‰çš„é¡Œç›®
                const currentQ = questions[currentQIdx];
                const newQ = generateSingleQuestion(currentQ.level, currentQ.fateType);
                const newQuestions = [...questions];
                newQuestions[currentQIdx] = newQ;

                setQuestions(newQuestions);
                setEquations([{ id: Date.now(), v1: '', op: 'Ã·', v2: '' }]);
                setAnsVals({ q: '', r: '', fateDecision: '', final: '' });
                setFeedback(null);
                setRetryCount(1);
                setRetryState('none');
            };

            // ç®—å¼å°å¹«æ‰‹å‡½æ•¸
            const addEquation = () => {
                setEquations([...equations, { id: Date.now(), v1: '', op: '+', v2: '' }]);
                setTimeout(() => {
                    const inputs = document.querySelectorAll('.eq-v1-input');
                    if (inputs.length > 0) inputs[inputs.length - 1].focus();
                }, 50);
            };
            const removeEquation = (idToRemove) => { if (equations.length > 1) setEquations(equations.filter(eq => eq.id !== idToRemove)); };
            const updateEquation = (id, field, value) => setEquations(equations.map(eq => eq.id === id ? { ...eq, [field]: value } : eq));

            const computeResult = (v1, op, v2) => {
                const n1 = parseInt(v1); const n2 = parseInt(v2);
                if (isNaN(n1) || isNaN(n2)) return '?';
                if (op === '+') return n1 + n2;
                if (op === '-') return n1 - n2;
                if (op === 'Ã—') return n1 * n2;
                if (op === 'Ã·') {
                    if (n2 === 0) return 'é™¤æ•¸ä¸èƒ½ç‚º 0';
                    return `å•† ${Math.floor(n1 / n2)} é¤˜ ${n1 % n2}`;
                }
                return '?';
            };

            const submitAnswer = () => {
                if (feedback) return;
                const q = questions[currentQIdx];
                const userQ = parseInt(ansVals.q);
                const userR = parseInt(ansVals.r) || 0;
                const userFinal = parseInt(ansVals.final);
                const userFate = ansVals.fateDecision;

                let isCalcCorrect = (userQ === q.quotient && userR === q.remainder);
                let isFinalCorrect = (userFinal === q.finalAns);

                // åˆ¤æ–·æ­£ç¢ºçš„å‘½é‹ (è‹¥å‰›å¥½æ•´é™¤é¤˜æ•¸ç‚º0ï¼Œä¸è«–å“ªç¨®é¡Œå‹éƒ½ä¸éœ€é€²ä¸€)
                const correctFate = (q.fateType === 'roundUp' && q.remainder > 0) ? 'addOne' : 'keep';
                let isFateChoiceCorrect = (userFate === correctFate);

                if (isCalcCorrect && isFinalCorrect && isFateChoiceCorrect) {
                    setFeedback({ ok: true, msg: 'å¤ªå²å®³äº†ï¼è¨ˆç®—æ­£ç¢ºï¼Œä¸”é¤˜æ•¸åˆ¤æ–·å®Œç¾ï¼' });
                    setScore(s => s + (retryCount === 0 ? 20 : 10)); // ç¬¬ä¸€æ¬¡å°å¾—20åˆ†ï¼Œé‡æ¸¬å°å¾—10åˆ†
                    setRetryState('success');
                } else {
                    if (retryCount === 0) {
                        // ç¬¬ä¸€æ¬¡éŒ¯èª¤ï¼Œçµ¦äºˆé‡å°æ€§çš„è©³ç´°æç¤ºä¸¦è®“å­¸ç”Ÿæ›é¡Œé‡æ¸¬
                        let hintMsg = "";
                        if (!isCalcCorrect) {
                            hintMsg = `ã€æç¤ºï¼šç®—å¼ç®—éŒ¯å›‰ã€‘\nğŸ“Œ ç¶“éåŠ ç¸½å¾Œï¼Œç¢ºèªç¸½æ•¸ç‚º ${q.total} ${q.unitItem}ï¼Œ${q.ruleText}\nğŸ’¡ è«‹ç”¨å·¦å´çš„è¨ˆç®—æ©Ÿç®—ç®—çœ‹ï¼š${q.total} Ã· ${q.divisor} æœƒå¾—åˆ°å¤šå°‘å•†å’Œé¤˜æ•¸å‘¢ï¼Ÿ`;
                        } else if (!isFateChoiceCorrect) {
                            if (q.fateType === 'roundUp') {
                                hintMsg = `ã€æç¤ºï¼šå‘½é‹é¸æ“‡éŒ¯å›‰ã€‘\nğŸ“Œ é™¤æ³•ç®—å°äº†ï¼ç®—å‡ºå‰©ä¸‹ ${q.remainder} ${q.unitItem}ã€‚\nğŸ’¡ é¡Œç›®è¦æ±‚å…¨éƒ¨éƒ½è¦è™•ç†ï¼Œå‰©ä¸‹çš„é€™ ${q.remainder} ${q.unitItem} ä¸èƒ½ä¸Ÿè‘—ä¸ç®¡ã€‚ç‚ºäº†è®“å¤§å®¶éƒ½é¡§åˆ°ï¼Œæ˜¯ä¸æ˜¯å¿…é ˆè¦ã€Œå¤šæº–å‚™ä¸€${q.unitContainer}${q.containerName}ã€å‘¢ï¼Ÿè«‹å†æƒ³ä¸€æƒ³ï¼`;
                            } else {
                                hintMsg = `ã€æç¤ºï¼šå‘½é‹é¸æ“‡éŒ¯å›‰ã€‘\nğŸ“Œ é™¤æ³•ç®—å°äº†ï¼ç®—å‡ºå‰©ä¸‹ ${q.remainder} ${q.unitItem}ã€‚\nğŸ’¡ é¡Œç›®è¦çš„æ˜¯ã€Œå®Œæ•´çš„æˆå“ã€ï¼Œå‰©ä¸‹çš„é€™ ${q.remainder} ${q.unitItem} æ•¸é‡ä¸è¶³ï¼Œé‚„å¤ æ¹Šæˆå®Œæ•´çš„ä¸€${q.unitContainer}${q.containerName}å—ï¼Ÿå¦‚æœä¸å¤ ï¼Œæ˜¯ä¸æ˜¯åªèƒ½å¿ç—›ã€Œæ¨æ£„ã€å‘¢ï¼Ÿ`;
                            }
                        } else if (!isFinalCorrect) {
                            hintMsg = `ã€æç¤ºï¼šæœ€å¾ŒåŠ æ³•ç®—éŒ¯å›‰ã€‘\nğŸ“Œ è§€å¿µå®Œå…¨æ­£ç¢ºï¼Œå°±å·®æœ€å¾Œä¸€æ­¥è¨ˆç®—äº†ï¼ä½ é¸æ“‡äº†ã€Œ${userFate === 'addOne' ? 'éœ€è¦é€²ä¸€ (+1)' : 'ç¶­æŒåŸæ¨£ (æ¨å»)'}ã€ã€‚\nğŸ’¡ é‚£éº¼æœ€çµ‚ç­”æ¡ˆæ‡‰è©²æ˜¯ ${userFate === 'addOne' ? `${q.quotient} + 1` : `${q.quotient} ä¸è®Š`}ï¼Œè«‹ä»”ç´°æª¢æŸ¥ä¸€ä¸‹å¡«å…¥çš„æ•¸å­—ï¼`;
                        }

                        setFeedback({ ok: false, msg: `ç­”éŒ¯äº†ï¼\n\n${hintMsg}\n\nä¸ç”¨ç°å¿ƒï¼Œç³»çµ±å¹«ä½ æ›ä¸€é¡Œé¡ä¼¼çš„å†è©¦ä¸€æ¬¡ï¼` });
                        setRetryState('hint');
                    } else {
                        // ç¬¬äºŒæ¬¡å†éŒ¯ï¼Œçµ¦å‡ºæ›´åŠ å®Œæ•´ä¸”å…·æŒ‡å°èªçš„è©³è§£
                        let explain = `é‚„æ˜¯ç­”éŒ¯äº†å–”ï¼æ²’é—œä¿‚ï¼Œè€å¸«å¸¶è‘—ä½ ä¸€æ­¥ä¸€æ­¥ä¾†è§£é€™é¡Œï¼š\n\n`;
                        explain += `ğŸ‘‰ ã€ç¬¬ä¸€æ­¥ï¼šç¢ºèªç¸½æ•¸èˆ‡æ¢ä»¶ã€‘\nç¶“éå‰é¢çš„åŠ ç¸½ï¼Œç¸½å…±æ˜¯ ${q.total} ${q.unitItem}ï¼Œ${q.ruleText}\n\n`;
                        explain += `ğŸ‘‰ ã€ç¬¬äºŒæ­¥ï¼šé€²è¡Œé™¤æ³•è¨ˆç®—ã€‘\n${q.total} Ã· ${q.divisor} = ${q.quotient} ... ${q.remainder}\né€™ä»£è¡¨å¯ä»¥æ¹Šå‡ºå®Œæ•´çš„ ${q.quotient} ${q.unitContainer}${q.containerName}ï¼Œä¸¦ä¸”é‚„å‰©ä¸‹ ${q.remainder} ${q.unitItem}ã€‚\n\n`;

                        explain += `ğŸ‘‰ ã€ç¬¬ä¸‰æ­¥ï¼šæ±ºå®šé¤˜æ•¸çš„å‘½é‹ã€‘\n`;
                        if (q.fateType === 'roundUp') {
                            if (q.remainder > 0) {
                                explain += `é€™é¡Œæ˜¯æ¨™æº–çš„ã€Œé€²ä¸€æ³•ã€æƒ…å¢ƒï¼å› ç‚ºé¡Œç›®éš±å«è‘—ã€Œå…¨éƒ¨éƒ½è¦é¡§åˆ°ã€çš„æ„æ€ã€‚é›–ç„¶åªå‰©ä¸‹ ${q.remainder} ${q.unitItem}ï¼Œä½†å®ƒå€‘ä¸èƒ½è¢«ä¸Ÿæ£„ï¼Œä¹Ÿéœ€è¦ç”¨åˆ° 1 ${q.unitContainer}${q.containerName} ä¾†å®‰ç½®ã€‚\n\n`;
                                explain += `ğŸ“ ã€æœ€çµ‚çµè«–ã€‘\næ‰€ä»¥æˆ‘å€‘è¦æŠŠåŸæœ¬ç®—å‡ºçš„å•†æ•¸åŠ ä¸Š 1ï¼š\n${q.quotient} + 1 = ${q.finalAns} (${q.unitContainer})ã€‚æ­£ç¢ºç­”æ¡ˆæ˜¯ ${q.finalAns}ï¼`;
                            } else {
                                explain += `é€™é¡Œå‰›å¥½æ•´é™¤ï¼Œæ²’æœ‰å‰©ä¸‹ä»»ä½•æ±è¥¿ (é¤˜æ•¸ç‚º 0)ã€‚æ—¢ç„¶æ²’æœ‰å‰©ä¸‹ï¼Œå°±ä¸éœ€è¦å¤šæº–å‚™é¡å¤–çš„ç©ºé–“ã€‚\n\n`;
                                explain += `ğŸ“ ã€æœ€çµ‚çµè«–ã€‘\nç¶­æŒåŸä¾†çš„å•†æ•¸å³å¯ï¼Œæ­£ç¢ºç­”æ¡ˆæ˜¯ ${q.finalAns} ${q.unitContainer}ï¼`;
                            }
                        } else {
                            if (q.remainder > 0) {
                                explain += `é€™é¡Œæ˜¯æ¨™æº–çš„ã€Œæ¨å»æ³•ã€æƒ…å¢ƒï¼å› ç‚ºé¡Œç›®è¦æ±‚çš„æ˜¯ã€Œå®Œæ•´çš„æˆå“ã€ã€‚å‰©ä¸‹çš„ ${q.remainder} ${q.unitItem} æ•¸é‡ä¸è¶³ä»¥å†åšæˆä¸€å€‹å®Œæ•´çš„${q.unitContainer}${q.containerName}ï¼Œæ‰€ä»¥åªèƒ½æ¨æ£„ä¸ç”¨ã€‚\n\n`;
                                explain += `ğŸ“ ã€æœ€çµ‚çµè«–ã€‘\nå•†æ•¸ç¶­æŒä¸è®Šï¼Œæ­£ç¢ºç­”æ¡ˆæ˜¯ ${q.finalAns} ${q.unitContainer}ï¼`;
                            } else {
                                explain += `é€™é¡Œå‰›å¥½æ•´é™¤ï¼Œæ²’æœ‰å‰©ä¸‹ä»»ä½•æ±è¥¿ (é¤˜æ•¸ç‚º 0)ã€‚\n\n`;
                                explain += `ğŸ“ ã€æœ€çµ‚çµè«–ã€‘\nå‰›å¥½ç”¨å®Œï¼Œç¶­æŒåŸä¾†çš„å•†æ•¸å³å¯ï¼Œæ­£ç¢ºç­”æ¡ˆæ˜¯ ${q.finalAns} ${q.unitContainer}ï¼`;
                            }
                        }

                        setFeedback({ ok: false, msg: explain });
                        setRetryState('failed');
                    }
                }
            };

            const nextQuestion = () => {
                if (currentQIdx < 4) { setCurrentQIdx(c => c + 1); resetRound(); }
                else setGameState('end');
            };

            if (gameState === 'start') {
                return (
                    <div className="flex flex-col items-center justify-center h-full text-center p-8 animate-fade-in glass-panel rounded-3xl">
                        <div className="text-8xl md:text-9xl mb-6 drop-shadow-md">âš”ï¸</div>
                        <h2 className="text-3xl md:text-4xl font-black text-slate-800 mb-6">çµ‚æ¥µè©¦ç…‰ï¼šå¤šæ­¥é‹ç®—èˆ‡è£æ±º</h2>
                        <div className="text-base md:text-lg text-slate-700 mb-8 max-w-2xl text-left space-y-4 bg-white/60 p-6 rounded-2xl">
                            <p className="flex gap-2"><span>ğŸ“Œ</span> <span>æŒ‘æˆ°å…± 5 é¡Œã€‚é›£åº¦æ˜Ÿç­‰è¶Šé«˜ï¼Œä»£è¡¨æ­¥é©Ÿè¶Šå¤šï¼ˆéœ€å…ˆåŠ æ¸›ï¼‰ã€å¹²æ“¾å»¢è©±ä¹Ÿè¶Šå¤šã€‚</span></p>
                            <p className="flex gap-2"><span>ğŸ“Œ</span> <span><strong>å¼·çƒˆå»ºè­°ï¼š</strong>åˆ©ç”¨å·¦å´çš„ã€Œåˆ—å¼å€ã€ï¼ä½ åªè¦è¼¸å…¥æ•¸å­—å’Œç¬¦è™Ÿï¼Œç³»çµ±æœƒå¹«ä½ ç®—å‡ºåŠ ç¸½æˆ–å•†èˆ‡é¤˜æ•¸ï¼</span></p>
                            <p className="flex gap-2 font-bold text-red-600"><span>ğŸ“Œ</span> <span>ç®—å®Œå¾Œï¼Œè«‹æ ¹æ“šæƒ…å¢ƒæ˜ç¢ºé¸æ“‡é¤˜æ•¸çš„å‘½é‹ï¼ˆé€²ä¸€æˆ–æ¨å»ï¼‰ï¼Œä¸¦å¯«å‡ºæœ€å¾Œç­”æ¡ˆï¼</span></p>
                        </div>
                        <button onClick={initQuestions} className="bg-slate-800 hover:bg-slate-900 text-white font-bold text-xl md:text-2xl py-4 px-12 rounded-full shadow-xl transition-transform active:scale-95">é–‹å§‹æ¸¬é©—</button>
                    </div>
                );
            }

            if (gameState === 'end') {
                return (
                    <div className="flex flex-col items-center justify-center h-full text-center p-8 animate-fade-in glass-panel rounded-3xl">
                        <div className="text-[100px] md:text-[120px] mb-6 drop-shadow-lg">{score >= 80 ? 'ğŸ‘‘' : 'ğŸ’ª'}</div>
                        <h2 className="text-3xl md:text-4xl font-black text-slate-800 mb-2">æ¸¬é©—çµæŸï¼</h2>
                        <p className="text-xl md:text-2xl text-slate-600 mb-10 font-medium">ä½ çš„ç´ é¤Šè£æ±ºç¸½åˆ†æ˜¯ï¼š<span className="text-5xl font-black text-amber-500 mx-2">{score}</span> åˆ†</p>
                        <button onClick={initQuestions} className="bg-teal-600 hover:bg-teal-700 text-white font-bold text-xl py-4 px-10 rounded-full shadow-lg transition-transform active:scale-95">å†æ¸¬ä¸€æ¬¡</button>
                    </div>
                );
            }

            const q = questions[currentQIdx];

            return (
                <div className="animate-fade-in flex flex-col h-full focus-container">
                    <div className="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                        <div className="flex items-center gap-3">
                            <span className="bg-slate-800 text-white font-bold px-4 py-2 rounded-full shadow-sm text-sm">ç¬¬ {currentQIdx + 1} / 5 é¡Œ</span>
                            <span className="bg-amber-100 text-amber-800 font-bold px-4 py-2 rounded-full border border-amber-300 shadow-sm text-sm flex items-center gap-1">
                                é›£åº¦ï¼š<span className="tracking-widest">{'â­'.repeat(q.level)}</span>
                            </span>
                            {retryCount > 0 && <span className="bg-red-100 text-red-700 font-bold px-3 py-1 rounded-full text-xs">âš ï¸ é‡æ¸¬é¡Œ</span>}
                        </div>
                        <span className="font-bold text-slate-600 bg-white px-4 py-2 rounded-lg shadow-sm border border-slate-200 text-sm">åˆ†æ•¸ï¼š{score}</span>
                    </div>

                    <div className="bg-white p-6 md:p-8 rounded-3xl shadow-sm border-t-8 border-teal-500 mb-6 text-lg md:text-xl leading-relaxed font-medium text-slate-800">
                        {q.text}
                    </div>

                    <div className="flex flex-col xl:flex-row gap-6 pb-10">
                        {/* å·¦å´ï¼šç®—å¼å°å¹«æ‰‹å€ */}
                        <div className="bg-sky-50 p-6 rounded-3xl border-2 border-sky-200 flex-1 shadow-inner flex flex-col">
                            <h3 className="text-xl font-black text-sky-900 mb-4 flex items-center gap-2 border-b border-sky-200 pb-2">
                                <span>ğŸ§®</span> åˆ—å¼è¨ˆç®—å€ (é›»è…¦å¹«ä½ ç®—)
                            </h3>

                            <div className="space-y-4 mb-6">
                                {equations.map((eq, index) => (
                                    <div key={eq.id} className="flex flex-wrap items-center gap-2 bg-white p-3 rounded-xl shadow-sm border border-sky-100">
                                        <span className="font-black text-sky-300 w-5">{index + 1}.</span>
                                        <input autoFocus={index === 0} onKeyDown={handleKeyNavigation} type="number" value={eq.v1} onChange={(e) => updateEquation(eq.id, 'v1', e.target.value)} disabled={feedback != null} className="eq-v1-input w-20 md:w-24 p-2 rounded-lg border-2 border-slate-200 focus:border-sky-500 text-center text-lg font-bold bg-slate-50 outline-none" />

                                        <select onKeyDown={handleKeyNavigation} value={eq.op} onChange={(e) => updateEquation(eq.id, 'op', e.target.value)} disabled={feedback != null} className="p-2 rounded-lg border-2 border-slate-200 focus:border-sky-500 text-lg font-bold bg-slate-100 outline-none">
                                            <option value="+">+</option><option value="-">-</option><option value="Ã—">Ã—</option><option value="Ã·">Ã·</option>
                                        </select>

                                        <input type="number" onKeyDown={handleKeyNavigation} value={eq.v2} onChange={(e) => updateEquation(eq.id, 'v2', e.target.value)} disabled={feedback != null} className="w-20 md:w-24 p-2 rounded-lg border-2 border-slate-200 focus:border-sky-500 text-center text-lg font-bold bg-slate-50 outline-none" />

                                        <span className="font-bold text-xl text-slate-400 mx-1">=</span>
                                        <div className="bg-sky-100 px-4 py-2 rounded-lg border border-sky-200 min-w-[100px] text-center font-bold text-sky-800 text-lg shadow-inner">
                                            {computeResult(eq.v1, eq.op, eq.v2)}
                                        </div>
                                        {equations.length > 1 && !feedback && (
                                            <button onClick={() => removeEquation(eq.id)} className="ml-auto text-red-400 hover:text-red-600 font-bold px-2 text-xl transition-colors">âœ–</button>
                                        )}
                                    </div>
                                ))}
                            </div>

                            {!feedback && (
                                <button onKeyDown={handleKeyNavigation} onClick={addEquation} className="text-sky-700 font-bold hover:text-sky-900 flex items-center justify-center gap-2 bg-sky-200/50 hover:bg-sky-200 px-4 py-3 rounded-xl transition-colors mt-auto border border-dashed border-sky-300">
                                    <span>â•</span> æ–°å¢ä¸€æ­¥ç®—å¼
                                </button>
                            )}
                        </div>

                        {/* å³å´ï¼šä½œç­”å€ */}
                        <div className="bg-amber-50 p-6 rounded-3xl border-2 border-amber-200 flex-1 flex flex-col shadow-inner">
                            <h3 className="text-xl font-black text-amber-900 mb-4 flex items-center gap-2 border-b border-amber-200 pb-2">
                                <span>ğŸ¯</span> ä½œç­”èˆ‡å‘½é‹åˆ¤å®šå€
                            </h3>

                            <div className="bg-white p-6 rounded-2xl border border-amber-100 shadow-sm flex flex-col gap-6 mb-6">
                                {/* é™¤æ³•çµæœ */}
                                <div className="flex flex-col sm:flex-row items-center justify-center gap-3">
                                    <span className="font-bold text-slate-700">1. é™¤æ³•çµæœï¼š</span>
                                    <div className="flex items-center gap-2">
                                        <input type="number" onKeyDown={handleKeyNavigation} value={ansVals.q} onChange={e => setAnsVals({ ...ansVals, q: e.target.value })} disabled={feedback != null} className="w-20 p-2 border-b-4 border-slate-300 text-center font-bold text-xl focus:border-sky-400 bg-slate-50 outline-none" placeholder="å•†" />
                                        <span className="text-slate-500">...</span>
                                        <input type="number" onKeyDown={handleKeyNavigation} value={ansVals.r} onChange={e => setAnsVals({ ...ansVals, r: e.target.value })} disabled={feedback != null} className="w-20 p-2 border-b-4 border-slate-300 text-center font-bold text-xl focus:border-pink-400 bg-slate-50 outline-none" placeholder="é¤˜æ•¸" />
                                    </div>
                                </div>

                                {/* å‘½é‹é¸æ“‡ */}
                                <div className="border-t border-slate-100 pt-6 flex flex-col items-center">
                                    <label className="font-black text-amber-900 text-lg mb-4">2. æ€è€ƒé¤˜æ•¸çš„å‘½é‹ï¼šéœ€è¦é€²ä¸€å—ï¼Ÿ</label>
                                    <div className="flex flex-wrap justify-center gap-4 mb-4">
                                        <button
                                            onKeyDown={handleKeyNavigation}
                                            onClick={() => setAnsVals({ ...ansVals, fateDecision: 'addOne', final: '' })}
                                            disabled={feedback != null}
                                            className={`px-6 py-3 rounded-xl font-bold border-2 transition-all shadow-sm ${ansVals.fateDecision === 'addOne' ? 'bg-sky-500 text-white border-sky-600 scale-105' : 'bg-white text-sky-700 border-sky-200 hover:bg-sky-50'}`}
                                        >
                                            â¬†ï¸ éœ€è¦é€²ä¸€ (+1)
                                        </button>
                                        <button
                                            onKeyDown={handleKeyNavigation}
                                            onClick={() => setAnsVals({ ...ansVals, fateDecision: 'keep', final: '' })}
                                            disabled={feedback != null}
                                            className={`px-6 py-3 rounded-xl font-bold border-2 transition-all shadow-sm ${ansVals.fateDecision === 'keep' ? 'bg-pink-500 text-white border-pink-600 scale-105' : 'bg-white text-pink-700 border-pink-200 hover:bg-pink-50'}`}
                                        >
                                            âœ‚ï¸ ç¶­æŒåŸæ¨£ (æ¨å»)
                                        </button>
                                    </div>

                                    {/* æœ€çµ‚åˆ—å¼ */}
                                    {ansVals.fateDecision === 'addOne' && (
                                        <div className="flex flex-wrap items-center justify-center gap-3 bg-sky-50 p-4 rounded-xl border border-sky-200 w-full animate-fade-in">
                                            <span className="font-bold text-sky-800">æœ€å¾Œè¨ˆç®—ï¼š</span>
                                            <span className="text-2xl font-black text-slate-700">{ansVals.q || '?'}</span>
                                            <span className="text-2xl font-black text-sky-600">+ 1 =</span>
                                            <div className="flex items-center gap-2">
                                                <input type="number" onKeyDown={handleKeyNavigation} value={ansVals.final} onChange={e => setAnsVals({ ...ansVals, final: e.target.value })} disabled={feedback != null} className="w-24 p-2 border-4 border-sky-300 rounded-xl text-center text-xl font-black focus:border-sky-500 bg-white outline-none text-sky-900 shadow-inner" />
                                                <span className="font-bold text-lg text-slate-700">{q.unitContainer}</span>
                                            </div>
                                        </div>
                                    )}

                                    {ansVals.fateDecision === 'keep' && (
                                        <div className="flex flex-wrap items-center justify-center gap-3 bg-pink-50 p-4 rounded-xl border border-pink-200 w-full animate-fade-in">
                                            <span className="font-bold text-pink-800">ç¶­æŒåŸæœ¬çš„å•†ï¼š</span>
                                            <span className="text-2xl font-black text-slate-700">{ansVals.q || '?'}</span>
                                            <span className="text-2xl font-black text-pink-600">=</span>
                                            <div className="flex items-center gap-2">
                                                <input type="number" onKeyDown={handleKeyNavigation} value={ansVals.final} onChange={e => setAnsVals({ ...ansVals, final: e.target.value })} disabled={feedback != null} className="w-24 p-2 border-4 border-pink-300 rounded-xl text-center text-xl font-black focus:border-pink-500 bg-white outline-none text-pink-900 shadow-inner" />
                                                <span className="font-bold text-lg text-slate-700">{q.unitContainer}</span>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* æ§åˆ¶æŒ‰éˆ•å€ */}
                            {!feedback ? (
                                <button onKeyDown={handleKeyNavigation} onClick={submitAnswer} disabled={!ansVals.q || !ansVals.fateDecision || !ansVals.final} className="mt-auto bg-slate-800 disabled:bg-slate-300 hover:bg-slate-900 text-white font-bold text-xl py-4 rounded-xl shadow-md transition-transform active:scale-95">
                                    ç¢ºå®šé€å‡º
                                </button>
                            ) : (
                                <div className="mt-auto w-full text-center animate-fade-in flex flex-col">
                                    <div className={`p-5 rounded-2xl mb-5 text-left font-bold whitespace-pre-wrap border-2 ${feedback.ok ? 'bg-green-100 text-green-800 border-green-300' : 'bg-red-50 text-red-800 border-red-300 shadow-inner'}`}>
                                        {feedback.msg}
                                    </div>

                                    {retryState === 'hint' ? (
                                        <button onKeyDown={handleKeyNavigation} onClick={handleRetry} className="bg-amber-500 hover:bg-amber-600 text-white font-bold text-xl py-4 rounded-xl shadow-lg transition-transform active:scale-95 flex items-center justify-center gap-2">
                                            <span>ğŸ”„</span> æ›ä¸€é¡Œé¡ä¼¼çš„å†è©¦ä¸€æ¬¡ â”
                                        </button>
                                    ) : (
                                        <button onKeyDown={handleKeyNavigation} onClick={nextQuestion} className="bg-teal-600 hover:bg-teal-700 text-white font-bold text-xl py-4 rounded-xl shadow-lg transition-transform active:scale-95">
                                            {currentQIdx < 4 ? 'ä¸‹ä¸€é¡Œ â”' : 'æŸ¥çœ‹æœ€çµ‚æˆç¸¾ ğŸ†'}
                                        </button>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // æ›è¼‰ React æ‡‰ç”¨ç¨‹å¼
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>