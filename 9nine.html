<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Êô∫Ë∂£‰πù‰πù | ‰∫íÂãïÂºèÂ≠∏ÁøíÂØ¶È©óÂÆ§</title>

    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .touch-none {
            touch-action: none;
        }

        /* È™∞Â≠êÊªæÂãïÂãïÁï´ */
        @keyframes roll {
            0% {
                transform: rotateX(0deg) rotateY(0deg) scale(1);
            }

            25% {
                transform: rotateX(90deg) rotateY(45deg) scale(0.9);
            }

            50% {
                transform: rotateX(180deg) rotateY(180deg) scale(0.8);
            }

            75% {
                transform: rotateX(270deg) rotateY(225deg) scale(0.9);
            }

            100% {
                transform: rotateX(360deg) rotateY(360deg) scale(1);
            }
        }

        .dice-roll {
            animation: roll 0.6s ease-in-out;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // -----------------------------------------------------------------------------
        // SVG Icons
        // -----------------------------------------------------------------------------
        const ICONS = {
            'brain': (
                <g>
                    <path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z" />
                    <path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z" />
                </g>
            ),
            'volume-2': (
                <g>
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" />
                    <path d="M15.54 8.46a5 5 0 0 1 0 7.07" />
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14" />
                </g>
            ),
            'volume-x': (
                <g>
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" />
                    <line x1="23" y1="9" x2="17" y2="15" />
                    <line x1="17" y1="9" x2="23" y2="15" />
                </g>
            ),
            'book-open': (
                <g>
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                </g>
            ),
            'zap': (
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
            ),
            'trophy': (
                <g>
                    <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" />
                    <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" />
                    <path d="M4 22h16" />
                    <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" />
                    <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" />
                    <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" />
                </g>
            ),
            'star': (
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
            ),
            'check-circle': (
                <g>
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                    <polyline points="22 4 12 14.01 9 11.01" />
                </g>
            ),
            'x-circle': (
                <g>
                    <circle cx="12" cy="12" r="10" />
                    <line x1="15" y1="9" x2="9" y2="15" />
                    <line x1="9" y1="9" x2="15" y2="15" />
                </g>
            ),
            'mouse-pointer-2': (
                <path d="M4.037 4.688a.495.495 0 0 1 .651-.651l16 6.5a.5.5 0 0 1-.063.947l-6.124 1.58a2 2 0 0 0-1.438 1.435l-1.579 6.126a.5.5 0 0 1-.947.063z" />
            ),
            'play': (
                <polygon points="5 3 19 12 5 21 5 3" />
            ),
            'refresh-cw': (
                <g>
                    <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
                    <path d="M21 3v5h-5" />
                    <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
                    <path d="M8 21h-5v-5" />
                </g>
            ),
            'arrow-right': (
                <g>
                    <line x1="5" y1="12" x2="19" y2="12" />
                    <polyline points="12 5 19 12 12 19" />
                </g>
            ),
            'pencil': (
                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />
            ),
            'grid-2x2': (
                <g>
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                    <line x1="3" y1="12" x2="21" y2="12" />
                    <line x1="12" y1="3" x2="12" y2="21" />
                </g>
            )
        };

        const Icon = ({ name, size = 24, className = "" }) => {
            const content = ICONS[name];
            if (!content) return null;
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {content}
                </svg>
            );
        };

        // -----------------------------------------------------------------------------
        // Audio Hook
        // -----------------------------------------------------------------------------
        const useAudio = () => {
            const audioCtxRef = useRef(null);
            const [isSoundOn, setIsSoundOn] = useState(true);

            const initAudio = () => {
                if (!audioCtxRef.current) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    audioCtxRef.current = new AudioContext();
                }
                if (audioCtxRef.current.state === 'suspended') audioCtxRef.current.resume();
            };

            const playTick = () => {
                if (!isSoundOn) return;
                initAudio();
                const ctx = audioCtxRef.current;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(300, ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + 0.1);
            };

            const speak = (text) => {
                if (!isSoundOn) return;
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW';
                utterance.rate = 0.9;
                utterance.pitch = 1.1;
                window.speechSynthesis.speak(utterance);
            };

            return { isSoundOn, setIsSoundOn, playTick, speak };
        };

        const Confetti = ({ active }) => {
            if (!active) return null;
            const colors = ['bg-red-400', 'bg-blue-400', 'bg-green-400', 'bg-yellow-400', 'bg-purple-400'];
            return (
                <div className="absolute inset-0 overflow-hidden pointer-events-none z-50">
                    {[...Array(30)].map((_, i) => (
                        <div key={i} className={`absolute w-3 h-3 rounded-full ${colors[i % colors.length]} animate-bounce`}
                            style={{ left: `${Math.random() * 100}%`, top: `${Math.random() * 60}%`, animationDuration: `${0.5 + Math.random()}s`, animationDelay: `${Math.random() * 0.2}s` }} />
                    ))}
                </div>
            );
        };

        // -----------------------------------------------------------------------------
        // App Component
        // -----------------------------------------------------------------------------
        function App() {
            const [activeTab, setActiveTab] = useState('explore');
            const { isSoundOn, setIsSoundOn, playTick, speak } = useAudio();

            return (
                <div className="min-h-screen bg-slate-50 text-slate-800 font-sans selection:bg-indigo-100 touch-manipulation flex flex-col">
                    <header className="bg-white shadow-sm sticky top-0 z-30">
                        <div className="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <div className="bg-indigo-600 p-2 rounded-lg flex items-center justify-center">
                                    <Icon name="brain" className="text-white" size={24} />
                                </div>
                                <div>
                                    <h1 className="text-xl md:text-2xl font-black text-indigo-900 tracking-tight leading-none">Êô∫Ë∂£‰πù‰πù</h1>
                                    <span className="text-xs font-medium text-slate-500 hidden sm:inline">‰∫íÂãïÂºèÊï∏Â≠∏ÂØ¶È©óÂÆ§</span>
                                </div>
                            </div>
                            <button onClick={() => setIsSoundOn(!isSoundOn)} className={`p-2 rounded-full transition-colors ${isSoundOn ? 'bg-indigo-50 text-indigo-600' : 'bg-slate-100 text-slate-400'}`}>
                                <Icon name={isSoundOn ? "volume-2" : "volume-x"} size={20} />
                            </button>
                        </div>
                        <div className="max-w-4xl mx-auto px-4 flex gap-2 overflow-x-auto pb-0 pt-2 scrollbar-hide border-b border-slate-100">
                            <TabButton id="explore" label="Ë¶ñË¶∫Êé¢Á¥¢" icon="book-open" active={activeTab === 'explore'} onClick={setActiveTab} />
                            <TabButton id="practice" label="ÈñÉÂç°Á∑¥Áøí" icon="zap" active={activeTab === 'practice'} onClick={setActiveTab} />
                            <TabButton id="challenge" label="Ê•µÈÄüÊåëÊà∞" icon="trophy" active={activeTab === 'challenge'} onClick={setActiveTab} />
                        </div>
                    </header>

                    <main className="max-w-4xl mx-auto px-4 py-4 md:py-6 flex-1 w-full">
                        <div className="bg-white rounded-2xl shadow-xl ring-1 ring-slate-900/5 overflow-hidden min-h-[600px] h-full">
                            {activeTab === 'explore' && <ExploreMode playTick={playTick} speak={speak} isSoundOn={isSoundOn} />}
                            {activeTab === 'practice' && <PracticeMode playTick={playTick} speak={speak} />}
                            {activeTab === 'challenge' && <ChallengeMode playTick={playTick} speak={speak} />}
                        </div>
                    </main>

                    <footer className="text-center py-4 text-slate-400 text-xs">
                        <p>Designed for Future Learners</p>
                    </footer>
                </div>
            );
        }

        function TabButton({ id, label, icon, active, onClick }) {
            return (
                <button onClick={() => onClick(id)}
                    className={`flex items-center gap-2 px-4 md:px-6 py-3 rounded-t-lg transition-all duration-200 font-bold whitespace-nowrap text-sm md:text-base border-b-2 ${active ? 'bg-indigo-50 text-indigo-700 border-indigo-600' : 'bg-transparent text-slate-500 border-transparent hover:text-slate-700 hover:bg-slate-50'}`}>
                    <Icon name={icon} size={18} /> {label}
                </button>
            );
        }

        // -----------------------------------------------------------------------------
        // Explore Mode
        // -----------------------------------------------------------------------------
        function ExploreMode({ playTick, speak, isSoundOn }) {
            const rowValues = [1, 2, 3, 4, 5, 6, 7, 8, 9];
            const colValues = [1, 2, 3, 4, 5, 6, 7, 8, 9];
            const [dimensions, setDimensions] = useState({ r: 2, c: 2 });
            const [isDragging, setIsDragging] = useState(false);
            const [pattern, setPattern] = useState('‚óè');
            const gridRef = useRef(null);
            const patterns = ['‚óè', '‚òÖ', '‚ù§Ô∏è', 'üçé', 'üê±', '‚öΩÔ∏è', 'üöÄ', 'üíé'];

            const handlePointerDown = (r, c) => { setIsDragging(true); setDimensions({ r, c }); playTick(); };
            const handlePointerEnter = (r, c) => { if (isDragging) { if (r !== dimensions.r || c !== dimensions.c) playTick(); setDimensions({ r, c }); } };

            const getSpeakText = (r, c) => {
                const res = r * c;
                const connector = res > 10 ? '' : 'Âæó';
                return `${r} ${c} ${connector} ${res}`;
            };

            const handlePointerUp = () => {
                if (isDragging) {
                    setIsDragging(false);
                    if (isSoundOn) setTimeout(() => speak(getSpeakText(dimensions.r, dimensions.c)), 300);
                }
            };

            useEffect(() => {
                window.addEventListener('pointerup', handlePointerUp);
                return () => window.removeEventListener('pointerup', handlePointerUp);
            }, [isDragging, dimensions, isSoundOn]);

            const totalArea = dimensions.r * dimensions.c;

            return (
                <div className="h-full flex flex-col p-4 md:p-6 select-none">
                    <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div className="flex items-center gap-2 overflow-x-auto max-w-full pb-2 md:pb-0 scrollbar-hide w-full md:w-auto">
                            <span className="text-xs font-bold text-slate-400 uppercase mr-2 whitespace-nowrap">ÂúñÊ°à:</span>
                            {patterns.map((p) => (
                                <button key={p} onClick={() => setPattern(p)} className={`w-9 h-9 md:w-10 md:h-10 shrink-0 rounded-full flex items-center justify-center text-xl transition-all ${pattern === p ? 'bg-indigo-100 ring-2 ring-indigo-500 scale-110' : 'bg-slate-50 hover:bg-slate-100 text-slate-400 grayscale hover:grayscale-0'}`}>
                                    {p}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col items-center gap-4 md:gap-8">
                        <div className="bg-white px-6 md:px-10 py-4 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4 relative">
                            <div className="text-4xl md:text-6xl font-black text-slate-800 flex items-baseline gap-2 md:gap-4 font-mono">
                                <span className="text-indigo-600 w-[1ch] text-center">{dimensions.r}</span>
                                <span className="text-slate-300 text-2xl md:text-4xl">√ó</span>
                                <span className="text-purple-600 w-[1ch] text-center">{dimensions.c}</span>
                                <span className="text-slate-300 text-2xl md:text-4xl">=</span>
                                <span className="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 min-w-[2ch] text-center">{totalArea}</span>
                            </div>
                            <button onClick={() => speak(getSpeakText(dimensions.r, dimensions.c))} className="absolute -right-12 top-1/2 -translate-y-1/2 p-3 bg-indigo-50 text-indigo-600 rounded-full hover:bg-indigo-100 hover:scale-110 transition-all shadow-sm">
                                <Icon name="volume-2" size={20} />
                            </button>
                        </div>

                        <div className="relative bg-white p-2 md:p-4 rounded-2xl shadow-lg border border-slate-200 touch-none select-none">
                            <div className="flex">
                                <div className="flex flex-col justify-around mr-2 md:mr-4 pt-8 md:pt-10 pb-0">
                                    {rowValues.map(num => (
                                        <div key={`y-${num}`} className={`h-7 md:h-10 flex items-center justify-center font-bold text-sm md:text-lg transition-all duration-300 ${num <= dimensions.r ? 'text-indigo-600 scale-110' : 'text-slate-300'}`}>{num}</div>
                                    ))}
                                </div>
                                <div className="flex-1">
                                    <div className="grid grid-cols-9 gap-1 md:gap-2 mb-2">
                                        {colValues.map(num => (
                                            <div key={`x-${num}`} className={`text-center font-bold text-sm md:text-lg transition-all duration-300 ${num <= dimensions.c ? 'text-purple-600 scale-110' : 'text-slate-300'}`}>{num}</div>
                                        ))}
                                    </div>
                                    <div ref={gridRef} className="grid grid-cols-9 gap-1 md:gap-2 p-1 bg-slate-50 rounded-xl border border-slate-100" onPointerLeave={() => isDragging && setIsDragging(false)}>
                                        {rowValues.map((rowVal) => (
                                            colValues.map((colVal) => {
                                                const isActive = rowVal <= dimensions.r && colVal <= dimensions.c;
                                                const isRightEdge = colVal === dimensions.c && rowVal <= dimensions.r;
                                                const isBottomEdge = rowVal === dimensions.r && colVal <= dimensions.c;
                                                return (
                                                    <div key={`${rowVal}-${colVal}`}
                                                        onPointerDown={(e) => { e.target.releasePointerCapture(e.pointerId); handlePointerDown(rowVal, colVal); }}
                                                        onPointerEnter={() => handlePointerEnter(rowVal, colVal)}
                                                        className={`aspect-square rounded-md md:rounded-lg flex items-center justify-center text-base md:text-2xl cursor-pointer transition-all duration-100 select-none
                                                        ${isActive ? 'bg-gradient-to-br from-indigo-100 to-purple-100 shadow-sm transform scale-100' : 'bg-white border border-slate-200 hover:bg-slate-100'}
                                                        ${isRightEdge ? 'border-r-2 border-r-purple-400' : ''} ${isBottomEdge ? 'border-b-2 border-b-indigo-400' : ''}
                                                        ${isActive && isRightEdge && isBottomEdge ? 'rounded-br-xl z-10 ring-2 ring-indigo-200' : ''}`}>
                                                        {isActive && <span className="animate-[zoomIn_0.2s_ease-out]">{pattern}</span>}
                                                    </div>
                                                );
                                            })
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // -----------------------------------------------------------------------------
        // Practice Mode (Updated with Dice and Two Input Modes)
        // -----------------------------------------------------------------------------

        // Dice Component
        function Dice({ value, rolling, colorClass }) {
            return (
                <div className={`w-20 h-20 md:w-24 md:h-24 bg-white rounded-xl shadow-lg border-2 ${colorClass} flex items-center justify-center text-4xl md:text-5xl font-black font-mono transition-all duration-500 ${rolling ? 'dice-roll opacity-80' : 'scale-100'}`}>
                    {value}
                </div>
            );
        }

        function PracticeMode({ playTick, speak }) {
            const [question, setQuestion] = useState({ a: 2, b: 2, ans: 4 });
            const [options, setOptions] = useState([]);
            const [feedback, setFeedback] = useState(null);
            const [streak, setStreak] = useState(0);
            const [inputMode, setInputMode] = useState('choice'); // 'choice' | 'input'
            const [isRolling, setIsRolling] = useState(false);
            const [inputValue, setInputValue] = useState('');

            const inputRef = useRef(null);

            const generateQuestion = (delay = 0) => {
                setIsRolling(true);

                setTimeout(() => {
                    const a = Math.floor(Math.random() * 9) + 1;
                    const b = Math.floor(Math.random() * 9) + 1;
                    const ans = a * b;

                    let opts = new Set([ans]);
                    while (opts.size < 4) {
                        let offset = Math.floor(Math.random() * 10) - 5;
                        let val = ans + offset;
                        if (val > 0 && val !== ans) opts.add(val);
                    }

                    setQuestion({ a, b, ans });
                    setOptions(Array.from(opts).sort(() => Math.random() - 0.5));
                    setFeedback(null);
                    setInputValue('');

                    // Stop rolling shortly after values update
                    setTimeout(() => setIsRolling(false), 300);
                }, delay); // Wait for feedback to fade if needed
            };

            useEffect(() => {
                generateQuestion(0);
            }, []);

            useEffect(() => {
                if (inputMode === 'input' && !isRolling && !feedback && inputRef.current) {
                    inputRef.current.focus();
                }
            }, [inputMode, isRolling, feedback]);

            const handleAnswer = (val) => {
                if (feedback) return;

                playTick();
                const isCorrect = val === question.ans;

                if (isCorrect) {
                    setFeedback('correct');
                    setStreak(s => s + 1);

                    const connector = question.ans > 10 ? '' : 'Âæó';
                    speak(`Á≠îÂ∞ç‰∫ÜÔºÅ ${question.a} ${question.b} ${connector} ${question.ans}`);

                    setTimeout(() => generateQuestion(300), 1200);
                } else {
                    setFeedback('wrong');
                    setStreak(0);
                    speak("ÂÜçË©¶‰∏ÄÊ¨°");
                    setTimeout(() => {
                        setFeedback(null);
                        setInputValue('');
                        if (inputRef.current) inputRef.current.focus();
                    }, 1000);
                }
            };

            const handleInputSubmit = (e) => {
                e.preventDefault();
                if (!inputValue) return;
                handleAnswer(parseInt(inputValue));
            };

            return (
                <div className="h-full flex flex-col items-center justify-start p-4 md:p-8 relative">
                    <Confetti active={feedback === 'correct'} />

                    {/* Mode Toggle */}
                    <div className="w-full flex justify-center mb-6">
                        <div className="bg-slate-100 p-1 rounded-xl flex gap-1">
                            <button
                                onClick={() => setInputMode('choice')}
                                className={`px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all ${inputMode === 'choice' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}
                            >
                                <Icon name="grid-2x2" size={16} /> ÈÅ∏ÈÅ∏Áúã
                            </button>
                            <button
                                onClick={() => setInputMode('input')}
                                className={`px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all ${inputMode === 'input' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}
                            >
                                <Icon name="pencil" size={16} /> Â°´Â°´Áúã
                            </button>
                        </div>
                    </div>

                    <div className="absolute top-4 right-4 flex items-center gap-2 bg-yellow-50 px-4 py-2 rounded-full border border-yellow-200">
                        <Icon name="star" className="text-yellow-500 fill-yellow-500" size={20} />
                        <span className="font-bold text-yellow-700">ÈÄ£Á∫åÁ≠îÂ∞ç: {streak}</span>
                    </div>

                    <div className="max-w-md w-full mt-4 flex flex-col items-center">
                        {/* Dice Display */}
                        <div className="flex items-center justify-center gap-4 md:gap-8 mb-8">
                            <Dice value={question.a} rolling={isRolling} colorClass="border-indigo-200 text-indigo-600" />
                            <span className="text-4xl text-slate-300">√ó</span>
                            <Dice value={question.b} rolling={isRolling} colorClass="border-purple-200 text-purple-600" />
                            <span className="text-4xl text-slate-300">=</span>
                            <div className="w-20 h-20 md:w-24 md:h-24 flex items-center justify-center text-4xl font-bold text-indigo-600 border-b-4 border-indigo-100">
                                ?
                            </div>
                        </div>

                        {/* Input Section based on Mode */}
                        {inputMode === 'choice' ? (
                            <div className="grid grid-cols-2 gap-3 md:gap-4 w-full">
                                {options.map((opt, idx) => (
                                    <button key={idx} onClick={() => handleAnswer(opt)}
                                        disabled={feedback !== null}
                                        className={`
                                        h-16 md:h-20 rounded-2xl text-2xl md:text-3xl font-bold transition-all duration-200 transform active:scale-95 shadow-sm
                                        ${feedback === 'correct' && opt === question.ans
                                                ? 'bg-green-500 text-white ring-4 ring-green-200'
                                                : feedback === 'wrong' && opt !== question.ans
                                                    ? 'bg-slate-100 text-slate-300'
                                                    : feedback === 'wrong' && opt === question.ans
                                                        ? 'bg-slate-100 text-slate-300'
                                                        : 'bg-white border-2 border-slate-100 text-slate-600 hover:border-indigo-400 hover:text-indigo-600'
                                            }
                                        ${feedback === 'wrong' && opt !== question.ans ? 'opacity-50' : ''}
                                    `}
                                    >
                                        {opt}
                                    </button>
                                ))}
                            </div>
                        ) : (
                            <form onSubmit={handleInputSubmit} className="w-full relative">
                                <input
                                    ref={inputRef}
                                    type="number"
                                    pattern="[0-9]*"
                                    inputMode="numeric"
                                    value={inputValue}
                                    onChange={(e) => setInputValue(e.target.value)}
                                    disabled={feedback !== null}
                                    className={`w-full text-center text-4xl font-bold py-6 rounded-2xl border-2 outline-none transition-all shadow-sm
                                    ${feedback === 'correct'
                                            ? 'border-green-400 bg-green-50 text-green-600'
                                            : feedback === 'wrong'
                                                ? 'border-red-300 bg-red-50 text-red-500'
                                                : 'border-indigo-100 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 text-slate-800 placeholder-slate-200'
                                        }`}
                                    placeholder="Ëº∏ÂÖ•Á≠îÊ°à"
                                    autoFocus
                                />
                                <button type="submit"
                                    disabled={feedback !== null || !inputValue}
                                    className="absolute right-3 top-3 bottom-3 bg-indigo-600 text-white rounded-xl px-6 flex items-center justify-center hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                    <Icon name="arrow-right" />
                                </button>
                            </form>
                        )}

                        <div className="h-12 mt-6 flex items-center justify-center text-lg">
                            {feedback === 'correct' && (
                                <div className="flex items-center gap-2 text-green-600 font-bold animate-pulse">
                                    <Icon name="check-circle" /> Â§™Ê£í‰∫ÜÔºÅÊ≠£Á¢∫Á≠îÊ°àÔºÅ
                                </div>
                            )}
                            {feedback === 'wrong' && (
                                <div className="flex items-center gap-2 text-red-500 font-bold">
                                    <Icon name="x-circle" /> ÂìéÂëÄÔºÅÂÜçË©¶‰∏ÄÊ¨°ÁúãÁúãÔºü
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // -----------------------------------------------------------------------------
        // Challenge Mode
        // -----------------------------------------------------------------------------
        function ChallengeMode({ playTick, speak }) {
            const [gameState, setGameState] = useState('idle');
            const [timeLeft, setTimeLeft] = useState(30);
            const [score, setScore] = useState(0);
            const [currentQ, setCurrentQ] = useState(null);
            const [inputValue, setInputValue] = useState('');
            const inputRef = useRef(null);

            useEffect(() => {
                let timer;
                if (gameState === 'playing' && timeLeft > 0) {
                    timer = setInterval(() => setTimeLeft(t => t - 1), 1000);
                } else if (timeLeft === 0 && gameState === 'playing') {
                    setGameState('finished');
                    speak(`ÊôÇÈñìÂà∞ÔºÅ‰Ω†ÁöÑÂàÜÊï∏ÊòØ ${score} ÂàÜ`);
                }
                return () => clearInterval(timer);
            }, [gameState, timeLeft, score, speak]);

            useEffect(() => {
                if (gameState === 'playing' && inputRef.current) inputRef.current.focus();
            }, [gameState, currentQ]);

            const startGame = () => {
                playTick();
                setGameState('playing');
                setTimeLeft(30);
                setScore(0);
                nextQuestion();
            };

            const nextQuestion = () => {
                const a = Math.floor(Math.random() * 9) + 1;
                const b = Math.floor(Math.random() * 9) + 1;
                setCurrentQ({ a, b, ans: a * b });
                setInputValue('');
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const val = parseInt(inputValue);
                if (val === currentQ.ans) {
                    playTick();
                    setScore(s => s + 10 + Math.floor(timeLeft / 5));
                    nextQuestion();
                } else {
                    setInputValue('');
                }
            };

            if (gameState === 'idle') {
                return (
                    <div className="h-full flex flex-col items-center justify-center p-8 text-center">
                        <div className="bg-indigo-100 p-6 rounded-full mb-6">
                            <Icon name="trophy" className="text-indigo-600" size={64} />
                        </div>
                        <h2 className="text-3xl font-bold text-indigo-900 mb-4">Ê∫ñÂÇôÂ•ΩÊé•ÂèóÊåëÊà∞‰∫ÜÂóéÔºü</h2>
                        <p className="text-slate-600 mb-8 max-w-md">Âú® 30 ÁßíÂÖßÂõûÁ≠îÁõ°ÂèØËÉΩÂ§öÁöÑ‰πòÊ≥ïÈ°åÁõÆ(1~9)„ÄÇ<br />ÈÄüÂ∫¶Ë∂äÂø´ÔºåÂàÜÊï∏Ë∂äÈ´òÔºÅ</p>
                        <button onClick={startGame} className="bg-indigo-600 hover:bg-indigo-700 text-white text-xl font-bold py-4 px-12 rounded-full shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all flex items-center gap-3">
                            <Icon name="play" /> ÈñãÂßãÊ∏¨È©ó
                        </button>
                    </div>
                );
            }

            if (gameState === 'finished') {
                return (
                    <div className="h-full flex flex-col items-center justify-center p-8 text-center">
                        <Confetti active={true} />
                        <h2 className="text-3xl font-bold text-slate-800 mb-2">ÊôÇÈñìÂà∞ÔºÅ</h2>
                        <div className="text-6xl font-black text-indigo-600 mb-4">{score} <span className="text-2xl text-slate-400">ÂàÜ</span></div>
                        <p className="text-slate-600 mb-8 font-medium">{score > 150 ? "Â§™Á•û‰∫ÜÔºÅ‰Ω†ÊòØ‰πòÊ≥ïÂ§ßÂ∏´ÔºÅüèÜ" : score > 80 ? "ÂÅöÂæóÂæàÂ•ΩÔºÅÁπºÁ∫å‰øùÊåÅÔºÅüåü" : "ÂÜçÊé•ÂÜçÂé≤ÔºÅÁÜüËÉΩÁîüÂ∑ßÔºÅüí™"}</p>
                        <button onClick={startGame} className="bg-white border-2 border-slate-200 hover:border-indigo-500 hover:text-indigo-600 text-slate-600 font-bold py-3 px-8 rounded-full transition-all flex items-center gap-2">
                            <Icon name="refresh-cw" size={20} /> ÂÜçÁé©‰∏ÄÊ¨°
                        </button>
                    </div>
                );
            }

            return (
                <div className="h-full flex flex-col items-center justify-center p-4 md:p-8 max-w-lg mx-auto w-full">
                    <div className="w-full flex justify-between items-center mb-8">
                        <div className="flex flex-col">
                            <span className="text-xs font-bold text-slate-400 uppercase">Score</span>
                            <span className="text-2xl font-black text-indigo-600">{score}</span>
                        </div>
                        <div className="flex flex-col items-end">
                            <span className="text-xs font-bold text-slate-400 uppercase">Time</span>
                            <span className={`text-2xl font-black font-mono ${timeLeft < 5 ? 'text-red-500 animate-pulse' : 'text-slate-700'}`}>{timeLeft}s</span>
                        </div>
                    </div>
                    <div className="bg-slate-50 border border-slate-200 rounded-3xl p-8 w-full text-center shadow-sm mb-8">
                        <div className="text-5xl md:text-6xl font-black text-slate-800 flex items-center justify-center gap-4 font-mono">
                            <span>{currentQ.a}</span><span className="text-slate-300">√ó</span><span>{currentQ.b}</span><span className="text-slate-300">=</span><span className="text-indigo-400">?</span>
                        </div>
                    </div>
                    <form onSubmit={handleSubmit} className="w-full relative">
                        <input ref={inputRef} type="number" pattern="[0-9]*" inputMode="numeric" value={inputValue} onChange={(e) => setInputValue(e.target.value)} className="w-full text-center text-4xl font-bold py-4 rounded-2xl border-2 border-indigo-100 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 outline-none transition-all text-slate-800 placeholder-slate-200 shadow-sm" placeholder="Ëº∏ÂÖ•Á≠îÊ°à..." autoFocus />
                        <button type="submit" className="absolute right-2 top-2 bottom-2 bg-indigo-600 text-white rounded-xl px-4 flex items-center justify-center hover:bg-indigo-700 transition-colors"><Icon name="arrow-right" /></button>
                    </form>
                    <p className="mt-4 text-slate-400 text-sm">Êåâ‰∏ã Enter Êèê‰∫§Á≠îÊ°à</p>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

</body>

</html>