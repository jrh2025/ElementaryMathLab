<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>國小數學互動教學實驗室</title>
    <!-- 樣式庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 字型 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap"
        rel="stylesheet">

    <!-- 核心函式庫 (UMD 版本) -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js" crossorigin></script>
    <!-- 更新 Lucide 版本 -->
    <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 載入資料檔 -->
    <script src="data.js"></script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
        }

        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 20px -8px rgb(0 0 0 / 0.15);
        }

        /* 自定義捲軸 */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { createRoot } = ReactDOM;

        // --- Lucide Icon Helper (修復版 + React Props 修正) ---
        const LucideIcon = ({ name, size = 24, className = "", ...props }) => {
            if (!window.lucide || !window.lucide.icons) {
                console.warn("Lucide library not loaded or icons missing.");
                return <span className="inline-block bg-slate-100 rounded" style={{ width: size, height: size }}></span>;
            }
            const iconData = window.lucide.icons[name] || window.lucide.icons['CircleHelp'];
            if (!iconData) return null;

            // React 屬性名稱轉換 helper: 將 SVG 的 kebab-case 轉為 camelCase
            const convertAttrs = (attrs) => {
                if (!attrs) return attrs;
                const map = {
                    'stroke-width': 'strokeWidth',
                    'stroke-linecap': 'strokeLinecap',
                    'stroke-linejoin': 'strokeLinejoin',
                    'fill-rule': 'fillRule',
                    'clip-rule': 'clipRule',
                    'class': 'className'
                };

                return Object.entries(attrs).reduce((acc, [key, val]) => {
                    const newKey = map[key] || key;
                    acc[newKey] = val;
                    return acc;
                }, {});
            };

            const [tag, attrs, children] = iconData;

            const renderChild = (child, index) => {
                const [childTag, childAttrs, grandChildren] = child;
                return React.createElement(childTag, { ...convertAttrs(childAttrs), key: index },
                    grandChildren ? grandChildren.map(renderChild) : null
                );
            };

            return React.createElement(tag,
                {
                    ...convertAttrs(attrs),
                    width: size,
                    height: size,
                    className: className,
                    strokeWidth: 2, // 預設值，可能會被 props 覆蓋
                    ...props
                },
                children ? children.map(renderChild) : null
            );
        };

        // 定義頁面使用的靜態圖示
        const LayoutGrid = (p) => <LucideIcon name="LayoutGrid" {...p} />;
        const List = (p) => <LucideIcon name="List" {...p} />;
        const Search = (p) => <LucideIcon name="Search" {...p} />;
        const Database = (p) => <LucideIcon name="Database" {...p} />;
        const ArrowUpDown = (p) => <LucideIcon name="ArrowUpDown" {...p} />;
        const ArrowRight = (p) => <LucideIcon name="ArrowRight" {...p} />;
        const SearchX = (p) => <LucideIcon name="SearchX" {...p} />;
        const ExternalLink = (p) => <LucideIcon name="ExternalLink" {...p} />;

        // Color Helper
        const getColorConfig = (color) => {
            const configs = {
                blue: { bg: 'bg-blue-50', text: 'text-blue-600', border: 'border-blue-200', hover: 'hover:border-blue-400', iconBg: 'bg-blue-500', badge: 'bg-blue-100 text-blue-700' },
                sky: { bg: 'bg-sky-50', text: 'text-sky-600', border: 'border-sky-200', hover: 'hover:border-sky-400', iconBg: 'bg-sky-500', badge: 'bg-sky-100 text-sky-700' },
                indigo: { bg: 'bg-indigo-50', text: 'text-indigo-600', border: 'border-indigo-200', hover: 'hover:border-indigo-400', iconBg: 'bg-indigo-500', badge: 'bg-indigo-100 text-indigo-700' },
                green: { bg: 'bg-green-50', text: 'text-green-600', border: 'border-green-200', hover: 'hover:border-green-400', iconBg: 'bg-green-500', badge: 'bg-green-100 text-green-700' },
                orange: { bg: 'bg-orange-50', text: 'text-orange-600', border: 'border-orange-200', hover: 'hover:border-orange-400', iconBg: 'bg-orange-500', badge: 'bg-orange-100 text-orange-700' },
                rose: { bg: 'bg-rose-50', text: 'text-rose-600', border: 'border-rose-200', hover: 'hover:border-rose-400', iconBg: 'bg-rose-500', badge: 'bg-rose-100 text-rose-700' },
            };
            return configs[color] || configs.blue;
        };

        // --- 新增: 獨立的卡片元件 (處理展開/收合邏輯) ---
        const ToolCard = ({ tool }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            const style = getColorConfig(tool.color);

            // 判斷文字是否夠長需要顯示 "more" (這裡設定閾值為 55 字，可依需求調整)
            const shouldTruncate = tool.description.length > 55;

            const handleCardClick = () => {
                window.open(tool.link, '_blank');
            };

            const toggleExpand = (e) => {
                // 阻止事件冒泡，避免觸發卡片的跳轉
                e.preventDefault();
                e.stopPropagation();
                setIsExpanded(!isExpanded);
            };

            return (
                <div
                    onClick={handleCardClick}
                    className={`card-hover block rounded-3xl p-6 border-2 relative overflow-hidden group cursor-pointer ${style.bg} ${style.border} ${style.hover}`}
                >
                    {/* 背景裝飾 */}
                    <div className="absolute -top-6 -right-6 p-4 opacity-5 group-hover:opacity-10 transition-opacity transform group-hover:scale-110 pointer-events-none text-current">
                        <LucideIcon name={tool.icon} size={160} />
                    </div>

                    <div className="relative z-10 flex flex-col h-full">
                        <div className="flex justify-between items-start mb-4">
                            <div className={`w-14 h-14 rounded-2xl flex items-center justify-center text-white shadow-lg ${style.iconBg}`}>
                                <LucideIcon name={tool.icon} size={28} />
                            </div>
                            <span className={`text-xs font-black px-3 py-1.5 rounded-full bg-white/80 backdrop-blur border border-white/50 shadow-sm ${style.text}`}>
                                {tool.grade}
                            </span>
                        </div>

                        <h3 className="text-xl font-bold text-slate-800 mb-2 group-hover:text-blue-700 transition-colors line-clamp-1">
                            {tool.title}
                        </h3>

                        {/* 描述區域：使用 mb-4 讓下方按鈕有空間，flex-grow 讓內容撐開 */}
                        <div className="mb-6 flex-grow">
                            <p className={`text-slate-600 text-sm leading-relaxed font-medium transition-all ${isExpanded ? '' : 'line-clamp-3'}`}>
                                {tool.description}
                            </p>

                            {shouldTruncate && (
                                <button
                                    onClick={toggleExpand}
                                    className={`text-xs font-bold mt-1 hover:underline focus:outline-none z-20 relative ${style.text}`}
                                >
                                    {isExpanded ? "收起內容" : "...more"}
                                </button>
                            )}
                        </div>

                        <div className={`flex items-center text-sm font-bold mt-auto group-hover:translate-x-2 transition-transform ${style.text}`}>
                            開始練習 <ArrowRight size={16} className="ml-2" />
                        </div>
                    </div>
                </div>
            );
        };


        // 年級排序權重表
        const GRADE_WEIGHTS = {
            '一年級': 1, '二年級': 2, '三年級': 3,
            '四年級': 4, '五年級': 5, '六年級': 6
        };

        function App() {
            const [tools, setTools] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [sortBy, setSortBy] = useState('default');
            const [viewMode, setViewMode] = useState('grid');

            useEffect(() => {
                if (window.MATH_TOOLS_DATA) {
                    setTools(window.MATH_TOOLS_DATA);
                }
            }, []);

            // 資料過濾與排序邏輯
            const filteredTools = useMemo(() => {
                let result = [...tools];

                // 1. 搜尋
                if (searchTerm.trim()) {
                    const term = searchTerm.toLowerCase();
                    result = result.filter(t =>
                        t.title.toLowerCase().includes(term) ||
                        t.description.toLowerCase().includes(term) ||
                        t.grade.includes(term)
                    );
                }

                // 2. 排序
                if (sortBy === 'grade') {
                    result.sort((a, b) => {
                        const wa = GRADE_WEIGHTS[a.grade] || 99;
                        const wb = GRADE_WEIGHTS[b.grade] || 99;
                        return wa - wb;
                    });
                } else if (sortBy === 'title') {
                    result.sort((a, b) => a.title.localeCompare(b.title, 'zh-Hant'));
                }

                return result;
            }, [tools, searchTerm, sortBy]);

            return (
                <div className="min-h-screen flex flex-col text-slate-800">
                    {/* Header */}
                    <header className="bg-white shadow-sm sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-4 md:px-8 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="bg-gradient-to-br from-blue-600 to-indigo-600 p-2 rounded-lg text-white shadow-md">
                                    <LayoutGrid size={22} />
                                </div>
                                <h1 className="text-xl md:text-2xl font-black bg-clip-text text-transparent bg-gradient-to-r from-blue-700 to-indigo-500 hidden md:block">
                                    國小數學互動教學實驗室
                                </h1>
                                <h1 className="text-xl font-black text-blue-700 md:hidden">數學實驗室</h1>
                            </div>

                            {/* 桌面版統計資訊 */}
                            <div className="hidden md:flex items-center gap-4 text-sm text-slate-500 font-medium">
                                <div className="flex items-center gap-2">
                                    <Database size={16} />
                                    <span>共 {tools.length} 個單元</span>
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="flex-grow p-4 md:p-8 max-w-7xl mx-auto w-full">

                        {/* 控制列 */}
                        <div className="mb-8 flex flex-col md:flex-row gap-4 items-center justify-between bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                            {/* 搜尋框 */}
                            <div className="relative w-full md:max-w-md group">
                                <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-blue-500 transition-colors pointer-events-none">
                                    <Search size={20} />
                                </div>
                                <input
                                    type="text"
                                    placeholder="搜尋標題、年級或關鍵字..."
                                    className="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all bg-slate-50 focus:bg-white"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>

                            {/* 右側控制項 */}
                            <div className="flex items-center gap-3 w-full md:w-auto justify-end">
                                {/* 排序選單 */}
                                <div className="relative">
                                    <select
                                        value={sortBy}
                                        onChange={(e) => setSortBy(e.target.value)}
                                        className="appearance-none pl-9 pr-8 py-2.5 rounded-xl border border-slate-200 bg-white hover:border-slate-300 focus:outline-none focus:border-blue-500 text-sm font-bold text-slate-600 cursor-pointer"
                                    >
                                        <option value="default">預設排序</option>
                                        <option value="grade">依年級 (低➜高)</option>
                                        <option value="title">依標題名稱</option>
                                    </select>
                                    <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">
                                        <ArrowUpDown size={16} />
                                    </div>
                                </div>

                                {/* 視圖切換按鈕 */}
                                <div className="flex bg-slate-100 p-1 rounded-xl">
                                    <button
                                        onClick={() => setViewMode('grid')}
                                        className={`p-2 rounded-lg transition-all ${viewMode === 'grid' ? 'bg-white shadow text-blue-600' : 'text-slate-400 hover:text-slate-600'}`}
                                        title="卡片模式"
                                    >
                                        <LayoutGrid size={20} />
                                    </button>
                                    <button
                                        onClick={() => setViewMode('list')}
                                        className={`p-2 rounded-lg transition-all ${viewMode === 'list' ? 'bg-white shadow text-blue-600' : 'text-slate-400 hover:text-slate-600'}`}
                                        title="列表模式"
                                    >
                                        <List size={20} />
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* 無搜尋結果提示 */}
                        {filteredTools.length === 0 && (
                            <div className="text-center py-20">
                                <div className="bg-slate-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-400">
                                    <SearchX size={40} />
                                </div>
                                <h3 className="text-lg font-bold text-slate-600">找不到相關教材</h3>
                                <p className="text-slate-500 mt-2">請嘗試不同的關鍵字，或切換篩選條件。</p>
                                <button
                                    onClick={() => { setSearchTerm(''); setSortBy('default'); }}
                                    className="mt-4 px-4 py-2 bg-blue-50 text-blue-600 rounded-lg text-sm font-bold hover:bg-blue-100 transition-colors"
                                >
                                    清除搜尋條件
                                </button>
                            </div>
                        )}

                        {/* 卡片視圖 (Grid View) - 改用 ToolCard 元件 */}
                        {viewMode === 'grid' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {filteredTools.map((tool) => (
                                    <ToolCard key={tool.id} tool={tool} />
                                ))}
                            </div>
                        )}

                        {/* 列表視圖 (List View) */}
                        {viewMode === 'list' && (
                            <div className="flex flex-col gap-3">
                                {filteredTools.map((tool) => {
                                    const style = getColorConfig(tool.color);

                                    return (
                                        <a
                                            key={tool.id}
                                            href={tool.link}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="group flex items-center gap-4 bg-white p-4 rounded-xl border border-slate-200 hover:border-blue-400 hover:shadow-md transition-all"
                                        >
                                            <div className={`w-12 h-12 rounded-xl flex items-center justify-center text-white shadow-md shrink-0 ${style.iconBg}`}>
                                                <LucideIcon name={tool.icon} size={24} />
                                            </div>

                                            <div className="flex-grow min-w-0">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <h3 className="text-lg font-bold text-slate-800 truncate group-hover:text-blue-600 transition-colors">
                                                        {tool.title}
                                                    </h3>
                                                    <span className={`text-[10px] font-black px-2 py-0.5 rounded-full ${style.badge} shrink-0`}>
                                                        {tool.grade}
                                                    </span>
                                                </div>
                                                <p className="text-slate-500 text-sm truncate">
                                                    {tool.description}
                                                </p>
                                            </div>

                                            <div className="hidden sm:flex shrink-0 items-center justify-center w-10 h-10 rounded-full bg-slate-50 group-hover:bg-blue-50 text-slate-400 group-hover:text-blue-600 transition-colors">
                                                <ExternalLink size={20} />
                                            </div>
                                        </a>
                                    );
                                })}
                            </div>
                        )}

                    </main>

                    <footer className="text-center py-8 text-slate-400 text-sm font-medium border-t border-slate-200 mt-auto bg-white">
                        <div className="flex justify-center gap-4 mb-2">
                            <span>© 2025 國小數學互動教學實驗室</span>
                        </div>
                        <p className="text-xs text-slate-300">Designed for Education</p>
                    </footer>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>