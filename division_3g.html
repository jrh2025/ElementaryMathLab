<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™¤æ³•æ¢éšªå®¶(ä¸‰å¹´ç´š) | åœ‹å°æ•¸å­¸äº’å‹•æ•™å­¸å¯¦é©—å®¤</title>

    <!-- è¼‰å…¥ React, ReactDOM, Babel, Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* æ“´å……è‡ªè¨‚å‹•ç•« */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes bounce-subtle {

            0%,
            100% {
                transform: translateY(-10%);
            }

            50% {
                transform: translateY(0);
            }
        }

        .animate-bounce {
            animation: bounce-subtle 1.5s infinite;
        }

        @keyframes pulse-subtle {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.8;
                transform: scale(1.05);
            }
        }

        .animate-pulse {
            animation: pulse-subtle 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* éš±è—åŸç”Ÿæ²è»¸ä½†ä¿æŒå¯æ²å‹•åŠŸèƒ½ */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        body {
            background-color: #f8fafc;
            overflow: hidden;
        }
    </style>
</head>

<body class="text-slate-800 font-sans antialiased h-screen w-screen">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // ==========================================
        // å…±ç”¨ UX å·¥å…·ï¼šEnter éµè‡ªå‹•è·³èºä¸‹ä¸€å€‹è¼¸å…¥æ¬„ä½
        // ==========================================
        const handleEnterFocusNext = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                // å°‹æ‰¾ç•¶å‰æ‰€åœ¨çš„è¡¨å–®å®¹å™¨
                const container = e.target.closest('.focus-container') || document.body;
                // æŠ“å–æ‰€æœ‰å¯ä»¥è¼¸å…¥èˆ‡äº’å‹•çš„å…ƒä»¶
                const focusableStr = 'input:not([disabled]), select:not([disabled]), button:not([disabled])';
                const elements = Array.from(container.querySelectorAll(focusableStr));
                const index = elements.indexOf(e.target);

                // å¦‚æœæœ‰æ‰¾åˆ°ä¸‹ä¸€å€‹å…ƒä»¶ï¼Œå‰‡èšç„¦å®ƒ
                if (index > -1 && index < elements.length - 1) {
                    elements[index + 1].focus();
                }
            }
        };

        // ==========================================
        // 1. è³‡æ–™åº«èˆ‡è¨­å®š (Data & Configuration)
        // ==========================================
        const MISSIONS = [
            {
                id: 1, type: 'partitive', title: 'ä»»å‹™ä¸€ï¼šå¹³åˆ†è˜‹æœ (ç„¡é¤˜æ•¸)',
                story: [
                    { text: 'æ£®æ—è£¡æœ‰ ', isNoise: false }, { text: '12 é¡†è˜‹æœ', isNoise: false, isKey: true }, { text: 'ã€‚', isNoise: false },
                    { text: 'å°ç†Šä»Šå¹´ 8 æ­²ï¼Œæ˜¨å¤©é‚„åƒäº† 2 å€‹å¸ƒä¸ã€‚', isNoise: true },
                    { text: 'è¦æŠŠè˜‹æœ', isNoise: false }, { text: 'å¹³å‡åˆ†çµ¦', isNoise: false, highlight: true }, { text: ' 3 éš»å°å…”å­', isNoise: false, isKey: true },
                    { text: 'ï¼Œæ¯éš»å°å…”å­å¯ä»¥åˆ†åˆ°å¹¾é¡†ï¼Ÿ', isNoise: false },
                ], total: 12, divisor: 3, quotient: 4, remainder: 0,
                itemEmoji: 'ğŸ', containerEmoji: 'ğŸ°', containerName: 'å°å…”å­', unit: 'é¡†'
            },
            {
                id: 2, type: 'quotitive', title: 'ä»»å‹™äºŒï¼šåŒ…è£ç³–æœ (ç„¡é¤˜æ•¸)',
                story: [
                    { text: 'åª½åª½è²·äº† ', isNoise: false }, { text: '15 é¡†ç³–æœ', isNoise: false, isKey: true }, { text: 'ã€‚', isNoise: false },
                    { text: 'é€™åŒ…ç³–æœåŸåƒ¹ 150 å…ƒï¼Œä»Šå¤©ç‰¹åƒ¹ 99 å…ƒã€‚', isNoise: true },
                    { text: 'è¦å®š', isNoise: false }, { text: 'æ¯ 5 é¡†è£æˆä¸€è¢‹', isNoise: false, highlight: true }, { text: 'ï¼Œè«‹å•å¯ä»¥è£æˆå¹¾è¢‹ï¼Ÿ', isNoise: false },
                ], total: 15, divisor: 5, quotient: 3, remainder: 0,
                itemEmoji: 'ğŸ¬', containerEmoji: 'ğŸ›ï¸', containerName: 'è¢‹å­', unit: 'é¡†'
            },
            {
                id: 3, type: 'partitive', title: 'ä»»å‹™ä¸‰ï¼šæ•´ç†ç©æœ¨ (ç„¡é¤˜æ•¸)',
                story: [
                    { text: 'æ•™å®¤è£¡æœ‰ ', isNoise: false }, { text: '24 å¡Šç©æœ¨', isNoise: false, isKey: true }, { text: 'ã€‚', isNoise: false },
                    { text: 'æ•™å®¤å¾Œé¢é‚„æœ‰ 15 æœ¬ç«¥è©±æ›¸å’Œ 3 é¡†ç±ƒçƒã€‚', isNoise: true },
                    { text: 'è€å¸«è«‹ä½ æŠŠå®ƒå€‘', isNoise: false }, { text: 'å¹³åˆ†æ”¾é€²', isNoise: false, highlight: true }, { text: ' 4 å€‹æ”¶ç´ç®±', isNoise: false, isKey: true },
                    { text: 'è£¡ï¼Œæ¯å€‹æ”¶ç´ç®±æœƒæœ‰å¹¾å¡Šç©æœ¨ï¼Ÿ', isNoise: false },
                ], total: 24, divisor: 4, quotient: 6, remainder: 0,
                itemEmoji: 'ğŸ§±', containerEmoji: 'ğŸ“¦', containerName: 'æ”¶ç´ç®±', unit: 'å¡Š'
            },
            {
                id: 4, type: 'quotitive', title: 'ä»»å‹™å››ï¼šç¶‘ç¶é‰›ç­† (ç„¡é¤˜æ•¸)',
                story: [
                    { text: 'æ–‡å…·åº—é€²è²¨äº† ', isNoise: false }, { text: '20 æé‰›ç­†', isNoise: false, isKey: true }, { text: 'ã€‚', isNoise: false },
                    { text: 'è€é—†ä»Šå¹´ 45 æ­²ï¼Œåº—è£¡é‚„æœ‰ 50 æœ¬ç­†è¨˜æœ¬ã€‚', isNoise: true },
                    { text: 'è€é—†è¦æŠŠé‰›ç­†', isNoise: false }, { text: 'æ¯ 5 æç¶æˆä¸€æ†', isNoise: false, highlight: true }, { text: 'ï¼Œè«‹å•å¯ä»¥ç¶æˆå¹¾æ†ï¼Ÿ', isNoise: false },
                ], total: 20, divisor: 5, quotient: 4, remainder: 0,
                itemEmoji: 'âœï¸', containerEmoji: 'ğŸª¢', containerName: 'æ†', unit: 'æ'
            },
            {
                id: 5, type: 'partitive', title: 'ä»»å‹™äº”ï¼šèŠ±æœµæ’ç“¶ (ç„¡é¤˜æ•¸)',
                story: [
                    { text: 'èŠ±åœ’è£¡æ¡äº† ', isNoise: false }, { text: '18 æœµç«ç‘°èŠ±', isNoise: false, isKey: true }, { text: 'ã€‚', isNoise: false },
                    { text: 'èŠ±åœ’è£¡å¦å¤–æœ‰ 12 æœµç™¾åˆèŠ±å’Œ 5 éš»è´è¶ã€‚', isNoise: true },
                    { text: 'æŠŠå®ƒå€‘', isNoise: false }, { text: 'å¹³å‡æ’é€²', isNoise: false, highlight: true }, { text: ' 3 å€‹èŠ±ç“¶', isNoise: false, isKey: true },
                    { text: 'ä¸­ï¼Œæ¯å€‹èŠ±ç“¶è¦æ’å¹¾æœµï¼Ÿ', isNoise: false },
                ], total: 18, divisor: 3, quotient: 6, remainder: 0,
                itemEmoji: 'ğŸŒ¹', containerEmoji: 'ğŸº', containerName: 'èŠ±ç“¶', unit: 'æœµ'
            },
            {
                id: 6, type: 'quotitive', title: 'ä»»å‹™å…­ï¼šçƒ¤æ‰‹å·¥é¤…ä¹¾ (ç„¡é¤˜æ•¸)',
                story: [
                    { text: 'å§å§çƒ¤äº† ', isNoise: false }, { text: '30 ç‰‡é¤…ä¹¾', isNoise: false, isKey: true }, { text: 'ã€‚', isNoise: false },
                    { text: 'å§å§çƒ¤é¤…ä¹¾èŠ±äº† 45 åˆ†é˜ï¼Œçƒ¤ç®±æº«åº¦æ˜¯ 180 åº¦ã€‚', isNoise: true },
                    { text: 'å¦‚æœ', isNoise: false }, { text: 'æ¯ 6 ç‰‡è£æˆä¸€ç›’', isNoise: false, highlight: true }, { text: 'ä¾†è³£ï¼Œè«‹å•å¯ä»¥è£æˆå¹¾ç›’ï¼Ÿ', isNoise: false },
                ], total: 30, divisor: 6, quotient: 5, remainder: 0,
                itemEmoji: 'ğŸª', containerEmoji: 'ğŸ', containerName: 'ç¦®ç›’', unit: 'ç‰‡'
            },
            {
                id: 7, type: 'partitive', title: 'ä»»å‹™ä¸ƒï¼šåˆ†ç™¼å½ˆç  (é€²éš-æœ‰é¤˜æ•¸)',
                story: [
                    { text: 'å°å®‰æ”¶é›†äº† ', isNoise: false }, { text: '26 é¡†å½ˆç ', isNoise: false, isKey: true }, { text: 'ã€‚', isNoise: false },
                    { text: 'å°å®‰å®¶è·é›¢å­¸æ ¡ 500 å…¬å°ºï¼Œèµ°è·¯è¦ 10 åˆ†é˜ã€‚', isNoise: true },
                    { text: 'ä»–æƒ³æŠŠå½ˆç ', isNoise: false }, { text: 'å¹³å‡åˆ†çµ¦', isNoise: false, highlight: true }, { text: ' 4 å€‹å¥½æœ‹å‹', isNoise: false, isKey: true },
                    { text: 'ï¼Œæ¯å€‹äººå¯ä»¥åˆ†åˆ°å¹¾é¡†ï¼Ÿé‚„å‰©ä¸‹å¹¾é¡†ä¸å¤ åˆ†ï¼Ÿ', isNoise: false },
                ], total: 26, divisor: 4, quotient: 6, remainder: 2,
                itemEmoji: 'ğŸ”®', containerEmoji: 'ğŸ‘¦', containerName: 'æœ‹å‹', unit: 'é¡†'
            },
            {
                id: 8, type: 'quotitive', title: 'ä»»å‹™å…«ï¼šæ•´ç†æ•…äº‹æ›¸ (é€²éš-æœ‰é¤˜æ•¸)',
                story: [
                    { text: 'åœ–æ›¸é¤¨è£¡æœ‰ ', isNoise: false }, { text: '35 æœ¬æ•…äº‹æ›¸', isNoise: false, isKey: true }, { text: 'ã€‚', isNoise: false },
                    { text: 'åœ–æ›¸é¤¨è£¡ç¸½å…±æœ‰ 5000 æœ¬æ›¸ï¼Œä»Šå¤©å€Ÿå‡ºäº† 128 æœ¬ã€‚', isNoise: true },
                    { text: 'ç‚ºäº†æ–¹ä¾¿æ¬é‹ï¼Œ', isNoise: false }, { text: 'æ¯ 8 æœ¬è£æˆä¸€ç®±', isNoise: false, highlight: true },
                    { text: 'ï¼Œè«‹å•å¯ä»¥è£æ»¿å¹¾ç®±ï¼Ÿé‚„å‰©ä¸‹å¹¾æœ¬è£ä¸æ»¿ï¼Ÿ', isNoise: false },
                ], total: 35, divisor: 8, quotient: 4, remainder: 3,
                itemEmoji: 'ğŸ“š', containerEmoji: 'ğŸ“¦', containerName: 'ç´™ç®±', unit: 'æœ¬'
            }
        ];

        const PCG_DATA = {
            subjects: ['å°æ™º', 'å®‰å¦®', 'é­”æ³•å¸«', 'ç²¾éˆ', 'åº—é•·', 'è¾²å¤«'],
            noises: [
                'ä»Šå¤©å¤©æ°£éå¸¸å¥½ï¼Œæœ‰å‡ºå¤ªé™½ã€‚', 'ä»–èº«ä¸Šå¸¶è‘— 500 å…ƒã€‚', 'ä»–ä»Šå¹´ 9 æ­²ï¼Œå–œæ­¡æ‰“ç±ƒçƒã€‚',
                'é€™äº›æ±è¥¿çš„é¡è‰²éå¸¸é®®è±”ã€‚', 'æ—é‚Šæœ‰ä¸€éš»å¯æ„›çš„å°ç‹—åœ¨ç¡è¦ºã€‚', 'æ˜¨å¤©ä¸‹åˆä¸‹äº†ä¸€å ´å¤§é›·é›¨ã€‚',
                'ä»–çš„èƒŒåŒ…æ˜¯è—è‰²çš„ã€‚', 'è·¯é‚Šé–‹æ»¿äº†ç¾éº—çš„èŠ±æœµã€‚', 'è½èªªæ˜å¤©å­¸æ ¡è¦èˆ‰è¾¦é‹å‹•æœƒã€‚', 'ä»–æ—©é¤åƒäº†ä¸€å€‹ä¸‰æ˜æ²»å’Œä¸€æ¯ç‰›å¥¶ã€‚'
            ],
            items: [
                { name: 'é‡‘å¹£', emoji: 'ğŸ’°', unit: 'æš' }, { name: 'é­”æ³•çŸ³', emoji: 'ğŸ’', unit: 'é¡†' },
                { name: 'è˜‹æœ', emoji: 'ğŸ', unit: 'é¡†' }, { name: 'é¤…ä¹¾', emoji: 'ğŸª', unit: 'ç‰‡' }
            ],
            containers: [
                { name: 'å¯¶ç®±', emoji: 'ğŸ§°', action: 'è£é€²', unit: 'å€‹' }, { name: 'é­”æ³•è¢‹', emoji: 'ğŸ‘', action: 'æ”¾é€²', unit: 'è¢‹' },
                { name: 'ç±ƒå­', emoji: 'ğŸ§º', action: 'æ”¾é€²', unit: 'ç±ƒ' }, { name: 'ç›’å­', emoji: 'ğŸ', action: 'è£é€²', unit: 'ç›’' }
            ],
            allUnits: ['æš', 'é¡†', 'ç‰‡', 'å€‹', 'è¢‹', 'ç±ƒ', 'ç›’', 'äºº', 'ç®±', 'æœ¬', 'è¼›', 'å…ƒ']
        };

        // ==========================================
        // 2. ä¸»æ‡‰ç”¨ç¨‹å¼ (App Router & Sidebar Layout)
        // ==========================================
        function App() {
            const [theme, setTheme] = useState('missions');

            const menuItems = [
                { id: 'guide', icon: 'ğŸ“–', title: 'é™¤æ³•ç§˜ç¬ˆ', desc: 'åœ–è§£ç­‰åˆ†é™¤ã€åŒ…å«é™¤èˆ‡é¤˜æ•¸' },
                { id: 'missions', icon: 'ğŸ¯', title: 'ä»»å‹™æŒ‘æˆ°', desc: 'æ‰‹å‹•æ‹–æ›³åˆ†é…ï¼Œç•«åœ–è§£é¡Œ' },
                { id: 'life', icon: 'ğŸŒ', title: 'ç”Ÿæ´»æƒ…å¢ƒ', desc: 'é€²ä¸€/å»å°¾æ³•èˆ‡è‡ªè¡Œå‡ºé¡Œ' },
                { id: 'challenge', icon: 'âš”ï¸', title: 'ç´ é¤Šå¤§æŒ‘æˆ°', desc: 'é›»è…¦è¼”åŠ©å°ˆæ³¨åˆ—å¼èˆ‡é‹ç®—' },
            ];

            return (
                <div className="flex flex-col md:flex-row h-full w-full bg-slate-100 font-sans text-slate-800 overflow-hidden">

                    <div className="w-full md:w-72 lg:w-80 bg-indigo-900 text-white flex flex-col shadow-2xl z-20 flex-shrink-0">
                        <div className="p-6 bg-indigo-950 shadow-md">
                            <h1 className="text-xl lg:text-2xl font-black tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 to-yellow-400 drop-shadow-sm leading-tight">
                                é™¤æ³•æ¢éšªå®¶(ä¸‰å¹´ç´š)
                            </h1>
                            <p className="text-indigo-300 text-xs mt-2 font-bold tracking-wide">åœ‹å°æ•¸å­¸äº’å‹•æ•™å­¸å¯¦é©—å®¤</p>
                        </div>

                        <nav className="flex-1 overflow-y-auto py-2 md:py-6 flex md:flex-col overflow-x-auto md:overflow-x-hidden hide-scrollbar">
                            {menuItems.map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => setTheme(item.id)}
                                    className={`flex-shrink-0 md:w-full text-left px-5 lg:px-6 py-4 flex flex-col transition-all border-b-4 md:border-b-0 md:border-l-4 relative group ${theme === item.id
                                        ? 'bg-indigo-800 border-yellow-400'
                                        : 'border-transparent hover:bg-indigo-800/60'
                                        }`}
                                >
                                    <div className="flex items-center gap-3 mb-1">
                                        <span className="text-2xl drop-shadow-sm">{item.icon}</span>
                                        <span className={`font-bold text-base lg:text-lg whitespace-nowrap ${theme === item.id ? 'text-white' : 'text-indigo-100 group-hover:text-white'}`}>
                                            {item.title}
                                        </span>
                                    </div>
                                    <span className={`text-xs md:pl-9 hidden md:block ${theme === item.id ? 'text-indigo-200' : 'text-indigo-300/70 group-hover:text-indigo-200'}`}>
                                        {item.desc}
                                    </span>
                                </button>
                            ))}
                        </nav>
                    </div>

                    <div className="flex-1 flex flex-col h-full overflow-hidden relative bg-slate-50">
                        <header className="bg-white p-4 md:px-8 md:py-5 shadow-sm z-10 flex items-center border-b border-slate-200">
                            <h2 className="text-2xl md:text-3xl font-black text-slate-800 flex items-center gap-3">
                                <span>{menuItems.find(i => i.id === theme)?.icon}</span>
                                {menuItems.find(i => i.id === theme)?.title}
                            </h2>
                        </header>

                        <main className="flex-1 overflow-y-auto p-4 md:p-8 relative">
                            <div key={theme} className="max-w-5xl mx-auto h-full pb-10">
                                {theme === 'guide' && <ThemeGuide />}
                                {theme === 'missions' && <ThemeMissions />}
                                {theme === 'life' && <ThemeLife />}
                                {theme === 'challenge' && <ThemeChallenge />}
                            </div>
                        </main>
                    </div>
                </div>
            );
        }

        // ==========================================
        // 3. ä¸»é¡Œä¸€ï¼šé™¤æ³•ç§˜ç¬ˆ 
        // ==========================================
        function ThemeGuide() {
            return (
                <div className="animate-fade-in space-y-10">
                    <div className="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                        <h2 className="bg-indigo-100 text-indigo-800 text-2xl font-black p-4 px-6 border-b border-indigo-200 flex items-center gap-2">
                            <span>ğŸ”</span> é­”æ³•ä¸€ï¼šå…©ç¨®ä¸åŒçš„åˆ†é…æ–¹å¼
                        </h2>
                        <div className="p-6 grid md:grid-cols-2 gap-8">
                            <div className="bg-blue-50 p-6 rounded-2xl border-2 border-blue-200">
                                <h3 className="text-xl font-bold text-blue-800 mb-3 flex items-center justify-between">
                                    <span>ç­‰åˆ†é™¤ (åˆ†çµ¦èª°)</span>
                                    <span className="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded-full">å·²çŸ¥ä»½æ•¸ï¼Œæ±‚æ¯ä»½å¤šå°‘</span>
                                </h3>
                                <p className="text-slate-600 text-sm mb-4">é—œéµå­—ï¼š<strong className="text-red-500">ã€Œå¹³å‡åˆ†çµ¦ã€ã€ã€Œå¹³åˆ†ã€</strong></p>
                                <div className="bg-white p-4 rounded-xl shadow-inner text-center border border-blue-100 mb-4">
                                    <p className="font-bold mb-2 text-slate-700">12é¡†è˜‹æœï¼Œå¹³åˆ†çµ¦3éš»å…”å­</p>
                                    <div className="flex justify-center gap-4">
                                        <div className="text-center text-3xl">ğŸ°<br /><span className="text-sm">ğŸğŸğŸğŸ</span></div>
                                        <div className="text-center text-3xl">ğŸ°<br /><span className="text-sm">ğŸğŸğŸğŸ</span></div>
                                        <div className="text-center text-3xl">ğŸ°<br /><span className="text-sm">ğŸğŸğŸğŸ</span></div>
                                    </div>
                                </div>
                                <p className="text-center font-bold text-blue-900 bg-blue-100 py-2 rounded-lg">ç®—å¼ï¼š12 Ã· 3 = 4 (é¡†/éš»)</p>
                            </div>

                            <div className="bg-purple-50 p-6 rounded-2xl border-2 border-purple-200">
                                <h3 className="text-xl font-bold text-purple-800 mb-3 flex items-center justify-between">
                                    <span>åŒ…å«é™¤ (è£å¹¾è¢‹)</span>
                                    <span className="text-xs bg-purple-200 text-purple-800 px-2 py-1 rounded-full">å·²çŸ¥æ¯ä»½æ•¸é‡ï¼Œæ±‚ç¸½ä»½æ•¸</span>
                                </h3>
                                <p className="text-slate-600 text-sm mb-4">é—œéµå­—ï¼š<strong className="text-red-500">ã€Œæ¯...è£ä¸€è¢‹ã€ã€ã€Œæ¯...ç¶ä¸€æ†ã€</strong></p>
                                <div className="bg-white p-4 rounded-xl shadow-inner text-center border border-purple-100 mb-4">
                                    <p className="font-bold mb-2 text-slate-700">12é¡†è˜‹æœï¼Œæ¯4é¡†è£ä¸€è¢‹</p>
                                    <div className="flex justify-center gap-4 py-2">
                                        <div className="border-2 border-dashed border-purple-400 rounded-lg p-1 text-sm bg-purple-50">ğŸğŸğŸğŸ</div>
                                        <div className="border-2 border-dashed border-purple-400 rounded-lg p-1 text-sm bg-purple-50">ğŸğŸğŸğŸ</div>
                                        <div className="border-2 border-dashed border-purple-400 rounded-lg p-1 text-sm bg-purple-50">ğŸğŸğŸğŸ</div>
                                    </div>
                                </div>
                                <p className="text-center font-bold text-purple-900 bg-purple-100 py-2 rounded-lg">ç®—å¼ï¼š12 Ã· 4 = 3 (è¢‹)</p>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                        <h2 className="bg-amber-100 text-amber-800 text-2xl font-black p-4 px-6 border-b border-amber-200 flex items-center gap-2">
                            <span>âœ¨</span> é­”æ³•äºŒï¼šä»€éº¼æ˜¯ã€Œé¤˜æ•¸ã€ï¼Ÿ
                        </h2>
                        <div className="p-6 flex flex-col md:flex-row gap-8 items-center">
                            <div className="flex-1">
                                <p className="text-lg text-slate-700 leading-relaxed mb-4">
                                    ç•¶æ±è¥¿æ²’è¾¦æ³•ã€Œå‰›å‰›å¥½åˆ†å®Œã€æˆ–ã€Œè£æ»¿ã€ï¼Œå‰©ä¸‹çš„éƒ¨åˆ†å°±å«åš<strong>é¤˜æ•¸</strong>ã€‚
                                </p>
                                <div className="bg-red-50 border-l-4 border-red-500 p-4 rounded-r-xl">
                                    <h4 className="font-bold text-red-700 mb-1">âš ï¸ éµå¾‹ï¼šé¤˜æ•¸å¿…é ˆå°æ–¼é™¤æ•¸ï¼</h4>
                                    <p className="text-sm text-red-600">å¦‚æœå‰©ä¸‹çš„æ±è¥¿æ¯”ã€Œé™¤æ•¸ã€é‚„è¦å¤§ï¼Œä»£è¡¨ä½ é‚„å¯ä»¥ç¹¼çºŒåˆ†å–”ï¼</p>
                                </div>
                            </div>
                            <div className="bg-slate-50 p-6 rounded-2xl border-2 border-slate-200 text-center shadow-inner min-w-[300px]">
                                <p className="font-bold mb-4 text-lg text-slate-700">14 é¡†è˜‹æœï¼Œæ¯ 4 é¡†è£ä¸€è¢‹</p>
                                <div className="flex justify-center gap-2 mb-4">
                                    <div className="border-2 border-slate-300 rounded p-1 text-sm bg-white">ğŸğŸğŸğŸ</div>
                                    <div className="border-2 border-slate-300 rounded p-1 text-sm bg-white">ğŸğŸğŸğŸ</div>
                                    <div className="border-2 border-slate-300 rounded p-1 text-sm bg-white">ğŸğŸğŸğŸ</div>
                                </div>
                                <div className="flex justify-center gap-2 items-center mb-5 text-red-500 font-bold">
                                    <span>å‰©ä¸‹ï¼š</span><div className="p-1 text-sm bg-red-100 border border-red-200 rounded animate-pulse">ğŸğŸ</div>
                                </div>
                                <p className="text-amber-700 font-black text-xl bg-amber-100 py-2 rounded-lg tracking-widest">14 Ã· 4 = 3 ... 2</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ==========================================
        // 4. ä¸»é¡ŒäºŒï¼šä»»å‹™æŒ‘æˆ°
        // ==========================================
        function ThemeMissions() {
            const [currentIdx, setCurrentIdx] = useState(null);
            const [step, setStep] = useState(0);
            const [crossedOut, setCrossedOut] = useState([]);

            const startProblem = (idx) => {
                setCurrentIdx(idx);
                setCrossedOut(Array(MISSIONS[idx].story.length).fill(false));
                setStep(1);
            };
            const nextStep = () => setStep(s => s + 1);

            if (step === 0) {
                return (
                    <div className="animate-fade-in">
                        <div className="bg-indigo-50 p-6 rounded-2xl border border-indigo-100 mb-8 flex flex-col md:flex-row gap-4 justify-between items-center shadow-inner">
                            <div>
                                <h3 className="text-xl font-bold text-indigo-800 mb-2">è«‹é¸æ“‡ä½ çš„è©¦ç…‰ï¼š</h3>
                                <p className="text-slate-600 font-medium text-sm">è¦ªè‡ªæ‹–æ›³åˆ†é…ç‰©ä»¶ï¼Œç•«å‡ºæ­£ç¢ºçš„æ•¸å­¸åœ–è§£ï¼</p>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                            {MISSIONS.map((p, idx) => (
                                <button key={p.id} onClick={() => startProblem(idx)} className="bg-white p-6 rounded-2xl shadow-sm border-2 border-slate-200 hover:border-green-500 hover:shadow-lg transition-all text-center flex flex-col items-center group">
                                    <span className="text-5xl mb-4 group-hover:scale-110 transition-transform">{p.itemEmoji}</span>
                                    <span className={`text-xs font-bold px-3 py-1 rounded-full mb-3 shadow-inner ${p.remainder > 0 ? 'bg-amber-100 text-amber-800' : 'bg-slate-100 text-slate-600'}`}>
                                        {p.remainder > 0 ? 'é€²éš(æœ‰é¤˜æ•¸)' : 'åŸºç¤'}
                                    </span>
                                    <h3 className="text-sm font-bold text-slate-800">{p.title}</h3>
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }

            const problem = MISSIONS[currentIdx];

            return (
                <div className="flex flex-col h-full animate-fade-in relative pb-10">
                    <button onClick={() => setStep(0)} className="absolute top-0 right-0 text-slate-400 hover:text-slate-600 font-bold bg-white px-4 py-2 rounded-lg border border-slate-200 shadow-sm transition-colors z-10">
                        âœ– è¿”å›é¸å–®
                    </button>

                    <div className="w-full pt-4">
                        {step === 1 && <DenoiseStep problem={problem} initialSelections={crossedOut} onComplete={(sel) => { setCrossedOut(sel); nextStep(); }} />}
                        {step === 2 && <ModelStep problem={problem} crossedOut={crossedOut} onComplete={nextStep} />}
                        {step === 3 && <CalculateStep problem={problem} crossedOut={crossedOut} onComplete={nextStep} />}
                        {step === 4 && (
                            <div className="text-center py-20 animate-fade-in bg-white rounded-3xl shadow-sm border-2 border-green-300 mt-8">
                                <div className="text-8xl mb-6 drop-shadow-md">ğŸ‰</div>
                                <h2 className="text-4xl font-black text-green-600 mb-4">ä»»å‹™å¤§æˆåŠŸï¼</h2>
                                <p className="text-xl text-slate-600 mb-8">ä½ å®Œç¾ç ´é—œäº†ã€{problem.title}ã€‘ï¼</p>
                                <button onClick={() => setStep(0)} className="bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-10 rounded-full text-xl shadow-lg transition-transform active:scale-95">
                                    æŒ‘æˆ°å…¶ä»–ä»»å‹™
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function ProblemText({ story, crossedOut, interactive = false, onToggle = null }) {
            return (
                <div className="bg-white p-6 rounded-2xl shadow-sm border-l-8 border-indigo-400 mb-6">
                    <div className="text-lg md:text-xl leading-relaxed font-medium select-none">
                        {story.map((part, idx) => {
                            const isCrossed = crossedOut[idx];
                            return (
                                <span key={idx} onClick={() => interactive && onToggle(idx)} className={`
                  transition-all duration-200 px-1 py-1 rounded-lg mx-0.5 inline-block mb-1
                  ${interactive ? 'cursor-pointer hover:bg-indigo-50' : ''}
                  ${isCrossed ? 'bg-slate-200 text-slate-400 line-through decoration-red-500 decoration-4' : 'text-slate-800'}
                  ${part.highlight && !isCrossed ? 'bg-yellow-100 border-b-4 border-yellow-400 font-bold' : ''}
                  ${part.isKey && !isCrossed ? 'text-indigo-700 font-bold bg-indigo-50' : ''}
                `}>
                                    {part.text}
                                </span>
                            );
                        })}
                    </div>
                </div>
            );
        }

        function DenoiseStep({ problem, initialSelections, onComplete }) {
            const [selections, setSelections] = useState(initialSelections);
            const [errorMsg, setErrorMsg] = useState("");
            const toggleSelection = (idx) => { const newSel = [...selections]; newSel[idx] = !newSel[idx]; setSelections(newSel); setErrorMsg(""); };
            const checkAnswers = () => {
                const isCorrect = problem.story.every((part, idx) => (part.isNoise ? selections[idx] : !selections[idx]));
                if (isCorrect) onComplete(selections); else setErrorMsg("ä»”ç´°çœ‹å–”ï¼åªæœ‰ã€Œèˆ‡æ•¸å­—è¨ˆç®—ç„¡é—œã€çš„å»¢è©±æ‰éœ€è¦åŠƒæ‰ï¼");
            };
            return (
                <div className="animate-fade-in mt-4">
                    <h2 className="text-2xl font-bold text-slate-800 mb-4">ğŸ“ æ­¥é©Ÿä¸€ï¼šåŠƒæ‰å¹²æ“¾è³‡è¨Š</h2>
                    <ProblemText story={problem.story} crossedOut={selections} interactive={true} onToggle={toggleSelection} />
                    {errorMsg && <p className="text-red-500 font-bold mb-4 animate-bounce text-center bg-red-50 py-3 rounded-lg border border-red-200">{errorMsg}</p>}
                    <button onClick={checkAnswers} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-xl py-4 rounded-xl shadow-md transition-transform active:scale-95">æª¢æŸ¥ä¸¦é€²å…¥ä¸‹ä¸€æ­¥</button>
                </div>
            );
        }

        function ModelStep({ problem, crossedOut, onComplete }) {
            const isPartitive = problem.type === 'partitive';
            const [unassigned, setUnassigned] = useState(problem.total);
            const [containers, setContainers] = useState([]);
            const [selectedItem, setSelectedItem] = useState(false);
            const [error, setError] = useState('');

            const addContainer = () => {
                if (isPartitive && containers.length >= problem.divisor) {
                    setError(`ç­‰åˆ†é™¤åªè¦ ${problem.divisor} å€‹${problem.containerName}å°±å¤ å›‰ï¼`);
                    return;
                }
                setContainers([...containers, 0]);
                setError('');
            };

            const removeContainer = (index) => {
                if (containers[index] === 0) {
                    setContainers(prev => prev.filter((_, i) => i !== index));
                }
            };

            const handleDragStart = (e) => { e.dataTransfer.setData('action', 'move_item'); };

            const handleDropLogic = (index) => {
                if (unassigned > 0) {
                    if (!isPartitive && containers[index] >= problem.divisor) {
                        setError(`é€™${problem.containerName}å·²ç¶“è£æ»¿ ${problem.divisor} å€‹äº†ï¼`);
                        return;
                    }
                    setUnassigned(p => p - 1);
                    setContainers(prev => {
                        const next = [...prev];
                        next[index]++;
                        return next;
                    });
                    setError('');
                }
            };

            const handleDrop = (e, index) => {
                e.preventDefault();
                if (e.dataTransfer.getData('action') === 'move_item') {
                    handleDropLogic(index);
                }
            };

            const handleUnassignedClick = () => {
                if (unassigned > 0) setSelectedItem(!selectedItem);
            };

            const handleContainerClick = (index) => {
                if (selectedItem) {
                    handleDropLogic(index);
                    setSelectedItem(false);
                } else {
                    if (containers[index] > 0) {
                        setContainers(prev => {
                            const next = [...prev];
                            next[index]--;
                            return next;
                        });
                        setUnassigned(p => p + 1);
                        setError('');
                    } else {
                        removeContainer(index);
                    }
                }
            };

            const autoAction = () => {
                if (isPartitive) {
                    if (containers.length < problem.divisor) {
                        setError(`è«‹å…ˆæ–°å¢ ${problem.divisor} å€‹${problem.containerName}ï¼`);
                        return;
                    }
                    if (unassigned >= problem.divisor) {
                        setUnassigned(p => p - problem.divisor);
                        setContainers(prev => prev.map(c => c + 1));
                        setError('');
                    }
                } else {
                    if (unassigned >= problem.divisor) {
                        setContainers([...containers, problem.divisor]);
                        setUnassigned(p => p - problem.divisor);
                        setError('');
                    } else if (unassigned > 0) {
                        setContainers([...containers, unassigned]);
                        setUnassigned(0);
                        setError('');
                    }
                }
            };

            let helperMsg = "";
            let isSuccess = false;

            if (isPartitive) {
                if (containers.length < problem.divisor) {
                    helperMsg = `1ï¸âƒ£ è«‹å…ˆæ–°å¢ ${problem.divisor} å€‹${problem.containerName}ã€‚`;
                } else if (unassigned > problem.remainder) {
                    helperMsg = `2ï¸âƒ£ è«‹å°‡ä¸Šæ–¹çš„ ${problem.itemEmoji} é»é¸æˆ–æ‹–æ›³åˆ°${problem.containerName}ä¸­ï¼Œç›¡é‡å¹³åˆ†ã€‚`;
                } else if (unassigned < problem.remainder) {
                    helperMsg = `âš ï¸ å“å‘€ï¼Œä½ æŠŠé¤˜æ•¸ä¹Ÿåˆ†ä¸‹å»äº†ï¼Œåˆ†å¾—ä¸å¹³å‡å–”ï¼é»æ“Š${problem.containerName}æŠŠå¤šå‡ºä¾†çš„é€€å›å»ã€‚`;
                } else if (!containers.every(c => c === problem.quotient)) {
                    helperMsg = `âš ï¸ æ•¸é‡ä¸ä¸€æ¨£å–”ï¼ç­‰åˆ†é™¤å¿…é ˆè®“å¤§å®¶ä¸€æ¨£å¤šã€‚é»æ“Šå®¹å™¨èª¿æ•´ã€‚`;
                } else {
                    helperMsg = problem.remainder > 0
                        ? `ğŸ‰ å®Œç¾å¹³åˆ†ï¼å‰©ä¸‹ ${unassigned} å€‹ä¸å¤ åˆ†äº† (é€™å°±æ˜¯é¤˜æ•¸)ã€‚`
                        : `ğŸ‰ å®Œç¾å¹³åˆ†ï¼æ²’æœ‰å‰©ä¸‹ä»»ä½•æ±è¥¿ã€‚`;
                    isSuccess = true;
                }
            } else {
                if (containers.length === 0) {
                    helperMsg = `1ï¸âƒ£ è«‹é»æ“Šã€Œæ–°å¢${problem.containerName}ã€é–‹å§‹è£è¢‹ã€‚`;
                } else if (containers.some(c => c > 0 && c < problem.divisor) && unassigned === 0) {
                    helperMsg = `âš ï¸ æœ‰${problem.containerName}æ²’æœ‰è£æ»¿å–”ï¼ä¸å¤ è£çš„è¦æ‹¿å‡ºä¾†æ”¾åœ¨å¤–é¢ç•¶ä½œã€Œé¤˜æ•¸ã€ã€‚`;
                } else if (unassigned >= problem.divisor) {
                    helperMsg = `2ï¸âƒ£ é‚„æœ‰ ${unassigned} å€‹ï¼Œé»é¸æˆ–æ‹–æ›³ ${problem.itemEmoji} æ”¾é€²å»è£æ»¿ã€‚`;
                } else {
                    if (containers.every(c => c === problem.divisor) && unassigned === problem.remainder && containers.length === problem.quotient) {
                        helperMsg = problem.remainder > 0
                            ? `ğŸ‰ å®Œç¾è£è¢‹ï¼å‰©ä¸‹ ${unassigned} å€‹ä¸å¤ è£ä¸€è¢‹ (é€™å°±æ˜¯é¤˜æ•¸)ã€‚`
                            : `ğŸ‰ å®Œç¾è£è¢‹ï¼å…¨éƒ¨è£å¾—å‰›å‰›å¥½ã€‚`;
                        isSuccess = true;
                    } else {
                        helperMsg = `è«‹ç¹¼çºŒæ–°å¢${problem.containerName}ï¼Œç›´åˆ°ç„¡æ³•å†è£æ»¿ç‚ºæ­¢ã€‚`;
                    }
                }
            }

            return (
                <div className="animate-fade-in flex flex-col mt-4">
                    <h2 className="text-2xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                        ğŸ“ æ­¥é©ŸäºŒï¼šå‹•æ‰‹ç•«åœ– ({isPartitive ? 'ç­‰åˆ†é™¤' : 'åŒ…å«é™¤'})
                    </h2>
                    <ProblemText story={problem.story} crossedOut={crossedOut} />

                    <div className="bg-white p-6 md:p-8 rounded-3xl shadow-sm border-2 border-slate-200 flex flex-col items-center">

                        <div className={`w-full p-4 rounded-xl font-bold text-center mb-6 transition-colors shadow-inner flex items-center justify-center gap-2 ${isSuccess ? 'bg-green-100 text-green-800 border border-green-300' : 'bg-indigo-50 text-indigo-800 border border-indigo-200'}`}>
                            <span>{isSuccess ? 'âœ…' : 'ğŸ’¡'}</span> {helperMsg}
                        </div>

                        <div
                            className={`min-h-[120px] w-full rounded-2xl p-4 flex flex-wrap justify-center items-center gap-2 border-4 border-dashed mb-8 transition-colors cursor-pointer select-none
                ${selectedItem ? 'border-yellow-400 bg-yellow-50' : (unassigned > 0 ? 'border-slate-300 bg-slate-50 hover:bg-slate-100' : 'border-slate-200 bg-slate-50 opacity-50')}`}
                            onClick={handleUnassignedClick}
                        >
                            {unassigned > 0 && !selectedItem && (
                                <div className="w-full text-center text-slate-400 text-sm font-bold mb-2">é»æ“Šé¸å–ï¼Œæˆ–ç›´æ¥æ‹–æ›³ ğŸ‘‡</div>
                            )}
                            {Array.from({ length: unassigned }).map((_, i) => (
                                <span
                                    key={`u-${i}`}
                                    draggable
                                    onDragStart={handleDragStart}
                                    className={`text-4xl transition-transform ${selectedItem ? 'scale-110 drop-shadow-md animate-pulse' : 'hover:scale-110 cursor-grab active:cursor-grabbing'}`}
                                >
                                    {problem.itemEmoji}
                                </span>
                            ))}
                            {unassigned === 0 && <span className="text-slate-400 font-bold text-xl">å…¨éƒ¨åˆ†é…å®Œç•¢ï¼</span>}
                        </div>

                        <div className="flex flex-wrap gap-4 w-full justify-center mb-8 border-b border-slate-100 pb-8">
                            <button
                                onClick={addContainer}
                                className={`font-bold py-3 px-6 rounded-xl shadow-sm transition-transform active:scale-95 flex items-center gap-2 ${isPartitive && containers.length >= problem.divisor ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 'bg-indigo-500 hover:bg-indigo-600 text-white'}`}
                                disabled={isPartitive && containers.length >= problem.divisor}
                            >
                                <span>â•</span> æ–°å¢ {problem.containerName}
                            </button>

                            <button onClick={autoAction} className="bg-amber-400 hover:bg-amber-500 text-amber-900 font-bold py-3 px-6 rounded-xl shadow-sm transition-transform active:scale-95 flex items-center gap-2">
                                <span>âš¡</span> è‡ªå‹•{isPartitive ? 'ç™¼é€ 1 è¼ª' : 'è£æ»¿ 1 è¢‹'}
                            </button>
                        </div>

                        {error && <p className="text-red-500 font-bold mb-4 animate-bounce bg-red-50 px-4 py-2 rounded-lg">{error}</p>}

                        <div className="flex flex-wrap justify-center gap-6 w-full mb-8 min-h-[160px]">
                            {containers.length === 0 && (
                                <div className="text-slate-400 font-bold flex items-center justify-center w-full h-32 border-2 border-dashed border-slate-200 rounded-xl">
                                    è«‹å…ˆé»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢å®¹å™¨
                                </div>
                            )}
                            {containers.map((count, i) => {
                                const isFull = !isPartitive && count === problem.divisor;
                                return (
                                    <div
                                        key={i}
                                        onDragOver={(e) => e.preventDefault()}
                                        onDrop={(e) => handleDrop(e, i)}
                                        onClick={() => handleContainerClick(i)}
                                        className={`flex flex-col items-center p-4 rounded-2xl border-4 min-w-[120px] transition-all relative select-none
                      ${selectedItem ? 'cursor-cell ring-4 ring-yellow-200 border-yellow-400 bg-yellow-50 shadow-lg scale-105' : 'cursor-pointer hover:border-indigo-400 shadow-sm'}
                      ${isFull ? 'bg-green-50 border-green-400' : (selectedItem ? '' : 'bg-white border-slate-200')}
                    `}
                                    >
                                        {!selectedItem && count === 0 && (
                                            <div className="absolute top-1 right-2 text-slate-300 hover:text-red-500 text-xs font-bold">âœ– ç§»é™¤</div>
                                        )}
                                        <span className="text-5xl mb-2 z-10">{problem.containerEmoji}</span>
                                        <div className="flex flex-wrap justify-center gap-1 min-h-[40px] z-10 w-24">
                                            {Array.from({ length: count }).map((_, j) => (<span key={`c-${i}-${j}`} className="text-2xl pointer-events-none animate-fade-in">{problem.itemEmoji}</span>))}
                                        </div>
                                        <div className={`mt-3 px-3 py-1 rounded-lg text-sm font-bold z-10 ${isFull ? 'bg-green-200 text-green-800' : 'bg-slate-100 text-slate-600'}`}>
                                            {count} {isPartitive ? '' : `/ ${problem.divisor}`}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        {isSuccess && (
                            <button onClick={onComplete} className="bg-green-500 hover:bg-green-600 text-white font-bold text-2xl py-4 px-12 rounded-full shadow-lg animate-bounce mt-4">
                                âœ… ç•«åœ–å®Œæˆï¼Œé€²å…¥è¨ˆç®—ï¼
                            </button>
                        )}
                    </div>
                </div>
            );
        }

        function CalculateStep({ problem, crossedOut, onComplete }) {
            const [vals, setVals] = useState({ v1: '', v2: '', v3: '', v4: '' });
            const [errorMsg, setErrorMsg] = useState('');

            const check = () => {
                const v1 = parseInt(vals.v1); const v2 = parseInt(vals.v2);
                const v3 = parseInt(vals.v3); const v4 = parseInt(vals.v4) || 0;
                if (v1 === problem.total && v2 === problem.divisor && v3 === problem.quotient && v4 === problem.remainder) onComplete();
                else setErrorMsg("ç®—å¼éŒ¯èª¤ï¼å£è¨£ï¼šç¸½æ•¸é‡ Ã· æ¢ä»¶ = ç­”æ¡ˆ ... é¤˜æ•¸ (è‹¥æ²’é¤˜æ•¸è«‹å¡« 0)");
            };

            return (
                <div className="animate-fade-in flex flex-col h-full mt-4">
                    <h2 className="text-2xl font-bold text-slate-800 mb-4">ğŸ“ æ­¥é©Ÿä¸‰ï¼šå¯«å‡ºé™¤æ³•ç®—å¼</h2>
                    <ProblemText story={problem.story} crossedOut={crossedOut} />

                    {/* å¥—ç”¨ focus-container èˆ‡ onKeyDown é‚è¼¯ */}
                    <div className="bg-white p-8 rounded-3xl shadow-sm border-2 border-slate-200 flex flex-col items-center focus-container">
                        <div className="bg-indigo-50 px-6 py-2 rounded-lg mb-8 text-indigo-800 font-bold border border-indigo-100">
                            æ ¹æ“šä½ å‰›å‰›ç•«çš„åœ–ï¼Œå¡«å‡ºæ­£ç¢ºçš„æ•¸å­¸ç®—å¼ï¼š
                        </div>

                        <div className="flex flex-wrap items-center justify-center gap-4 mb-8 text-2xl font-black text-slate-700 w-full">
                            <div className="flex flex-col items-center">
                                <input autoFocus type="number" onKeyDown={handleEnterFocusNext} value={vals.v1} onChange={e => setVals({ ...vals, v1: e.target.value })} className="w-20 h-20 text-center border-4 border-slate-200 rounded-2xl focus:border-indigo-500 bg-slate-50 outline-none" />
                                <span className="text-sm text-slate-500 mt-2 font-bold">ç¸½æ•¸</span>
                            </div>
                            <span className="mb-6">Ã·</span>
                            <div className="flex flex-col items-center">
                                <input type="number" onKeyDown={handleEnterFocusNext} value={vals.v2} onChange={e => setVals({ ...vals, v2: e.target.value })} className="w-20 h-20 text-center border-4 border-slate-200 rounded-2xl focus:border-blue-500 bg-slate-50 outline-none" />
                                <span className="text-sm text-slate-500 mt-2 font-bold">{problem.type === 'partitive' ? 'ä»½æ•¸' : 'æ¯è¢‹æ•¸é‡'}</span>
                            </div>
                            <span className="mb-6">=</span>
                            <div className="flex flex-col items-center">
                                <input type="number" onKeyDown={handleEnterFocusNext} value={vals.v3} onChange={e => setVals({ ...vals, v3: e.target.value })} className="w-20 h-20 text-center border-4 border-green-300 rounded-2xl focus:border-green-500 bg-green-50 text-green-700 outline-none" />
                                <span className="text-sm text-green-600 mt-2 font-bold">ç­”æ¡ˆ</span>
                            </div>
                            <span className="mb-6 tracking-widest text-slate-400">...</span>
                            <div className="flex flex-col items-center">
                                <input type="number" onKeyDown={handleEnterFocusNext} value={vals.v4} onChange={e => setVals({ ...vals, v4: e.target.value })} placeholder="0" className="w-20 h-20 text-center border-4 border-red-300 rounded-2xl focus:border-red-500 bg-red-50 text-red-600 outline-none" />
                                <span className="text-sm font-bold text-red-600 mt-2">é¤˜æ•¸</span>
                            </div>
                        </div>

                        {errorMsg && <p className="text-red-500 font-bold mb-6 bg-red-50 p-3 rounded-lg border border-red-200 shadow-sm">{errorMsg}</p>}
                        <button onClick={check} className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-xl py-4 px-16 rounded-full shadow-lg transition-transform active:scale-95">é€å‡ºè§£ç­”ï¼</button>
                    </div>
                </div>
            );
        }

        // ==========================================
        // 5. ä¸»é¡Œä¸‰ï¼šç”Ÿæ´»æƒ…å¢ƒ & äº’å‹•å‘½é¡Œ
        // ==========================================
        function ThemeLife() {
            const [mode, setMode] = useState('read');

            return (
                <div className="animate-fade-in">
                    <div className="flex justify-center gap-4 mb-8 bg-white p-2 rounded-full shadow-sm border border-slate-200 w-max mx-auto">
                        <button onClick={() => setMode('read')} className={`px-6 py-2 rounded-full font-bold transition-all ${mode === 'read' ? 'bg-amber-500 text-white shadow-md' : 'bg-transparent text-slate-500 hover:bg-slate-100'}`}>
                            ğŸ“– é–±è®€ç”Ÿæ´»æƒ…å¢ƒ
                        </button>
                        <button onClick={() => setMode('create')} className={`px-6 py-2 rounded-full font-bold transition-all ${mode === 'create' ? 'bg-amber-500 text-white shadow-md' : 'bg-transparent text-slate-500 hover:bg-slate-100'}`}>
                            âœï¸ å°å°å‡ºé¡Œå®¶ (è‡ªè¨‚)
                        </button>
                    </div>
                    {mode === 'read' ? <LifeScenarios /> : <LifeProblemBuilder />}
                </div>
            );
        }

        function LifeScenarios() {
            const scenarios = [
                {
                    title: 'æ­è¨ˆç¨‹è»Š (é¤˜æ•¸é€²ä¸€æ³•)', desc: '14 å€‹å°æœ‹å‹è¦å»åšç‰©é¤¨ï¼Œä¸€è¼›è¨ˆç¨‹è»Šæœ€å¤šåªèƒ½è¼‰ 4 å€‹äººã€‚ç¸½å…±éœ€è¦å«å¹¾è¼›è»Šï¼Ÿ',
                    calc: '14 Ã· 4 = 3 ... 2', explain: 'ç®—å‡ºä¾†æ˜¯ 3 è¼›è»Šï¼Œä½†å‰©ä¸‹ 2 å€‹äººä¸èƒ½è‡ªå·±è·‘å»ï¼', conclusion: 'å¿…é ˆå†å¤šå« 1 è¼›è»Šã€‚ç­”æ¡ˆæ˜¯ï¼š4 è¼›è¨ˆç¨‹è»Š', bgColor: 'bg-blue-50', borderColor: 'border-blue-200', icon: 'ğŸš•'
                },
                {
                    title: 'è²·ç­†è¨˜æœ¬ (é¤˜æ•¸å»å°¾æ³•)', desc: 'å°æ™ºæœ‰ 50 å…ƒï¼Œä¸€æœ¬ç­†è¨˜æœ¬ 15 å…ƒã€‚æœ€å¤šå¯ä»¥è²·å¹¾æœ¬ï¼Ÿ',
                    calc: '50 Ã· 15 = 3 ... 5', explain: 'å¯ä»¥è²· 3 æœ¬ï¼Œå‰©ä¸‹ 5 å…ƒä¸å¤ å†è²·ä¸€æœ¬äº†ã€‚', conclusion: 'å‰©ä¸‹çš„éŒ¢åªèƒ½æ”¶èµ·ä¾†ã€‚ç­”æ¡ˆæ˜¯ï¼šæœ€å¤šè²· 3 æœ¬', bgColor: 'bg-green-50', borderColor: 'border-green-200', icon: 'ğŸ““'
                },
                {
                    title: 'æ­çºœè»Š (é¤˜æ•¸é€²ä¸€æ³•)', desc: '34 ä½éŠå®¢è¦æ­ä¹˜é«˜å±±çºœè»Šï¼Œæ¯å°çºœè»Šè¦å®šå 8 äººã€‚è«‹å•è‡³å°‘éœ€è¦å¹¾å°çºœè»Šæ‰å¤ ï¼Ÿ',
                    calc: '34 Ã· 8 = 4 ... 2', explain: '4 å°çºœè»Šè¼‰äº† 32 äººï¼Œå‰©ä¸‹çš„ 2 äººä¹Ÿè¦æ­ä¹˜ã€‚', conclusion: 'å¿…é ˆå¤šæº–å‚™ 1 å°çºœè»Šã€‚ç­”æ¡ˆæ˜¯ï¼š5 å°çºœè»Š', bgColor: 'bg-purple-50', borderColor: 'border-purple-200', icon: 'ğŸš '
                },
                {
                    title: 'è£è£½ç·å¸¶ (é¤˜æ•¸å»å°¾æ³•)', desc: 'æœ‰ä¸€æ¢é•· 25 å…¬å°ºçš„ç·å¸¶ï¼Œæ¯ 3 å…¬å°ºå‰ªæˆä¸€æ®µä¾†åŒ…è£ç¦®ç‰©ã€‚æœ€å¤šå¯ä»¥å‰ªå‡ºå¹¾æ®µï¼Ÿ',
                    calc: '25 Ã· 3 = 8 ... 1', explain: 'å‰ªå‡º 8 æ®µå¾Œï¼Œå‰©ä¸‹ 1 å…¬å°ºï¼Œä¸å¤ åŒ…è£ä¸€å€‹ç¦®ç‰©ã€‚', conclusion: 'å‰©ä¸‹çš„ç·å¸¶ç„¡æ³•ä½¿ç”¨ã€‚ç­”æ¡ˆæ˜¯ï¼šæœ€å¤š 8 æ®µ', bgColor: 'bg-pink-50', borderColor: 'border-pink-200', icon: 'ğŸ€'
                }
            ];
            return (
                <div className="grid md:grid-cols-2 gap-8 animate-fade-in">
                    {scenarios.map((sc, i) => (
                        <div key={i} className={`rounded-3xl p-8 border-4 shadow-sm flex flex-col ${sc.bgColor} ${sc.borderColor}`}>
                            <div className="text-6xl mb-4">{sc.icon}</div>
                            <h3 className="text-2xl font-bold text-slate-800 mb-4">{sc.title}</h3>
                            <p className="text-slate-700 text-lg mb-6 flex-1 leading-relaxed">{sc.desc}</p>
                            <div className="bg-white p-4 rounded-xl shadow-inner mb-4 text-center border border-slate-100">
                                <p className="font-mono text-xl font-bold text-indigo-700 mb-2">{sc.calc}</p>
                                <p className="text-slate-600 text-sm font-medium">{sc.explain}</p>
                            </div>
                            <p className="font-bold text-lg text-slate-800 border-t-2 border-slate-200/50 pt-4 text-center mt-auto">ğŸ’¡ {sc.conclusion}</p>
                        </div>
                    ))}
                </div>
            );
        }

        function LifeProblemBuilder() {
            const [total, setTotal] = useState('');
            const [divisor, setDivisor] = useState('');
            const [type, setType] = useState('partitive');
            const [itemObj, setItemObj] = useState(JSON.stringify({ name: 'ç³–æœ', emoji: 'ğŸ¬', unit: 'é¡†' }));
            const [targetObj, setTargetObj] = useState(JSON.stringify({ name: 'æœ‹å‹', emoji: 'ğŸ‘¦', unit: 'äºº' }));
            const [validateMsg, setValidateMsg] = useState(null);
            const [solution, setSolution] = useState(null);

            const items = [
                { name: 'ç³–æœ', emoji: 'ğŸ¬', unit: 'é¡†' }, { name: 'è˜‹æœ', emoji: 'ğŸ', unit: 'é¡†' },
                { name: 'é‡‘å¹£', emoji: 'ğŸ’°', unit: 'æš' }, { name: 'è²¼ç´™', emoji: 'ğŸŒŸ', unit: 'å¼µ' },
                { name: 'ç©æœ¨', emoji: 'ğŸ§±', unit: 'å¡Š' }, { name: 'é¤…ä¹¾', emoji: 'ğŸª', unit: 'ç‰‡' }
            ];
            const partitiveTargets = [
                { name: 'æœ‹å‹', emoji: 'ğŸ‘¦', unit: 'äºº' }, { name: 'å­¸ç”Ÿ', emoji: 'ğŸ‘§', unit: 'äºº' },
                { name: 'å°ç‹—', emoji: 'ğŸ¶', unit: 'éš»' }, { name: 'ç®±å­', emoji: 'ğŸ“¦', unit: 'å€‹' }
            ];
            const quotitiveTargets = [
                { name: 'è¢‹', emoji: 'ğŸ›ï¸', unit: 'è¢‹' }, { name: 'ç›’', emoji: 'ğŸ', unit: 'ç›’' },
                { name: 'ç®±', emoji: 'ğŸ“¦', unit: 'ç®±' }, { name: 'åŒ…', emoji: 'ğŸ’', unit: 'åŒ…' }
            ];

            useEffect(() => {
                if (type === 'partitive') setTargetObj(JSON.stringify(partitiveTargets[0]));
                else setTargetObj(JSON.stringify(quotitiveTargets[0]));
            }, [type]);

            const handleCheck = () => {
                const t = parseInt(total); const d = parseInt(divisor);
                if (isNaN(t) || isNaN(d)) { setValidateMsg({ ok: false, text: 'è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—ï¼' }); return; }
                if (t <= 0 || d <= 0) { setValidateMsg({ ok: false, text: 'æ•¸é‡ä¸èƒ½æ˜¯ 0 æˆ–è² æ•¸å–”ï¼' }); return; }
                if (d > t) { setValidateMsg({ ok: false, text: 'é™¤æ•¸å¤§æ–¼ç¸½é‡äº†ï¼Œé€™æ¨£æ ¹æœ¬åˆ†ä¸äº†å–”ï¼Œè«‹ä¿®æ”¹ï¼' }); return; }
                if (t > 500) { setValidateMsg({ ok: false, text: 'æ•¸å­—å¤ªå¤§äº†ï¼ˆè¶…é500ï¼‰ï¼Œè«‹å‡ºé©åˆä¸‰å¹´ç´šçš„é¡Œç›®ï¼' }); return; }

                setValidateMsg({ ok: true, text: 'é¡Œç›®å¾ˆåˆç†ï¼è«‹çœ‹ä¸‹æ–¹çš„è§£ç­”èˆ‡åœ–è§£ï¼š' });
                setSolution({ q: Math.floor(t / d), r: t % d, t, d });
            };

            const parsedItem = JSON.parse(itemObj);
            const parsedTarget = JSON.parse(targetObj);

            return (
                // å¥—ç”¨ focus-container
                <div className="bg-white p-8 rounded-3xl shadow-sm border-2 border-slate-200 animate-fade-in focus-container">
                    <h2 className="text-2xl font-bold text-indigo-800 mb-6 flex items-center gap-2"><span>âš™ï¸</span> ç¬¬ä¸€æ­¥ï¼šè¨­å®šä½ çš„é¡Œç›®</h2>

                    <div className="space-y-6 bg-slate-50 p-6 rounded-2xl border border-slate-200">
                        <div className="flex flex-wrap items-center gap-4 text-lg">
                            <label className="font-bold text-slate-600">æˆ‘æœ‰</label>
                            {/* è‡ªå‹•èšç„¦ */}
                            <input autoFocus onKeyDown={handleEnterFocusNext} type="number" value={total} onChange={e => { setTotal(e.target.value); setSolution(null); }} className="w-24 p-2 border-2 rounded-lg text-center font-bold focus:border-indigo-500 outline-none shadow-inner" placeholder="ç¸½æ•¸" />
                            <label className="font-bold text-slate-600">å€‹ (æˆ–å¼µ/ç‰‡/æš)</label>
                            {/* åŠ å…¥ Enter å°èˆªåˆ° Select */}
                            <select onKeyDown={handleEnterFocusNext} value={itemObj} onChange={e => { setItemObj(e.target.value); setSolution(null); }} className="p-2 border-2 rounded-lg font-bold bg-white outline-none focus:border-indigo-500">
                                {items.map(item => <option key={item.name} value={JSON.stringify(item)}>{item.emoji} {item.name}</option>)}
                            </select>
                        </div>

                        <div className="flex flex-wrap items-center gap-4 text-lg">
                            <label className="font-bold text-slate-600">æˆ‘æƒ³è¦</label>
                            {/* åŠ å…¥ Enter å°èˆªåˆ° Select */}
                            <select onKeyDown={handleEnterFocusNext} value={type} onChange={e => { setType(e.target.value); setSolution(null); }} className="p-2 border-2 rounded-lg font-bold bg-indigo-50 text-indigo-800 outline-none focus:border-indigo-500">
                                <option value="partitive">å¹³å‡åˆ†çµ¦</option>
                                <option value="quotitive">æ¯å¹¾å€‹è£æˆä¸€</option>
                            </select>

                            {type === 'partitive' ? (
                                <React.Fragment>
                                    {/* Enter å°èˆª */}
                                    <input type="number" onKeyDown={handleEnterFocusNext} value={divisor} onChange={e => { setDivisor(e.target.value); setSolution(null); }} className="w-24 p-2 border-2 rounded-lg text-center font-bold focus:border-indigo-500 outline-none shadow-inner" placeholder="æ¢ä»¶" />
                                    <label className="font-bold text-slate-600">å€‹ (æˆ–éš»/ä½)</label>
                                    {/* åŠ å…¥ Enter å°èˆªåˆ° Select */}
                                    <select onKeyDown={handleEnterFocusNext} value={targetObj} onChange={e => { setTargetObj(e.target.value); setSolution(null); }} className="p-2 border-2 rounded-lg font-bold bg-white outline-none focus:border-indigo-500">
                                        {partitiveTargets.map(t => <option key={t.name} value={JSON.stringify(t)}>{t.emoji} {t.name}</option>)}
                                    </select>
                                </React.Fragment>
                            ) : (
                                <React.Fragment>
                                    {/* åŠ å…¥ Enter å°èˆªåˆ° Select */}
                                    <select onKeyDown={handleEnterFocusNext} value={targetObj} onChange={e => { setTargetObj(e.target.value); setSolution(null); }} className="p-2 border-2 rounded-lg font-bold bg-white outline-none focus:border-indigo-500">
                                        {quotitiveTargets.map(t => <option key={t.name} value={JSON.stringify(t)}>{t.emoji} {t.name}</option>)}
                                    </select>
                                    <label className="font-bold text-slate-600">ï¼Œæ¯{parsedTarget.name}æœ‰</label>
                                    {/* Enter å°èˆª */}
                                    <input type="number" onKeyDown={handleEnterFocusNext} value={divisor} onChange={e => { setDivisor(e.target.value); setSolution(null); }} className="w-24 p-2 border-2 rounded-lg text-center font-bold focus:border-indigo-500 outline-none shadow-inner" placeholder="æ¢ä»¶" />
                                    <label className="font-bold text-slate-600">{parsedItem.unit}</label>
                                </React.Fragment>
                            )}
                        </div>

                        <div className="flex flex-wrap items-center gap-4 text-lg font-bold text-slate-700 pt-6 border-t border-slate-200">
                            è«‹å•ï¼š<span className="text-indigo-600">{type === 'partitive' ? `æ¯å€‹${parsedTarget.name}åˆ†åˆ°å¹¾${parsedItem.unit}ï¼Ÿå‰©ä¸‹å¹¾${parsedItem.unit}ï¼Ÿ` : `å¯ä»¥è£æ»¿å¹¾${parsedTarget.name}ï¼Ÿå‰©ä¸‹å¹¾${parsedItem.unit}ï¼Ÿ`}</span>
                        </div>
                    </div>

                    <div className="mt-8 text-center">
                        {/* é€™è£¡çš„æŒ‰éˆ•ä¹Ÿæœƒè¢«è‡ªå‹• Focus åˆ°ï¼Œè®“å­¸ç”Ÿå¯ä»¥ç›´æ¥æŒ‰ Enter é€å‡º */}
                        <button onClick={handleCheck} className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-xl py-4 px-10 rounded-xl shadow-md transition-transform active:scale-95">æª¢æŸ¥é¡Œç›®åˆç†æ€§ä¸¦è§£é¡Œ</button>
                    </div>

                    {validateMsg && (
                        <div className={`mt-6 p-4 rounded-xl text-center font-bold text-lg border-2 ${validateMsg.ok ? 'bg-green-100 text-green-800 border-green-200' : 'bg-red-100 text-red-800 border-red-200'}`}>{validateMsg.text}</div>
                    )}
                    {solution && validateMsg?.ok && (
                        <div className="mt-6 bg-slate-800 text-white p-8 rounded-3xl animate-fade-in shadow-xl">
                            <h3 className="text-xl font-bold text-amber-400 mb-6 flex items-center gap-2"><span>ğŸ’¡</span> é›»è…¦å¹«ä½ è§£å‡ºä¾†äº†ï¼š</h3>
                            <p className="text-4xl font-mono mb-6 text-center tracking-widest bg-slate-900 py-6 rounded-2xl shadow-inner border border-slate-700">
                                {solution.t} Ã· {solution.d} = <span className="text-green-400">{solution.q}</span> ... <span className="text-red-400">{solution.r}</span>
                            </p>
                            <p className="text-xl text-center font-medium leading-relaxed">
                                {type === 'partitive'
                                    ? `æ¯å€‹${parsedTarget.name}åˆ†åˆ° ${solution.q} ${parsedItem.unit}ï¼Œé‚„å‰©ä¸‹ ${solution.r} ${parsedItem.unit}ä¸å¤ åˆ†ã€‚`
                                    : `å¯ä»¥è£æ»¿ ${solution.q} ${parsedTarget.name}ï¼Œé‚„å‰©ä¸‹ ${solution.r} ${parsedItem.unit}ä¸å¤ è£ã€‚`}
                            </p>
                        </div>
                    )}
                </div>
            );
        }

        // ==========================================
        // 6. ä¸»é¡Œå››ï¼šç´ é¤Šå¤§æŒ‘æˆ°
        // ==========================================
        function ThemeChallenge() {
            const [gameState, setGameState] = useState('start');
            const [questions, setQuestions] = useState([]);
            const [currentQIdx, setCurrentQIdx] = useState(0);
            const [score, setScore] = useState(0);

            const [equations, setEquations] = useState([{ id: Date.now(), v1: '', op: 'Ã·', v2: '' }]);
            const [ans, setAns] = useState({ q: '', qUnit: '', r: '', rUnit: '' });
            const [feedback, setFeedback] = useState(null);

            const generateQuestions = useCallback(() => {
                const qs = [];
                for (let i = 0; i < 5; i++) {
                    const level = i + 1;
                    let steps = 1; let noiseCount = 0;

                    if (level === 1) { steps = 1; noiseCount = 0; }
                    else if (level === 2) {
                        if (Math.random() > 0.5) { steps = 1; noiseCount = 1; } else { steps = 2; noiseCount = 0; }
                    }
                    else if (level === 3) {
                        if (Math.random() > 0.5) { steps = 1; noiseCount = 2; } else { steps = 2; noiseCount = 1; }
                    }
                    else if (level === 4) {
                        if (Math.random() > 0.5) { steps = 2; noiseCount = 2; } else { steps = 3; noiseCount = 1; }
                    }
                    else if (level === 5) {
                        if (Math.random() > 0.5) { steps = 2; noiseCount = 3; } else { steps = 3; noiseCount = 2; }
                    }

                    const subject = PCG_DATA.subjects[Math.floor(Math.random() * PCG_DATA.subjects.length)];
                    const item = PCG_DATA.items[Math.floor(Math.random() * PCG_DATA.items.length)];
                    const isPartitive = Math.random() > 0.5;

                    const divisor = Math.floor(Math.random() * 6) + 3;
                    const quotient = Math.floor(Math.random() * 8) + 2;
                    const remainder = Math.floor(Math.random() * divisor);
                    const total = divisor * quotient + remainder;

                    let storySentences = [];
                    if (steps === 1) {
                        storySentences.push(`${subject}æ”¶é›†äº† ${total} ${item.unit}${item.name}ã€‚`);
                    } else if (steps === 2) {
                        const p1 = Math.floor(total / 2) + Math.floor(Math.random() * 3);
                        const p2 = total - p1;
                        storySentences.push(`${subject}åŸæœ¬æœ‰ ${p1} ${item.unit}${item.name}ã€‚`);
                        storySentences.push(`å¾Œä¾†åˆå¾—åˆ°äº† ${p2} ${item.unit}${item.name}ã€‚`);
                    } else if (steps === 3) {
                        const p1 = Math.floor(total / 3); const p2 = Math.floor(total / 3); const p3 = total - p1 - p2;
                        storySentences.push(`${subject}ç¬¬ä¸€å¤©æ”¶é›†äº† ${p1} ${item.unit}${item.name}ã€‚`);
                        storySentences.push(`ç¬¬äºŒå¤©æ‰¾åˆ°äº† ${p2} ${item.unit}${item.name}ã€‚`);
                        storySentences.push(`ç¬¬ä¸‰å¤©åˆå¾—åˆ°äº† ${p3} ${item.unit}${item.name}ã€‚`);
                    }

                    const shuffledNoises = [...PCG_DATA.noises].sort(() => 0.5 - Math.random());
                    const selectedNoises = shuffledNoises.slice(0, noiseCount);

                    let combinedSentences = [...storySentences];
                    for (let noise of selectedNoises) {
                        const insertIdx = Math.floor(Math.random() * (combinedSentences.length + 1));
                        combinedSentences.splice(insertIdx, 0, noise);
                    }
                    const storyBase = combinedSentences.join('');

                    let text = ''; let correctQUnit, correctRUnit;
                    const container = PCG_DATA.containers[Math.floor(Math.random() * PCG_DATA.containers.length)];

                    if (isPartitive) {
                        text = `ä»Šå¤©æ˜¯ç‰¹åˆ¥çš„æ—¥å­ã€‚${storyBase}ä»–æƒ³è¦æŠŠé€™äº›${item.name}å¹³å‡åˆ†çµ¦ ${divisor} å€‹äººã€‚è«‹å•æ¯å€‹äººå¯ä»¥åˆ†åˆ°å¤šå°‘ï¼Ÿé‚„æœƒå‰©ä¸‹å¤šå°‘ï¼Ÿ`;
                        correctQUnit = item.unit; correctRUnit = item.unit;
                    } else {
                        text = `${storyBase}ä»–æ‰“ç®—æ¯ ${divisor} ${item.unit}${item.name}${container.action}ä¸€${container.unit}${container.name}ã€‚è«‹å•æœ€å¤šå¯ä»¥è£æ»¿å¹¾${container.unit}ï¼Ÿé‚„æœƒå‰©ä¸‹å¤šå°‘ï¼Ÿ`;
                        correctQUnit = container.unit; correctRUnit = item.unit;
                    }

                    const baseUnits = [item.unit, container.unit, 'äºº', 'å…ƒ'];
                    const uniqueUnits = Array.from(new Set(baseUnits));
                    if (!uniqueUnits.includes(correctQUnit)) uniqueUnits.push(correctQUnit);
                    if (!uniqueUnits.includes(correctRUnit)) uniqueUnits.push(correctRUnit);
                    uniqueUnits.sort(() => Math.random() - 0.5);

                    qs.push({
                        id: i, level, total, divisor, quotient, remainder, text,
                        correctQUnit, correctRUnit, unitOptions: uniqueUnits
                    });
                }
                setQuestions(qs); setCurrentQIdx(0); setScore(0); setGameState('playing'); resetInputs();
            }, []);

            const resetInputs = () => {
                setEquations([{ id: Date.now(), v1: '', op: 'Ã·', v2: '' }]);
                setAns({ q: '', qUnit: '', r: '', rUnit: '' });
                setFeedback(null);
            };

            const addEquation = () => {
                setEquations([...equations, { id: Date.now(), v1: '', op: 'Ã·', v2: '' }]);
                // åˆ©ç”¨ setTimeout ç¢ºä¿åœ¨ React æ¸²æŸ“æ–° DOM ç¯€é»å¾Œé€²è¡Œè‡ªå‹•èšç„¦
                setTimeout(() => {
                    const inputs = document.querySelectorAll('.eq-v1-input');
                    if (inputs.length > 0) {
                        inputs[inputs.length - 1].focus();
                    }
                }, 50);
            };

            const removeEquation = (idToRemove) => { if (equations.length > 1) setEquations(equations.filter(eq => eq.id !== idToRemove)); };
            const updateEquation = (id, field, value) => setEquations(equations.map(eq => eq.id === id ? { ...eq, [field]: value } : eq));

            const computeResult = (v1, op, v2) => {
                const n1 = parseInt(v1); const n2 = parseInt(v2);
                if (isNaN(n1) || isNaN(n2)) return '?';
                if (op === '+') return n1 + n2;
                if (op === '-') return n1 - n2;
                if (op === 'Ã—') return n1 * n2;
                if (op === 'Ã·') {
                    if (n2 === 0) return 'é™¤æ•¸ä¸èƒ½ç‚º0';
                    return `å•† ${Math.floor(n1 / n2)} é¤˜ ${n1 % n2}`;
                }
                return '?';
            };

            const submitAnswer = () => {
                if (feedback) return;
                const q = questions[currentQIdx];
                const userQ = parseInt(ans.q); const userR = parseInt(ans.r) || 0;

                let errors = [];
                if (userQ !== q.quotient || userR !== q.remainder) errors.push('æœ€çµ‚æ•¸å­—è¨ˆç®—éŒ¯èª¤');
                if (ans.qUnit !== q.correctQUnit) errors.push('ç­”æ¡ˆå–®ä½é¸éŒ¯äº†');
                if (ans.rUnit !== q.correctRUnit) errors.push('é¤˜æ•¸å–®ä½é¸éŒ¯äº†');

                if (errors.length === 0) {
                    setFeedback({ ok: true, msg: 'å¤ªå²å®³äº†ï¼åˆ—å¼ã€è¨ˆç®—èˆ‡å–®ä½å®Œå…¨æ­£ç¢ºï¼' }); setScore(s => s + 20);
                } else {
                    setFeedback({ ok: false, msg: `ç­”éŒ¯å›‰ï¼(${errors.join('ã€')})\n\næ­£ç¢ºè§£æï¼š\nç¸½å…±æ•¸é‡æ˜¯ ${q.total}ï¼Œé™¤ä»¥ ${q.divisor}ã€‚\næ­£ç¢ºç®—å¼ï¼š${q.total} Ã· ${q.divisor} = ${q.quotient} ... ${q.remainder}\næ­£ç¢ºå–®ä½ï¼šç­”æ¡ˆæ˜¯ã€Œ${q.correctQUnit}ã€ï¼Œé¤˜æ•¸æ˜¯ã€Œ${q.correctRUnit}ã€ã€‚` });
                }
            };

            const nextQuestion = () => {
                if (currentQIdx < 4) { setCurrentQIdx(c => c + 1); resetInputs(); } else setGameState('end');
            };

            if (gameState === 'start') {
                return (
                    <div className="flex flex-col items-center justify-center h-full text-center p-8 animate-fade-in">
                        <div className="text-8xl md:text-9xl mb-6 drop-shadow-md">âš”ï¸</div>
                        <h2 className="text-3xl md:text-4xl font-black text-purple-800 mb-6">é­”ç‹é—œå¡ï¼šç´ é¤Šå¤§æŒ‘æˆ°</h2>
                        <div className="text-base md:text-lg text-slate-700 mb-8 max-w-2xl bg-white p-6 md:p-8 rounded-3xl shadow-sm border-2 border-purple-200 text-left space-y-4">
                            <p className="flex gap-2"><span>ğŸ“Œ</span> <span>æ­¤æŒ‘æˆ°å…±æœ‰ 5 é¡Œï¼Œ<strong>é›£åº¦å°‡é€é¡Œæå‡ï¼ˆ1 æ˜Ÿåˆ° 5 æ˜Ÿï¼‰</strong>ï¼</span></p>
                            <p className="flex gap-2"><span>ğŸ“Œ</span> <span><strong>æ˜Ÿç­‰èªªæ˜ï¼š</strong>é›£åº¦æ˜Ÿæ˜Ÿä»£è¡¨ã€Œå¹²æ“¾è³‡è¨Šæ•¸ã€åŠ ä¸Šã€Œç®—å¼æ­¥é©Ÿæ•¸ã€ã€‚ä¾‹å¦‚ 5 é¡†æ˜Ÿå¯èƒ½æœƒæœ‰ 3 å¥å»¢è©±åŠ ä¸Š 2 æ­¥åŠ æ¸›æ³•ï¼</span></p>
                            <p className="flex gap-2"><span>ğŸ“Œ</span> <span><strong>ä½ ä¸ç”¨è‡ªå·±ç®—ï¼</strong>å–„ç”¨ã€Œç®—å¼å°å¹«æ‰‹ã€ï¼Œè®“é›»è…¦å¹«ä½ ç®—å‡ºæ¯ä¸€æ­¥çµæœï¼Œæœ€å¾Œå¡«å…¥æ­£ç¢ºè§£ç­”èˆ‡å–®ä½å³å¯ã€‚</span></p>
                        </div>
                        <button onClick={generateQuestions} className="bg-purple-600 hover:bg-purple-700 text-white font-bold text-xl md:text-2xl py-4 px-12 rounded-full shadow-xl transition-transform active:scale-95">æ¥å—æŒ‘æˆ°</button>
                    </div>
                );
            }

            if (gameState === 'end') {
                return (
                    <div className="flex flex-col items-center justify-center h-full text-center p-8 animate-fade-in">
                        <div className="text-[100px] md:text-[120px] mb-6 drop-shadow-lg">{score >= 80 ? 'ğŸ‘‘' : 'ğŸ’ª'}</div>
                        <h2 className="text-3xl md:text-4xl font-black text-slate-800 mb-2">æŒ‘æˆ°çµæŸï¼</h2>
                        <p className="text-xl md:text-2xl text-slate-600 mb-10 font-medium">ä½ çš„ç´ é¤Šç¸½åˆ†æ˜¯ï¼š<span className="text-5xl font-black text-purple-600 mx-2">{score}</span> åˆ†</p>
                        <button onClick={generateQuestions} className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-xl py-4 px-10 rounded-full shadow-lg transition-transform active:scale-95">å†æˆ°ä¸€æ¬¡</button>
                    </div>
                );
            }

            const q = questions[currentQIdx];

            return (
                <div className="animate-fade-in flex flex-col h-full">
                    <div className="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                        <div className="flex items-center gap-3">
                            <span className="bg-purple-200 text-purple-900 font-bold px-4 py-2 rounded-full shadow-sm text-sm">ç¬¬ {currentQIdx + 1} / 5 é¡Œ</span>
                            <span className="bg-amber-100 text-amber-800 font-bold px-4 py-2 rounded-full border border-amber-300 shadow-sm text-sm flex items-center gap-1">
                                é›£åº¦ï¼š<span className="tracking-widest">{'â­'.repeat(q.level)}</span>
                            </span>
                        </div>
                        <span className="font-bold text-slate-600 bg-white px-4 py-2 rounded-lg shadow-sm border border-slate-200 text-sm">ç›®å‰åˆ†æ•¸ï¼š{score}</span>
                    </div>

                    <div className="bg-white p-6 md:p-8 rounded-3xl shadow-sm border-l-8 border-purple-500 mb-6">
                        <p className="text-lg md:text-xl leading-relaxed font-medium text-slate-800">{q.text}</p>
                    </div>

                    {/* å¥—ç”¨ focus-container åŒ…è¦†æ•´å€‹æ“ä½œå€ */}
                    <div className="flex flex-col xl:flex-row gap-6 pb-10 focus-container">
                        {/* å·¦å´ï¼šç®—å¼å°å¹«æ‰‹å€ */}
                        <div className="bg-indigo-50 p-6 rounded-3xl border-2 border-indigo-200 flex-1 shadow-inner flex flex-col">
                            <h3 className="text-xl font-black text-indigo-900 mb-4 flex items-center gap-2 border-b border-indigo-200 pb-2">
                                <span>ğŸ§®</span> ç®—å¼å€ (äº¤çµ¦é›»è…¦ç®—)
                            </h3>

                            <div className="space-y-4 mb-6">
                                {equations.map((eq, index) => (
                                    <div key={eq.id} className="flex flex-wrap items-center gap-2 bg-white p-3 rounded-xl shadow-sm border border-indigo-100">
                                        <span className="font-black text-indigo-300 w-5">{index + 1}.</span>
                                        {/* ç¬¬ä¸€å€‹è¼¸å…¥æ¡†è¨­å®š autoFocus ä¸”æ”¯æ´ Enter å°èˆª */}
                                        <input autoFocus={index === 0} onKeyDown={handleEnterFocusNext} type="number" value={eq.v1} onChange={(e) => updateEquation(eq.id, 'v1', e.target.value)} disabled={feedback != null} className="eq-v1-input w-16 md:w-20 p-2 rounded-lg border-2 border-slate-200 focus:border-indigo-500 text-center text-lg font-bold bg-slate-50 outline-none" />

                                        {/* åŠ å…¥ Enter å°èˆªåˆ° Select */}
                                        <select onKeyDown={handleEnterFocusNext} value={eq.op} onChange={(e) => updateEquation(eq.id, 'op', e.target.value)} disabled={feedback != null} className="p-2 rounded-lg border-2 border-slate-200 focus:border-indigo-500 text-lg font-bold bg-slate-100 outline-none">
                                            <option value="+">+</option><option value="-">-</option><option value="Ã—">Ã—</option><option value="Ã·">Ã·</option>
                                        </select>

                                        {/* ç¬¬äºŒå€‹è¼¸å…¥æ¡†æ”¯æ´ Enter å°èˆª */}
                                        <input type="number" onKeyDown={handleEnterFocusNext} value={eq.v2} onChange={(e) => updateEquation(eq.id, 'v2', e.target.value)} disabled={feedback != null} className="w-16 md:w-20 p-2 rounded-lg border-2 border-slate-200 focus:border-indigo-500 text-center text-lg font-bold bg-slate-50 outline-none" />

                                        <span className="font-bold text-xl text-slate-400 mx-1">=</span>
                                        <div className="bg-indigo-100 px-4 py-2 rounded-lg border border-indigo-200 min-w-[100px] text-center font-bold text-indigo-800 text-lg shadow-inner">
                                            {computeResult(eq.v1, eq.op, eq.v2)}
                                        </div>
                                        {equations.length > 1 && !feedback && (
                                            <button onClick={() => removeEquation(eq.id)} className="ml-auto text-red-400 hover:text-red-600 font-bold px-2 text-xl transition-colors">âœ–</button>
                                        )}
                                    </div>
                                ))}
                            </div>

                            {!feedback && (
                                <button onClick={addEquation} className="text-indigo-700 font-bold hover:text-indigo-900 flex items-center justify-center gap-2 bg-indigo-200/50 hover:bg-indigo-200 px-4 py-3 rounded-xl transition-colors mt-auto border border-dashed border-indigo-300">
                                    <span>â•</span> æ–°å¢ä¸€æ­¥ç®—å¼
                                </button>
                            )}
                        </div>

                        {/* å³å´ï¼šæœ€çµ‚ä½œç­”å€ */}
                        <div className="bg-green-50 p-6 rounded-3xl border-2 border-green-200 flex-1 flex flex-col shadow-inner">
                            <h3 className="text-xl font-black text-green-900 mb-4 flex items-center gap-2 border-b border-green-200 pb-2">
                                <span>ğŸ¯</span> ä½œç­”å€ (è«‹å¡«å…¥æœ€çµ‚çµæœ)
                            </h3>

                            <div className="bg-white p-6 rounded-2xl border border-green-100 shadow-sm flex flex-col gap-5 mb-6">
                                <div className="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
                                    <span className="font-bold text-slate-700 w-16">ç­”æ¡ˆï¼š</span>
                                    <div className="flex items-center gap-2 flex-1">
                                        {/* Enter å°èˆª */}
                                        <input type="number" onKeyDown={handleEnterFocusNext} value={ans.q} onChange={e => setAns({ ...ans, q: e.target.value })} disabled={feedback != null} className="w-24 p-3 rounded-lg border-2 border-green-300 text-center font-bold text-lg focus:border-green-500 bg-slate-50 outline-none" />
                                        {/* åŠ å…¥ Enter å°èˆªåˆ° Select */}
                                        <select onKeyDown={handleEnterFocusNext} value={ans.qUnit} onChange={e => setAns({ ...ans, qUnit: e.target.value })} disabled={feedback != null} className="flex-1 p-3 rounded-lg border-2 border-green-300 bg-slate-50 font-bold text-green-800 focus:border-green-500 outline-none">
                                            <option value="">é¸æ“‡å–®ä½</option>
                                            {/* å„ªåŒ–ï¼šåªè¼‰å…¥è©²é¡Œç›®æœ‰æ„ç¾©çš„å¹²æ“¾å–®ä½ */}
                                            {q.unitOptions.map(u => <option key={u} value={u}>{u}</option>)}
                                        </select>
                                    </div>
                                </div>

                                <div className="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
                                    <span className="font-bold text-slate-700 w-16">å‰©ä¸‹ï¼š</span>
                                    <div className="flex items-center gap-2 flex-1">
                                        {/* Enter å°èˆª */}
                                        <input type="number" onKeyDown={handleEnterFocusNext} value={ans.r} onChange={e => setAns({ ...ans, r: e.target.value })} disabled={feedback != null} className="w-24 p-3 rounded-lg border-2 border-red-300 text-center font-bold text-lg focus:border-red-500 bg-slate-50 outline-none" placeholder="0" />
                                        {/* åŠ å…¥ Enter å°èˆªåˆ° Select */}
                                        <select onKeyDown={handleEnterFocusNext} value={ans.rUnit} onChange={e => setAns({ ...ans, rUnit: e.target.value })} disabled={feedback != null} className="flex-1 p-3 rounded-lg border-2 border-red-300 bg-slate-50 font-bold text-red-800 focus:border-red-500 outline-none">
                                            <option value="">é¸æ“‡å–®ä½</option>
                                            {/* å„ªåŒ–ï¼šåªè¼‰å…¥è©²é¡Œç›®æœ‰æ„ç¾©çš„å¹²æ“¾å–®ä½ */}
                                            {q.unitOptions.map(u => <option key={u} value={u}>{u}</option>)}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            {!feedback ? (
                                <button onClick={submitAnswer} disabled={!ans.q || !ans.qUnit || !ans.rUnit} className="mt-auto bg-green-600 disabled:bg-slate-300 disabled:text-slate-500 hover:bg-green-700 text-white font-bold text-xl py-4 rounded-xl shadow-md transition-transform active:scale-95">
                                    ç¢ºå®šé€å‡º
                                </button>
                            ) : (
                                <div className="mt-auto w-full text-center animate-fade-in flex flex-col">
                                    <div className={`p-5 rounded-2xl mb-5 text-left font-bold whitespace-pre-wrap border-2 ${feedback.ok ? 'bg-green-100 text-green-800 border-green-300' : 'bg-red-50 text-red-800 border-red-300 shadow-inner'}`}>
                                        {feedback.msg}
                                    </div>
                                    <button onClick={nextQuestion} className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-xl py-4 rounded-xl shadow-lg transition-transform active:scale-95">
                                        {currentQIdx < 4 ? 'ä¸‹ä¸€é¡Œ â”' : 'æŸ¥çœ‹æˆç¸¾ â”'}
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // æ›è¼‰ React æ‡‰ç”¨ç¨‹å¼
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>