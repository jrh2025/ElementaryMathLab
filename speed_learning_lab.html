<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>速率互動實驗室 | 互動數學實驗室</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
        }

        .module-content {
            display: none;
        }

        .module-content.active {
            display: block;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .formula-triangle polygon {
            transition: all 0.3s ease;
        }

        .btn-nav.active {
            background-color: #2563eb;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        input[type=range] {
            accent-color: #2563eb;
        }

        .finish-tape {
            background: repeating-linear-gradient(45deg,
                    #ef4444,
                    #ef4444 10px,
                    #ffffff 10px,
                    #ffffff 20px);
        }

        .step-node.active {
            border-color: #2563eb;
            background-color: #eff6ff;
            color: #1e40af;
            transform: scale(1.1);
        }

        .step-node.completed {
            background-color: #22c55e;
            color: white;
            border-color: #16a34a;
        }

        .trace-item {
            animation: slideInRight 0.3s ease-out;
            border-left: 4px solid #3b82f6;
            background-color: #f8fafc;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 0 8px 8px 0;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .mnemonic-card {
            background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
            border-left: 4px solid #3b82f6;
        }

        .math-box {
            font-family: 'Courier New', Courier, monospace;
            background: #f1f5f9;
            padding: 8px;
            border-radius: 6px;
            display: inline-block;
            min-width: 60px;
            text-align: center;
        }

        .skill-card {
            transition: all 0.2s ease;
        }

        .skill-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .input-formula {
            font-family: 'Courier New', Courier, monospace;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .water-line {
            animation: waterSlide linear infinite;
        }

        @keyframes waterSlide {
            from {
                transform: translateX(-50%);
            }

            to {
                transform: translateX(0);
            }
        }

        .challenge-step-row,
        .lit-step-row {
            animation: slideInRight 0.3s ease-out;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body class="min-h-screen text-slate-900 flex flex-col md:flex-row">

    <!-- Sidebar Navigation -->
    <nav class="w-full md:w-64 bg-white border-b md:border-r border-slate-200 p-4 flex flex-col gap-2 shrink-0">
        <div class="flex items-center gap-2 px-2 py-4 mb-4 border-b border-slate-100">
            <i data-lucide="fast-forward" class="w-8 h-8 text-blue-600"></i>
            <h1 class="text-xl font-bold text-slate-800">速率實驗室</h1>
        </div>

        <button onclick="switchModule('welcome')" id="nav-welcome"
            class="btn-nav flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-600 hover:bg-slate-100">
            <i data-lucide="home" class="w-5 h-5"></i>
            <span class="font-medium">歡迎首頁</span>
        </button>
        <button onclick="switchModule('formula')" id="nav-formula"
            class="btn-nav flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-600 hover:bg-slate-100">
            <i data-lucide="book-open" class="w-5 h-5"></i>
            <span class="font-medium">核心公式與單位</span>
        </button>
        <button onclick="switchModule('comparison')" id="nav-comparison"
            class="btn-nav flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-600 hover:bg-slate-100">
            <i data-lucide="play" class="w-5 h-5"></i>
            <span class="font-medium">認識快慢</span>
        </button>
        <button onclick="switchModule('conversion')" id="nav-conversion"
            class="btn-nav flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-600 hover:bg-slate-100">
            <i data-lucide="arrow-right-left" class="w-5 h-5"></i>
            <span class="font-medium">單位換算挑戰</span>
        </button>
        <button onclick="switchModule('scenarios')" id="nav-scenarios"
            class="btn-nav flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-600 hover:bg-slate-100">
            <i data-lucide="compass" class="w-5 h-5"></i>
            <span class="font-medium">應用題型實戰</span>
        </button>
        <button onclick="switchModule('life')" id="nav-life"
            class="btn-nav flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-600 hover:bg-slate-100">
            <i data-lucide="users" class="w-5 h-5"></i>
            <span class="font-medium">生活素養挑戰</span>
        </button>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-auto p-4 md:p-8">
        <div class="max-w-6xl mx-auto">

            <!-- Module: Welcome -->
            <section id="module-welcome" class="module-content active">
                <div class="flex flex-col items-center justify-center py-20 text-center">
                    <div class="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mb-6">
                        <i data-lucide="fast-forward" class="w-12 h-12 text-blue-600"></i>
                    </div>
                    <h1 class="text-4xl font-extrabold text-slate-800 mb-4">掌握速率的奧秘</h1>
                    <p class="text-lg text-slate-600 mb-8 max-w-lg leading-relaxed">
                        速率是物理世界的節奏。透過本實驗室，你將學會如何定義速率、換算單位，並解決真實生活中的追趕、流水與回聲問題。
                    </p>
                    <button onclick="switchModule('formula')"
                        class="px-8 py-4 bg-blue-600 text-white rounded-full font-bold text-lg hover:bg-blue-700 transition-colors shadow-lg shadow-blue-200 flex items-center gap-2">
                        開始探索 <i data-lucide="play" class="w-5 h-5 fill-current"></i>
                    </button>
                </div>
            </section>

            <!-- Module: Formula -->
            <section id="module-formula" class="module-content">
                <h2 class="text-3xl font-bold mb-6 flex items-center gap-2">核心概念與單位意義</h2>
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100 mb-8">
                    <div class="flex flex-col items-center justify-center gap-8 md:flex-row">
                        <div class="relative w-64 h-56 flex items-center justify-center shrink-0">
                            <svg viewBox="0 0 100 87" class="w-full h-full drop-shadow-md formula-triangle">
                                <polygon points="50,5 95,82 5,82" fill="#eff6ff" stroke="#bfdbfe" stroke-width="2" />
                                <line x1="25" y1="45" x2="75" y2="45" stroke="#bfdbfe" stroke-width="2" />
                                <line x1="50" y1="45" x2="50" y2="82" stroke="#bfdbfe" stroke-width="2" />
                            </svg>
                            <button onclick="updateFormula('distance')"
                                class="absolute top-[20%] font-bold text-slate-400 hover:text-blue-600 transition-all hover:scale-110">距離</button>
                            <button onclick="updateFormula('speed')"
                                class="absolute bottom-[15%] left-[20%] font-bold text-slate-400 hover:text-blue-600 transition-all hover:scale-110">速率</button>
                            <button onclick="updateFormula('time')"
                                class="absolute bottom-[15%] right-[20%] font-bold text-slate-400 hover:text-blue-600 transition-all hover:scale-110">時間</button>
                        </div>
                        <div id="formula-display"
                            class="flex-1 bg-blue-50 p-6 rounded-xl border border-blue-100 min-h-[160px] flex flex-col justify-center">
                            <span
                                class="text-blue-600 font-bold text-sm uppercase tracking-wider mb-1">點選三角形來查看公式</span>
                            <h3 id="formula-title" class="text-2xl font-bold">速率 = 距離 ÷ 時間</h3>
                            <p id="formula-desc" class="text-slate-600 mt-2">物體在單位時間內移動的距離。</p>
                        </div>
                    </div>
                </div>
                <div class="space-y-6 mb-10">
                    <h3 class="text-xl font-bold text-slate-700 flex items-center gap-2"><i data-lucide="info"
                            class="w-5 h-5 text-blue-500"></i> 不同單位的使用時機</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="p-6 bg-white rounded-2xl border border-slate-100 shadow-sm">
                            <div class="flex items-center gap-2 mb-3"><i data-lucide="car"
                                    class="w-5 h-5 text-blue-600"></i>
                                <h4 class="font-bold text-blue-600">時速 (km/h)</h4>
                            </div>
                            <p class="text-sm text-slate-500 mb-2 font-medium underline">一小時移動幾公里</p>
                            <p class="text-sm text-slate-600 leading-relaxed">用於長距離交通，如：開車、高鐵、飛機。</p>
                        </div>
                        <div class="p-6 bg-white rounded-2xl border border-slate-100 shadow-sm">
                            <div class="flex items-center gap-2 mb-3"><i data-lucide="play"
                                    class="w-5 h-5 text-orange-600"></i>
                                <h4 class="font-bold text-orange-600">分速 (m/min)</h4>
                            </div>
                            <p class="text-sm text-slate-500 mb-2 font-medium underline">一分鐘移動幾公尺</p>
                            <p class="text-sm text-slate-600 leading-relaxed">用於日常活動，如：散步、慢跑。</p>
                        </div>
                        <div class="p-6 bg-white rounded-2xl border border-slate-100 shadow-sm">
                            <div class="flex items-center gap-2 mb-3"><i data-lucide="timer"
                                    class="w-5 h-5 text-green-600"></i>
                                <h4 class="font-bold text-green-600">秒速 (m/s)</h4>
                            </div>
                            <p class="text-sm text-slate-500 mb-2 font-medium underline">一秒鐘移動幾公尺</p>
                            <p class="text-sm text-slate-600 leading-relaxed">用於短時間衝刺或科學現象，如：風速、聲速。</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Module: Comparison -->
            <section id="module-comparison" class="module-content">
                <h2 class="text-3xl font-bold mb-4">認識快慢：實戰模擬</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="lg:col-span-1 space-y-4 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <h3 class="font-bold text-slate-800 flex items-center gap-2 border-b pb-2 mb-4"><i
                                data-lucide="settings" class="w-4 h-4 text-blue-600"></i> 參數設定</h3>
                        <div class="flex gap-2 mb-4">
                            <button onclick="setRaceMode('distanceFixed')" id="btn-dist-fixed"
                                class="flex-1 py-2 text-xs rounded-lg font-medium transition-colors">距離一定</button>
                            <button onclick="setRaceMode('timeFixed')" id="btn-time-fixed"
                                class="flex-1 py-2 text-xs rounded-lg font-medium transition-colors">時間一定</button>
                        </div>
                        <div id="distance-slider-group">
                            <label class="block text-xs font-bold text-slate-500 mb-1">賽道總長：<span
                                    id="label-dist">100</span> 公尺</label>
                            <input id="input-dist" type="range" min="50" max="300" step="10" value="100"
                                oninput="syncRaceParams()"
                                class="w-full h-2 bg-slate-100 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div id="time-slider-group" class="hidden">
                            <label class="block text-xs font-bold text-slate-500 mb-1">比賽時間：<span
                                    id="label-time">10</span> 秒鐘</label>
                            <input id="input-time" type="range" min="5" max="30" step="1" value="10"
                                oninput="syncRaceParams()"
                                class="w-full h-2 bg-slate-100 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div class="pt-4 border-t">
                            <label class="block text-xs font-bold text-blue-600 mb-1">車子 A 速率：<span
                                    id="label-speed-a">5</span> m/s</label>
                            <input id="input-speed-a" type="range" min="2" max="20" step="1" value="5"
                                oninput="syncRaceParams()"
                                class="w-full h-2 bg-blue-100 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div class="pt-2">
                            <label class="block text-xs font-bold text-orange-600 mb-1">車子 B 速率：<span
                                    id="label-speed-b">8</span> m/s</label>
                            <input id="input-speed-b" type="range" min="2" max="20" step="1" value="8"
                                oninput="syncRaceParams()"
                                class="w-full h-2 bg-orange-100 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div class="mt-4 flex flex-col gap-2">
                            <button id="start-race" onclick="startRace()"
                                class="w-full flex items-center justify-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-bold transition-all"><i
                                    data-lucide="play" class="w-4 h-4 fill-current"></i> 開始比賽</button>
                            <button onclick="resetRace()"
                                class="w-full flex items-center justify-center gap-2 px-6 py-2 border border-slate-200 rounded-xl hover:bg-slate-50 text-slate-600 text-sm"><i
                                    data-lucide="rotate-ccw" class="w-4 h-4"></i> 全部重設</button>
                        </div>
                    </div>
                    <div class="lg:col-span-2 flex flex-col gap-4">
                        <div
                            class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100 flex-1 relative overflow-hidden flex flex-col justify-center">
                            <div class="space-y-16 py-8">
                                <div class="relative h-12 border-b-2 border-slate-100 bg-slate-50/50">
                                    <div id="car-a" class="absolute left-0 z-10" style="left: 0%;">
                                        <div class="flex flex-col items-center -ml-5"><i data-lucide="car"
                                                class="text-blue-500 w-10 h-10 drop-shadow-sm"></i><span
                                                id="car-a-status"
                                                class="text-[10px] font-bold bg-blue-50 text-blue-600 px-1 rounded mt-1">0m</span>
                                        </div>
                                    </div>
                                    <div
                                        class="finish-line-a absolute right-[10%] top-0 h-full w-2 finish-tape z-0 opacity-80">
                                    </div>
                                </div>
                                <div class="relative h-12 border-b-2 border-slate-100 bg-slate-50/50">
                                    <div id="car-b" class="absolute left-0 z-10" style="left: 0%;">
                                        <div class="flex flex-col items-center -ml-5"><i data-lucide="car"
                                                class="text-orange-500 w-10 h-10 drop-shadow-sm"></i><span
                                                id="car-b-status"
                                                class="text-[10px] font-bold bg-orange-50 text-orange-600 px-1 rounded mt-1">0m</span>
                                        </div>
                                    </div>
                                    <div
                                        class="finish-line-b absolute right-[10%] top-0 h-full w-2 finish-tape z-0 opacity-80">
                                    </div>
                                </div>
                            </div>
                            <div
                                class="absolute top-4 right-6 bg-slate-800 text-white font-mono px-4 py-1 rounded-full text-sm shadow-inner">
                                <span id="race-timer-display">00.00</span>s
                            </div>
                        </div>
                        <div id="race-results" class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                            <h4 class="text-sm font-bold text-blue-800 mb-2 flex items-center gap-2"><i
                                    data-lucide="lightbulb" class="w-4 h-4"></i> 實驗結果分析</h4>
                            <div id="observation-box" class="text-sm text-blue-700 leading-relaxed">
                                請設定左側參數，並按下「開始比賽」來觀察現象。</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Module: Conversion (UPDATED) -->
            <section id="module-conversion" class="module-content">
                <h2 class="text-3xl font-bold mb-4 flex items-center gap-2">單位換算：引導式實驗室</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="skill-card bg-white p-4 rounded-2xl border-b-4 border-blue-500 shadow-sm">
                        <h4 class="font-bold text-blue-600 mb-2 flex items-center gap-2 text-sm"><i data-lucide="ruler"
                                class="w-4 h-4"></i> 長度換算指導</h4>
                        <ul class="text-xs space-y-1.5 text-slate-600 font-medium">
                            <li class="flex justify-between"><span>公里 (km) → 公尺 (m)</span> <span class="text-blue-500">×
                                    1000</span></li>
                            <li class="flex justify-between"><span>公尺 (m) → 公分 (cm)</span> <span class="text-blue-500">×
                                    100</span></li>
                        </ul>
                    </div>
                    <div class="skill-card bg-white p-4 rounded-2xl border-b-4 border-orange-500 shadow-sm">
                        <h4 class="font-bold text-orange-600 mb-2 flex items-center gap-2 text-sm"><i
                                data-lucide="clock" class="w-4 h-4"></i> 時間換算指導</h4>
                        <ul class="text-xs space-y-1.5 text-slate-600 font-medium">
                            <li class="flex justify-between"><span>小時 (hr) → 分鐘 (min)</span> <span
                                    class="text-orange-500">× 60</span></li>
                            <li class="flex justify-between"><span>分鐘 (min) → 秒鐘 (sec)</span> <span
                                    class="text-orange-500">× 60</span></li>
                        </ul>
                    </div>
                    <div class="skill-card bg-white p-4 rounded-2xl border-b-4 border-indigo-500 shadow-sm">
                        <h4 class="font-bold text-indigo-600 mb-2 flex items-center gap-2 text-sm"><i data-lucide="zap"
                                class="w-4 h-4"></i> 速率直達秘訣</h4>
                        <div class="bg-indigo-50 p-2 rounded-lg text-[10px] text-indigo-700 leading-relaxed">
                            <p class="font-bold">✨ 萬用 3.6 法則：</p>
                            <p>• <b>時速 (km/h)</b> 變 <b>秒速 (m/s)</b>：直接 <span class="underline">除以 3.6</span></p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 mb-6">
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i data-lucide="layers"
                            class="w-5 h-5 text-indigo-500"></i> 第一步：選擇換算情境（題目數字會隨機變化）</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                        <button onclick="loadConversionScenario('plane')"
                            class="scenario-btn p-3 border rounded-xl hover:bg-slate-50 text-left transition-all focus:ring-2 focus:ring-indigo-500 outline-none">
                            <div class="flex items-center gap-2 mb-1"><i data-lucide="plane" class="w-4 h-4"></i> <span
                                    class="text-xs font-bold">民航客機</span></div>
                        </button>
                        <button onclick="loadConversionScenario('sprinter')"
                            class="scenario-btn p-3 border rounded-xl hover:bg-slate-50 text-left transition-all focus:ring-2 focus:ring-indigo-500 outline-none">
                            <div class="flex items-center gap-2 mb-1"><i data-lucide="user" class="w-4 h-4"></i> <span
                                    class="text-xs font-bold">運動員</span></div>
                        </button>
                        <button onclick="loadConversionScenario('snail')"
                            class="scenario-btn p-3 border rounded-xl hover:bg-slate-50 text-left transition-all focus:ring-2 focus:ring-indigo-500 outline-none">
                            <div class="flex items-center gap-2 mb-1"><i data-lucide="bug" class="w-4 h-4"></i> <span
                                    class="text-xs font-bold">蝸牛</span></div>
                        </button>
                        <button onclick="loadConversionScenario('typhoon')"
                            class="scenario-btn p-3 border rounded-xl hover:bg-slate-50 text-left transition-all focus:ring-2 focus:ring-indigo-500 outline-none">
                            <div class="flex items-center gap-2 mb-1"><i data-lucide="wind" class="w-4 h-4"></i> <span
                                    class="text-xs font-bold">強烈颱風</span></div>
                        </button>
                    </div>
                    <div id="scenario-intro"
                        class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-8 hidden animate-in fade-in">
                        <p id="scenario-text" class="text-indigo-800 text-sm font-medium"></p>
                    </div>
                    <div id="conversion-workspace"
                        class="hidden grid grid-cols-1 lg:grid-cols-2 gap-8 animate-in fade-in">
                        <div class="space-y-6">
                            <div id="step-tracker" class="flex items-center justify-between px-4 relative">
                                <div class="absolute left-0 right-0 h-0.5 bg-slate-100 top-1/2 -translate-y-1/2 z-0">
                                </div>
                                <div id="node-1"
                                    class="step-node active w-10 h-10 rounded-full border-2 bg-white z-10 flex items-center justify-center font-bold">
                                    1</div>
                                <div id="node-2"
                                    class="step-node w-10 h-10 rounded-full border-2 bg-white z-10 flex items-center justify-center font-bold">
                                    2</div>
                                <div id="node-3"
                                    class="step-node w-10 h-10 rounded-full border-2 bg-white z-10 flex items-center justify-center font-bold">
                                    3</div>
                            </div>
                            <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200 min-h-[200px]">
                                <!-- Inputs changed to type="text" for formulas -->
                                <div id="step-1" class="step-pane">
                                    <h4 class="font-bold text-lg mb-2 flex items-center gap-2"><i data-lucide="maximize"
                                            class="w-5 h-5 text-blue-500"></i> 步驟一</h4>
                                    <p id="step-1-q" class="text-sm text-slate-500 mb-4"></p>
                                    <div class="flex flex-col gap-2">
                                        <div class="flex items-center gap-3">
                                            <input type="text" id="ans-1"
                                                onkeyup="if(event.key==='Enter') handleStepCheck(1)"
                                                placeholder="請輸入算式 (例如: 10 * 60)"
                                                class="flex-1 px-4 py-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 font-mono">
                                            <button onclick="handleStepCheck(1)"
                                                class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold transition-all">核對</button>
                                        </div>
                                        <p id="feedback-1" class="text-sm font-bold h-6 transition-all"></p>
                                        <p id="hint-1" class="text-[11px] text-slate-400"></p>
                                    </div>
                                </div>
                                <div id="step-2" class="step-pane hidden">
                                    <h4 class="font-bold text-lg mb-2 flex items-center gap-2 text-indigo-800"><i
                                            data-lucide="clock" class="w-5 h-5"></i> 步驟二</h4>
                                    <p id="step-2-q" class="text-sm text-slate-500 mb-4"></p>
                                    <div class="flex flex-col gap-2">
                                        <div class="flex items-center gap-3">
                                            <input type="text" id="ans-2"
                                                onkeyup="if(event.key==='Enter') handleStepCheck(2)"
                                                placeholder="請輸入算式 (例如: 60 * 60)"
                                                class="flex-1 px-4 py-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 font-mono">
                                            <button onclick="handleStepCheck(2)"
                                                class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold transition-all">核對</button>
                                        </div>
                                        <p id="feedback-2" class="text-sm font-bold h-6 transition-all"></p>
                                        <p id="hint-2" class="text-[11px] text-slate-400"></p>
                                    </div>
                                </div>
                                <div id="step-3" class="step-pane hidden">
                                    <h4 class="font-bold text-lg mb-2 flex items-center gap-2 text-indigo-800"><i
                                            data-lucide="target" class="w-5 h-5"></i> 步驟三</h4>
                                    <p id="step-3-q" class="text-sm text-slate-500 mb-4"></p>
                                    <div class="flex flex-col gap-2">
                                        <div class="flex items-center gap-3">
                                            <input type="text" id="ans-3"
                                                onkeyup="if(event.key==='Enter') handleStepCheck(3)"
                                                placeholder="最終算式 (例如: 1000 / 3600)"
                                                class="flex-1 px-4 py-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 font-mono">
                                            <button onclick="handleStepCheck(3)"
                                                class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold transition-all">完成</button>
                                        </div>
                                        <p id="feedback-3" class="text-sm font-bold h-6 transition-all"></p>
                                        <p id="hint-3" class="text-[11px] text-slate-400"></p>
                                    </div>
                                </div>
                                <div id="step-success" class="step-pane hidden text-center py-6">
                                    <div
                                        class="inline-flex items-center justify-center w-16 h-16 bg-green-100 text-green-600 rounded-full mb-4">
                                        <i data-lucide="check-circle" class="w-8 h-8"></i>
                                    </div>
                                    <h4 class="font-bold text-xl text-green-700 mb-2">成功達成目標！</h4>
                                    <p id="final-insight" class="text-sm text-slate-500 mb-4"></p><button
                                        onclick="resetConversionLab()"
                                        class="px-6 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 text-xs font-bold transition-all">挑戰其他情境</button>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col h-full">
                            <h4 class="font-bold text-slate-800 mb-4 flex items-center gap-2 border-b pb-2"><i
                                    data-lucide="history" class="w-4 h-4 text-slate-400"></i> 推導軌跡與整合呈現</h4>
                            <div id="formula-trace-container"
                                class="flex-1 space-y-2 overflow-y-auto max-h-[300px] custom-scrollbar">
                                <div class="p-4 bg-slate-50 rounded-xl border border-dashed border-slate-200 text-center"
                                    id="trace-placeholder">
                                    <p class="text-slate-400 text-sm">請在左側輸入列式，正確的推導過程會記錄在這裡...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Module: Scenarios (UNCHANGED) -->
            <section id="module-scenarios" class="module-content">
                <h2 class="text-3xl font-bold mb-6 flex items-center gap-2">應用題型：深度解題與列式實驗室</h2>
                <div class="flex flex-col lg:flex-row gap-6">
                    <!-- Left Menu -->
                    <div class="w-full lg:w-1/3 space-y-4">
                        <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                            <h3 class="font-bold text-slate-800 mb-4 border-b pb-2 flex items-center gap-2"><i
                                    data-lucide="book-open" class="w-4 h-4 text-blue-600"></i> 選題解題練習</h3>
                            <div class="space-y-2">
                                <button onclick="loadScenarioProblem('distFixed')"
                                    class="problem-btn w-full p-4 rounded-xl border text-left hover:bg-slate-50 transition-all outline-none">
                                    <div class="font-bold text-blue-700 text-sm">類型 A：距離一定</div>
                                    <div class="text-[10px] text-slate-500 mt-1">練習「時間 = 距離 ÷ 速率」</div>
                                </button>
                                <button onclick="loadScenarioProblem('timeFixed')"
                                    class="problem-btn w-full p-4 rounded-xl border text-left hover:bg-slate-50 transition-all outline-none">
                                    <div class="font-bold text-orange-700 text-sm">類型 B：時間一定</div>
                                    <div class="text-[10px] text-slate-500 mt-1">練習「距離 = 速率 × 時間」</div>
                                </button>
                                <button onclick="loadScenarioProblem('speedFixed')"
                                    class="problem-btn w-full p-4 rounded-xl border text-left hover:bg-slate-50 transition-all outline-none">
                                    <div class="font-bold text-green-700 text-sm">類型 C：速率一定</div>
                                    <div class="text-[10px] text-slate-500 mt-1">練習「時間與距離的比例」</div>
                                </button>
                            </div>
                            <button onclick="startMixedChallenge()"
                                class="w-full mt-6 py-4 bg-slate-800 text-white rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-slate-700 shadow-lg transition-all"><i
                                    data-lucide="trophy" class="w-5 h-5 text-yellow-400"></i> 綜合實力挑戰</button>
                        </div>
                        <div id="scen-feedback-panel"
                            class="bg-blue-900 text-white p-6 rounded-2xl shadow-lg hidden animate-in fade-in">
                            <h4 class="font-bold mb-2 flex items-center gap-2 text-yellow-400"><i
                                    data-lucide="message-circle" class="w-4 h-4"></i> 老師的小提醒</h4>
                            <p id="scen-feedback-text" class="text-sm leading-relaxed opacity-90"></p>
                        </div>
                    </div>
                    <!-- Right Workspace -->
                    <div class="w-full lg:w-2/3">
                        <div id="scenario-workspace"
                            class="bg-white p-8 rounded-2xl border border-slate-100 shadow-sm min-h-[500px] flex flex-col">
                            <div id="scenario-empty-state"
                                class="flex-1 flex flex-col items-center justify-center text-slate-400"><i
                                    data-lucide="terminal" class="w-12 h-12 mb-4 opacity-20"></i>
                                <p>請從左側選擇一個題型開始...</p>
                            </div>
                            <div id="scenario-active-content" class="hidden animate-in fade-in space-y-8">
                                <div class="bg-blue-50 p-6 rounded-xl border border-blue-100"><span
                                        id="scenario-type-badge"
                                        class="px-2 py-1 bg-blue-600 text-white text-[10px] rounded font-bold uppercase tracking-wider">題型解析</span>
                                    <h3 id="scenario-problem-text"
                                        class="text-lg font-bold text-blue-900 mt-3 leading-relaxed"></h3>
                                </div>
                                <div id="scenario-step-pane" class="space-y-8"></div>
                                <div id="scenario-success-box"
                                    class="hidden bg-green-50 p-6 rounded-xl border border-green-200 text-center animate-bounce">
                                    <i data-lucide="check-circle" class="w-10 h-10 text-green-500 mx-auto mb-2"></i>
                                    <h4 class="font-bold text-green-800 text-lg">解題完成！</h4>
                                    <p id="scenario-conclusion" class="text-sm text-green-700 mt-1"></p>
                                </div>
                            </div>
                            <div id="scenario-challenge-content" class="hidden space-y-8 h-full flex flex-col">
                                <div class="flex justify-between items-center border-b pb-4">
                                    <h3 class="font-bold text-xl flex items-center gap-2 text-slate-800"><i
                                            data-lucide="zap" class="text-yellow-500"></i> 綜合列式挑戰</h3>
                                    <div class="text-sm font-bold bg-slate-100 px-3 py-1 rounded-full text-slate-600">
                                        分數：<span id="challenge-score">0</span></div>
                                </div>
                                <div class="flex-1 py-10">
                                    <div
                                        class="bg-slate-800 text-white p-8 rounded-2xl shadow-xl relative overflow-hidden">
                                        <p id="challenge-q-text"
                                            class="text-xl font-medium leading-relaxed mb-6 text-white"></p>
                                        <div id="challenge-steps-container"
                                            class="space-y-3 max-h-60 overflow-y-auto pr-2 custom-scrollbar"></div>
                                        <div class="flex gap-2 mt-6"><button onclick="addChallengeStep()"
                                                class="px-4 py-3 bg-slate-600 hover:bg-slate-500 rounded-xl font-bold text-white transition-all text-sm flex items-center gap-2"><i
                                                    data-lucide="plus" class="w-4 h-4"></i> 新增算式</button><button
                                                onclick="submitChallenge()"
                                                class="flex-1 py-3 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold text-white transition-all text-lg shadow-lg flex items-center justify-center gap-2">提交答案</button>
                                        </div>
                                    </div>
                                </div>
                                <div id="challenge-feedback" class="text-center h-16 transition-all font-bold text-lg">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Module: Life Literacy Challenge -->
            <section id="module-life" class="module-content">
                <h2 class="text-3xl font-bold mb-6 flex items-center gap-2">生活應用：素養導向解題</h2>

                <!-- Strategy Cards Section -->
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3 mb-8">
                    <div
                        class="bg-white p-3 rounded-xl border-t-4 border-indigo-500 shadow-sm hover:shadow-md transition-shadow cursor-help group relative">
                        <div class="flex items-center gap-2 mb-1">
                            <div class="p-1.5 bg-indigo-100 rounded-lg text-indigo-600"><i data-lucide="footprints"
                                    class="w-4 h-4"></i></div>
                            <h4 class="font-bold text-slate-800 text-sm">追趕策略</h4>
                        </div>
                        <p class="text-[10px] text-slate-500 leading-tight">同向出發，快追慢。<br><span
                                class="text-indigo-600 font-bold block mt-1">時間 = 距離差 ÷ 速率差</span></p>
                        <div
                            class="absolute opacity-0 group-hover:opacity-100 bg-slate-800 text-white text-xs p-2 rounded-lg -bottom-2 left-1/2 -translate-x-1/2 translate-y-full w-48 z-20 pointer-events-none transition-opacity">
                            關鍵：計算每單位時間「縮短」了多少距離。</div>
                    </div>
                    <div
                        class="bg-white p-3 rounded-xl border-t-4 border-blue-500 shadow-sm hover:shadow-md transition-shadow cursor-help group relative">
                        <div class="flex items-center gap-2 mb-1">
                            <div class="p-1.5 bg-blue-100 rounded-lg text-blue-600"><i data-lucide="users"
                                    class="w-4 h-4"></i></div>
                            <h4 class="font-bold text-slate-800 text-sm">相遇策略</h4>
                        </div>
                        <p class="text-[10px] text-slate-500 leading-tight">相向而行，面對面。<br><span
                                class="text-blue-600 font-bold block mt-1">時間 = 距離 ÷ 速率和</span></p>
                        <div
                            class="absolute opacity-0 group-hover:opacity-100 bg-slate-800 text-white text-xs p-2 rounded-lg -bottom-2 left-1/2 -translate-x-1/2 translate-y-full w-48 z-20 pointer-events-none transition-opacity">
                            關鍵：兩人合力縮短距離，效率是相加的。</div>
                    </div>
                    <div
                        class="bg-white p-3 rounded-xl border-t-4 border-orange-500 shadow-sm hover:shadow-md transition-shadow cursor-help group relative">
                        <div class="flex items-center gap-2 mb-1">
                            <div class="p-1.5 bg-orange-100 rounded-lg text-orange-600"><i data-lucide="mountain"
                                    class="w-4 h-4"></i></div>
                            <h4 class="font-bold text-slate-800 text-sm">平均策略</h4>
                        </div>
                        <p class="text-[10px] text-slate-500 leading-tight">全程表現，非算數平均。<br><span
                                class="text-orange-600 font-bold block mt-1">平均 = 總距離 ÷ 總時間</span></p>
                        <div
                            class="absolute opacity-0 group-hover:opacity-100 bg-slate-800 text-white text-xs p-2 rounded-lg -bottom-2 left-1/2 -translate-x-1/2 translate-y-full w-48 z-20 pointer-events-none transition-opacity">
                            陷阱：千萬不能直接把兩個速率相加除以二！</div>
                    </div>
                    <div
                        class="bg-white p-3 rounded-xl border-t-4 border-green-500 shadow-sm hover:shadow-md transition-shadow cursor-help group relative">
                        <div class="flex items-center gap-2 mb-1">
                            <div class="p-1.5 bg-green-100 rounded-lg text-green-600"><i data-lucide="train"
                                    class="w-4 h-4"></i></div>
                            <h4 class="font-bold text-slate-800 text-sm">通過策略</h4>
                        </div>
                        <p class="text-[10px] text-slate-500 leading-tight">物體有長，距離要加。<br><span
                                class="text-green-600 font-bold block mt-1">總距 = 隧道長 + 車長</span></p>
                        <div
                            class="absolute opacity-0 group-hover:opacity-100 bg-slate-800 text-white text-xs p-2 rounded-lg -bottom-2 left-1/2 -translate-x-1/2 translate-y-full w-48 z-20 pointer-events-none transition-opacity">
                            關鍵：從車頭進洞算到車尾出洞，必須加上車身長度。</div>
                    </div>
                    <div
                        class="bg-white p-3 rounded-xl border-t-4 border-red-500 shadow-sm hover:shadow-md transition-shadow cursor-help group relative">
                        <div class="flex items-center gap-2 mb-1">
                            <div class="p-1.5 bg-red-100 rounded-lg text-red-600"><i data-lucide="waves"
                                    class="w-4 h-4"></i></div>
                            <h4 class="font-bold text-slate-800 text-sm">流水策略</h4>
                        </div>
                        <p class="text-[10px] text-slate-500 leading-tight">水幫你推，或水在擋。<br><span
                                class="text-red-600 font-bold block mt-1">順=速+水，逆=速-水</span></p>
                        <div
                            class="absolute opacity-0 group-hover:opacity-100 bg-slate-800 text-white text-xs p-2 rounded-lg -bottom-2 left-1/2 -translate-x-1/2 translate-y-full w-48 z-20 pointer-events-none transition-opacity">
                            關鍵：水流速率是順流時的助力，逆流時的阻力。</div>
                    </div>
                    <div
                        class="bg-white p-3 rounded-xl border-t-4 border-purple-500 shadow-sm hover:shadow-md transition-shadow cursor-help group relative">
                        <div class="flex items-center gap-2 mb-1">
                            <div class="p-1.5 bg-purple-100 rounded-lg text-purple-600"><i data-lucide="volume-2"
                                    class="w-4 h-4"></i></div>
                            <h4 class="font-bold text-slate-800 text-sm">回聲策略</h4>
                        </div>
                        <p class="text-[10px] text-slate-500 leading-tight">聲音來回，距離雙倍。<br><span
                                class="text-purple-600 font-bold block mt-1">單程距離 = (速×時)÷2</span></p>
                        <div
                            class="absolute opacity-0 group-hover:opacity-100 bg-slate-800 text-white text-xs p-2 rounded-lg -bottom-2 left-1/2 -translate-x-1/2 translate-y-full w-48 z-20 pointer-events-none transition-opacity">
                            關鍵：聲音走的是「來回」兩趟，所以計算距離時記得除以 2。</div>
                    </div>
                    <div
                        class="bg-white p-3 rounded-xl border-t-4 border-slate-500 shadow-sm hover:shadow-md transition-shadow cursor-help group relative">
                        <div class="flex items-center gap-2 mb-1">
                            <div class="p-1.5 bg-slate-100 rounded-lg text-slate-600"><i data-lucide="scale"
                                    class="w-4 h-4"></i></div>
                            <h4 class="font-bold text-slate-800 text-sm">單位策略</h4>
                        </div>
                        <p class="text-[10px] text-slate-500 leading-tight">看清單位，換算優先。<br><span
                                class="text-slate-600 font-bold block mt-1">1時=60分=3600秒</span></p>
                        <div
                            class="absolute opacity-0 group-hover:opacity-100 bg-slate-800 text-white text-xs p-2 rounded-lg -bottom-2 left-1/2 -translate-x-1/2 translate-y-full w-48 z-20 pointer-events-none transition-opacity">
                            提醒：計算前先檢查單位是否統一。時速配小時，分速配分鐘。</div>
                    </div>
                </div>

                <div class="flex flex-col lg:flex-row gap-6">
                    <!-- Left Menu -->
                    <div class="w-full lg:w-1/3 space-y-3">
                        <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                            <h3 class="font-bold text-slate-800 mb-4 border-b pb-2 flex items-center gap-2">
                                <i data-lucide="map" class="w-4 h-4 text-indigo-600"></i> 素養情境選擇
                            </h3>
                            <button onclick="loadLiteracyUnit('back_to_back')"
                                class="lit-btn w-full p-4 rounded-xl border text-left hover:bg-indigo-50 transition-all mb-2 flex items-center gap-3 outline-none">
                                <div class="bg-indigo-100 p-2 rounded-lg text-indigo-600"><i data-lucide="footprints"
                                        class="w-5 h-5"></i></div>
                                <div>
                                    <div class="font-bold text-slate-800 text-sm">背向而行</div>
                                    <div class="text-[10px] text-slate-500">公園散步情境</div>
                                </div>
                            </button>
                            <button onclick="loadLiteracyUnit('circle_chase')"
                                class="lit-btn w-full p-4 rounded-xl border text-left hover:bg-blue-50 transition-all mb-2 flex items-center gap-3 outline-none">
                                <div class="bg-blue-100 p-2 rounded-lg text-blue-600"><i data-lucide="refresh-cw"
                                        class="w-5 h-5"></i></div>
                                <div>
                                    <div class="font-bold text-slate-800 text-sm">繞圈追趕</div>
                                    <div class="text-[10px] text-slate-500">操場競賽 (同向)</div>
                                </div>
                            </button>
                            <button onclick="loadLiteracyUnit('circle_meet')"
                                class="lit-btn w-full p-4 rounded-xl border text-left hover:bg-orange-50 transition-all mb-2 flex items-center gap-3 outline-none">
                                <div class="bg-orange-100 p-2 rounded-lg text-orange-600"><i data-lucide="refresh-ccw"
                                        class="w-5 h-5"></i></div>
                                <div>
                                    <div class="font-bold text-slate-800 text-sm">繞圈相遇</div>
                                    <div class="text-[10px] text-slate-500">操場熱身 (反向)</div>
                                </div>
                            </button>
                            <button onclick="loadLiteracyUnit('chase')"
                                class="lit-btn w-full p-4 rounded-xl border text-left hover:bg-indigo-50 transition-all mb-2 flex items-center gap-3 outline-none">
                                <div class="bg-indigo-100 p-2 rounded-lg text-indigo-600"><i data-lucide="siren"
                                        class="w-5 h-5"></i></div>
                                <div>
                                    <div class="font-bold text-slate-800 text-sm">警匪追逐戰</div>
                                    <div class="text-[10px] text-slate-500">直線追趕問題</div>
                                </div>
                            </button>
                            <button onclick="loadLiteracyUnit('meet')"
                                class="lit-btn w-full p-4 rounded-xl border text-left hover:bg-blue-50 transition-all mb-2 flex items-center gap-3 outline-none">
                                <div class="bg-blue-100 p-2 rounded-lg text-blue-600"><i data-lucide="users"
                                        class="w-5 h-5"></i></div>
                                <div>
                                    <div class="font-bold text-slate-800 text-sm">圖書館相遇</div>
                                    <div class="text-[10px] text-slate-500">直線相遇問題</div>
                                </div>
                            </button>
                            <button onclick="loadLiteracyUnit('avg')"
                                class="lit-btn w-full p-4 rounded-xl border text-left hover:bg-orange-50 transition-all mb-2 flex items-center gap-3 outline-none">
                                <div class="bg-orange-100 p-2 rounded-lg text-orange-600"><i data-lucide="mountain"
                                        class="w-5 h-5"></i></div>
                                <div>
                                    <div class="font-bold text-slate-800 text-sm">登山健行計畫</div>
                                    <div class="text-[10px] text-slate-500">平均速率的陷阱</div>
                                </div>
                            </button>
                            <button onclick="loadLiteracyUnit('train')"
                                class="lit-btn w-full p-4 rounded-xl border text-left hover:bg-green-50 transition-all mb-2 flex items-center gap-3 outline-none">
                                <div class="bg-green-100 p-2 rounded-lg text-green-600"><i data-lucide="train"
                                        class="w-5 h-5"></i></div>
                                <div>
                                    <div class="font-bold text-slate-800 text-sm">火車過山洞</div>
                                    <div class="text-[10px] text-slate-500">物體長度與距離</div>
                                </div>
                            </button>
                            <button onclick="loadLiteracyUnit('earthquake')"
                                class="lit-btn w-full p-4 rounded-xl border text-left hover:bg-red-50 transition-all mb-2 flex items-center gap-3 outline-none">
                                <div class="bg-red-100 p-2 rounded-lg text-red-600"><i data-lucide="activity"
                                        class="w-5 h-5"></i></div>
                                <div>
                                    <div class="font-bold text-slate-800 text-sm">地震預警</div>
                                    <div class="text-[10px] text-slate-500">P波與S波的時間差</div>
                                </div>
                            </button>
                            <button onclick="loadLiteracyUnit('stream')"
                                class="lit-btn w-full p-4 rounded-xl border text-left hover:bg-cyan-50 transition-all mb-2 flex items-center gap-3 outline-none">
                                <div class="bg-cyan-100 p-2 rounded-lg text-cyan-600"><i data-lucide="waves"
                                        class="w-5 h-5"></i></div>
                                <div>
                                    <div class="font-bold text-slate-800 text-sm">泛舟順逆流</div>
                                    <div class="text-[10px] text-slate-500">水流速率的影響</div>
                                </div>
                            </button>

                            <button onclick="startLiteracyChallenge()"
                                class="w-full mt-4 py-3 bg-slate-800 text-white rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-slate-700 shadow-lg transition-all text-sm">
                                <i data-lucide="swords" class="w-4 h-4 text-yellow-400"></i> 素養大挑戰 (長篇隨機)
                            </button>
                        </div>
                    </div>

                    <!-- Right Workspace -->
                    <div class="w-full lg:w-2/3">
                        <div id="lit-workspace"
                            class="bg-white p-8 rounded-2xl border border-slate-100 shadow-sm min-h-[500px] flex flex-col relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-10 opacity-5 pointer-events-none"><i
                                    data-lucide="compass" class="w-64 h-64 text-slate-900"></i></div>
                            <div id="lit-empty-state"
                                class="flex-1 flex flex-col items-center justify-center text-slate-400 z-10"><i
                                    data-lucide="book-open-check" class="w-16 h-16 mb-4 opacity-20"></i>
                                <p>請選擇一個生活情境開始探索...</p>
                            </div>

                            <!-- Interactive Story Mode -->
                            <div id="lit-active-content" class="hidden animate-in fade-in space-y-6 z-10">
                                <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                                    <div class="flex items-center gap-2 mb-3"><span
                                            class="px-2 py-1 bg-indigo-600 text-white text-[10px] rounded font-bold uppercase tracking-wider">情境閱讀</span>
                                    </div>
                                    <div id="lit-story-image"
                                        class="mb-4 flex justify-center bg-white rounded-xl border border-slate-100 p-4 shadow-inner">
                                    </div> <!-- New Image Container -->
                                    <p id="lit-story-text" class="text-slate-800 leading-relaxed font-medium text-lg">
                                    </p>
                                </div>
                                <div id="lit-steps-container" class="space-y-4"></div>
                                <div id="lit-success-msg"
                                    class="hidden bg-green-50 p-6 rounded-xl border border-green-200 text-center animate-bounce">
                                    <h4 class="font-bold text-green-800 text-lg flex items-center justify-center gap-2">
                                        <i data-lucide="party-popper" class="w-5 h-5"></i> 挑戰成功！
                                    </h4>
                                    <p id="lit-conclusion" class="text-sm text-green-700 mt-2"></p>
                                </div>
                            </div>

                            <!-- Challenge Mode -->
                            <div id="lit-challenge-content" class="hidden animate-in fade-in z-10 flex flex-col h-full">
                                <div class="flex justify-between items-center border-b pb-4 mb-4">
                                    <h3 class="font-bold text-xl text-slate-800 flex items-center gap-2"><i
                                            data-lucide="brain-circuit" class="text-purple-600"></i> 素養思維挑戰</h3>
                                </div>
                                <div
                                    class="flex-1 bg-slate-50 rounded-2xl p-6 border border-slate-200 flex flex-col gap-6">
                                    <p id="lit-challenge-q" class="text-lg font-bold text-slate-800 leading-relaxed">
                                    </p>
                                    <div id="lit-challenge-steps"
                                        class="space-y-2 flex-1 overflow-y-auto custom-scrollbar pr-2"></div>
                                    <div class="flex gap-2">
                                        <button onclick="addLitChallengeStep()"
                                            class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-xl font-bold transition-all text-sm flex items-center gap-2"><i
                                                data-lucide="plus" class="w-4 h-4"></i> 新增算式</button>
                                        <button onclick="submitLitChallenge()"
                                            class="flex-1 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-xl font-bold transition-all shadow-lg">提交答案</button>
                                    </div>
                                </div>
                                <div id="lit-challenge-feedback"
                                    class="text-center h-12 mt-4 font-bold text-lg transition-all"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        lucide.createIcons();

        // --- Helper: Evaluate Math Expression ---
        function safeEval(str) {
            try {
                // Allow digits, operators, parentheses, decimal point
                const sanitized = str.replace(/[^-()\d/*+.]/g, '');
                if (!sanitized) return null;
                // Basic protection against empty or nonsense
                if (sanitized.length === 0) return null;
                let res = Function(`'use strict'; return (${sanitized})`)();
                return Math.round(res * 100) / 100;
            } catch (e) { return null; }
        }

        // --- Random Utils ---
        function randomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
        function randomFloat(min, max, fixed = 1) { return parseFloat((Math.random() * (max - min) + min).toFixed(fixed)); }

        function switchModule(moduleId) {
            document.querySelectorAll('.module-content').forEach(el => el.classList.remove('active'));
            document.getElementById('module-' + moduleId).classList.add('active');
            document.querySelectorAll('.btn-nav').forEach(btn => btn.classList.remove('active'));
            document.getElementById('nav-' + moduleId).classList.add('active');
            if (moduleId === 'scenarios') resetScenarioUI();
            if (moduleId === 'life') resetLiteracyUI();
        }

        function updateFormula(type) {
            const formulas = {
                speed: { title: '速率 = 距離 ÷ 時間', desc: '物體在單位時間內移動的距離。' },
                distance: { title: '距離 = 速率 × 時間', desc: '物體以特定快慢移動一段時間後的總路程。' },
                time: { title: '時間 = 距離 ÷ 速率', desc: '物體移動特定路段所花費的時間長短。' }
            };
            document.getElementById('formula-title').innerText = formulas[type].title;
            document.getElementById('formula-desc').innerText = formulas[type].desc;
        }

        // --- Race Logic ---
        let raceMode = 'distanceFixed'; let isRacing = false; let raceTimer = null;
        let currentRaceParams = { dist: 100, timeLimit: 10, speedA: 5, speedB: 8 };
        function setRaceMode(mode) {
            raceMode = mode; resetRace();
            document.getElementById('btn-dist-fixed').className = mode === 'distanceFixed' ? 'flex-1 py-2 text-xs rounded-lg font-medium bg-blue-600 text-white shadow' : 'flex-1 py-2 text-xs rounded-lg font-medium bg-slate-100 text-slate-600';
            document.getElementById('btn-time-fixed').className = mode === 'timeFixed' ? 'flex-1 py-2 text-xs rounded-lg font-medium bg-blue-600 text-white shadow' : 'flex-1 py-2 text-xs rounded-lg font-medium bg-slate-100 text-slate-600';
            document.getElementById('distance-slider-group').classList.toggle('hidden', mode !== 'distanceFixed');
            document.getElementById('time-slider-group').classList.toggle('hidden', mode !== 'timeFixed');
            syncRaceParams();
        }
        function syncRaceParams() {
            const dist = parseInt(document.getElementById('input-dist').value);
            const timeLimit = parseInt(document.getElementById('input-time').value);
            const speedA = parseInt(document.getElementById('input-speed-a').value);
            const speedB = parseInt(document.getElementById('input-speed-b').value);
            currentRaceParams = { dist, timeLimit, speedA, speedB };
            document.getElementById('label-dist').innerText = dist;
            document.getElementById('label-time').innerText = timeLimit;
            document.getElementById('label-speed-a').innerText = speedA;
            document.getElementById('label-speed-b').innerText = speedB;
            if (!isRacing) {
                const obs = document.getElementById('observation-box');
                if (raceMode === 'distanceFixed') obs.innerHTML = `🏁 距離 ${dist}m。A 需 ${(dist / speedA).toFixed(1)}s，B 需 ${(dist / speedB).toFixed(1)}s。`;
                else obs.innerHTML = `⏳ 比賽 ${timeLimit}s。A 會跑 ${timeLimit * speedA}m，B 會跑 ${timeLimit * speedB}m。`;
            }
        }
        function startRace() {
            if (isRacing) return; isRacing = true;
            const startTime = Date.now();
            const base = raceMode === 'distanceFixed' ? currentRaceParams.dist : 400;
            raceTimer = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000;
                document.getElementById('race-timer-display').innerText = elapsed.toFixed(2);
                let dA = elapsed * currentRaceParams.speedA, dB = elapsed * currentRaceParams.speedB;
                if (raceMode === 'distanceFixed') {
                    if (dA >= currentRaceParams.dist) dA = currentRaceParams.dist;
                    if (dB >= currentRaceParams.dist) dB = currentRaceParams.dist;
                    if (dA === currentRaceParams.dist && dB === currentRaceParams.dist) { clearInterval(raceTimer); isRacing = false; }
                } else if (elapsed >= currentRaceParams.timeLimit) {
                    dA = currentRaceParams.timeLimit * currentRaceParams.speedA;
                    dB = currentRaceParams.timeLimit * currentRaceParams.speedB;
                    clearInterval(raceTimer); isRacing = false;
                }
                document.getElementById('car-a').style.left = Math.min((dA / base) * 90, 95) + '%';
                document.getElementById('car-b').style.left = Math.min((dB / base) * 90, 95) + '%';
                document.getElementById('car-a-status').innerText = Math.round(dA) + 'm';
                document.getElementById('car-b-status').innerText = Math.round(dB) + 'm';
            }, 30);
        }
        function resetRace() {
            clearInterval(raceTimer); isRacing = false;
            document.getElementById('race-timer-display').innerText = '00.00';
            document.getElementById('car-a').style.left = document.getElementById('car-b').style.left = '0%';
            document.getElementById('car-a-status').innerText = '0m';
            document.getElementById('car-b-status').innerText = '0m';
            syncRaceParams();
        }


        // --- Conversion Logic (REFACTORED) ---
        let currentScenario = null;
        let completedSteps = {};

        // Generator function to create cleaner numbers and distinct challenges
        function generateConvData(type) {
            let data = {};
            if (type === 'plane') {
                // KM/H -> M/S (Divide by 3.6)
                // Pick target m/s (integers like 200, 250, 300) so km/h is nice
                const targetMS = randomInt(4, 8) * 50; // 200, 250, 300, 350, 400
                const speedKMH = targetMS * 3.6;
                data = {
                    name: "民航客機",
                    text: `一架客機的巡航時速為 ${speedKMH} km/h。請將其換算為科學上常用的「秒速 (m/s)」。`,
                    finalMsg: `飛機每秒移動 ${targetMS} 公尺！`,
                    steps: [
                        { id: 1, q: `步驟一：先將 ${speedKMH} 公里換算成「公尺」。`, ans: speedKMH * 1000, hint: "1公里 = 1000公尺，所以要乘還是除呢?", label: "距離換算 (m)" },
                        { id: 2, q: "步驟二：一小時有 60 分鐘，一分鐘有 60 秒，所以一小時等於多少秒？", ans: 3600, hint: "60 × 60 是多少?", label: "時間換算 (s)" },
                        { id: 3, q: "步驟三：距離除以時間。算出飛機每秒移動幾公尺？", ans: targetMS, hint: "步驟一的距離 ÷ 步驟二的時間", label: "最終速率 (m/s)" }
                    ]
                };
            } else if (type === 'sprinter') {
                // M/MIN -> KM/H
                // v(m/min) * 60 = v(m/h); v(m/h) / 1000 = v(km/h)
                // v(m/min) * 0.06 = v(km/h).
                // Pick target km/h as integer (12, 15, 18, 21, 24)
                const targetKMH = 12 + (randomInt(0, 4) * 3); // 12, 15, 18, 21, 24
                const speedMmin = targetKMH / 0.06;
                data = {
                    name: "專業運動員",
                    text: `一位長跑選手的分速為 ${speedMmin} m/min。請問他的「時速 (km/h)」是多少？`,
                    finalMsg: `該選手時速為 ${targetKMH} km/h。`,
                    steps: [
                        { id: 1, q: `步驟一：他一分鐘跑 ${speedMmin} 公尺，那一小時 (60分鐘) 能跑多少公尺？`, ans: speedMmin * 60, hint: "距離 × 60", label: "一小時路程 (m)" },
                        { id: 2, q: "步驟二：將剛剛算出的公尺數，換算成「公里」。", ans: targetKMH, hint: "1公里=1000公尺，大單位換小單位要除以1000", label: "換算公里 (km)" },
                        { id: 3, q: "步驟三：剛剛算出的一小時距離就是時速。請再次確認數值。", ans: targetKMH, hint: "時速的定義就是「一小時走的公里數」", label: "最終時速 (km/h)" }
                    ]
                };
            } else if (type === 'snail') {
                // M/S -> CM/MIN
                // v(m/s) * 100 = cm/s; cm/s * 60 = cm/min
                // Total x 6000.
                // Pick target cm/min (60, 120, 180, 240)
                const targetCmMin = randomInt(1, 4) * 60;
                const speedMs = targetCmMin / 6000; // Likely decimal 0.01, 0.02...
                // Avoid tiny float errors
                const displaySpeedMs = parseFloat(speedMs.toFixed(4));
                data = {
                    name: "蝸牛",
                    text: `這隻蝸牛爬行秒速 ${displaySpeedMs} m/s。請問牠的一分鐘「分速 (cm/min)」是多少？`,
                    finalMsg: `蝸牛分速為 ${targetCmMin} cm/min。`,
                    steps: [
                        { id: 1, q: `步驟一：牠一秒爬 ${displaySpeedMs} m，那一分鐘 (60秒) 爬多少公尺？`, ans: displaySpeedMs * 60, hint: "秒速 × 60", label: "一分鐘路程 (m)" },
                        { id: 2, q: "步驟二：將公尺換算成「公分」。", ans: targetCmMin, hint: "1公尺 = 100公分，所以要乘以100", label: "換算公分 (cm)" },
                        { id: 3, q: "步驟三：填入分速 (cm/min) 數字。", ans: targetCmMin, hint: "就是剛剛算出的公分數喔", label: "最終分速 (cm/min)" }
                    ]
                };
            } else if (type === 'typhoon') {
                // M/S -> KM/H (x 3.6)
                // Pick M/S as multiples of 5 (30, 35, 40, 45, 50, 55, 60)
                const speedMs = randomInt(6, 12) * 5;
                const targetKmh = speedMs * 3.6;
                data = {
                    name: "強烈颱風",
                    text: `氣象局觀測到颱風中心最大風速為 ${speedMs} m/s。請將此風速換算成一般人習慣的「時速 (km/h)」。`,
                    finalMsg: `風速高達 ${targetKmh} km/h！`,
                    steps: [
                        { id: 1, q: `步驟一：一秒走 ${speedMs} m，那一小時 (3600秒) 走多少公尺？`, ans: speedMs * 3600, hint: "秒速 × 3600", label: "一小時路程 (m)" },
                        { id: 2, q: "步驟二：將公尺換算成公里。", ans: targetKmh, hint: "除以 1000", label: "換算公里 (km)" },
                        { id: 3, q: "步驟三：填入時速數字。", ans: targetKmh, hint: "就是剛剛算出的公里數", label: "最終時速 (km/h)" }
                    ]
                };
            }
            return data;
        }

        function loadConversionScenario(id) {
            currentScenario = generateConvData(id);
            completedSteps = {};

            document.getElementById('scenario-intro').classList.remove('hidden');
            document.getElementById('scenario-text').innerText = currentScenario.text;
            document.getElementById('conversion-workspace').classList.remove('hidden');

            // Reset Trace
            const traceContainer = document.getElementById('formula-trace-container');
            traceContainer.innerHTML = '<div class="p-4 bg-slate-50 rounded-xl border border-dashed border-slate-200 text-center" id="trace-placeholder"><p class="text-slate-400 text-sm">請在左側輸入列式，正確的推導過程會記錄在這裡...</p></div>';

            updateStepUI(1);
            document.querySelectorAll('.scenario-btn').forEach(btn => btn.classList.remove('bg-indigo-50', 'border-indigo-500', 'shadow-sm'));
            event.currentTarget.classList.add('bg-indigo-50', 'border-indigo-500', 'shadow-sm');

            // Clear inputs
            [1, 2, 3].forEach(i => {
                document.getElementById('ans-' + i).value = '';
                document.getElementById('feedback-' + i).innerText = '';
                document.getElementById('hint-' + i).innerText = '';
                document.getElementById('ans-' + i).classList.remove('ring-4', 'ring-red-300', 'border-red-500');
            });
            document.getElementById('step-success').classList.add('hidden');
        }

        function updateStepUI(stepId) {
            document.querySelectorAll('.step-pane').forEach(p => p.classList.add('hidden'));
            document.getElementById('step-' + stepId).classList.remove('hidden');
            document.getElementById('step-' + stepId + '-q').innerText = currentScenario.steps[stepId - 1].q;

            // Reset specific hint text but keep structure
            document.getElementById('hint-' + stepId).innerText = "";

            document.querySelectorAll('.step-node').forEach((node, idx) => {
                node.classList.remove('active', 'completed');
                if (idx + 1 < stepId) node.classList.add('completed');
                if (idx + 1 === stepId) node.classList.add('active');
            });

            setTimeout(() => document.getElementById('ans-' + stepId).focus(), 100);
        }

        function handleStepCheck(stepId) {
            const inputEl = document.getElementById('ans-' + stepId);
            const feedbackEl = document.getElementById('feedback-' + stepId);
            const hintEl = document.getElementById('hint-' + stepId);
            const rawValue = inputEl.value.trim();

            // 1. Check if empty
            if (!rawValue) return;

            // 2. FORCE FORMULA: Check if the user just typed a number without operators (simple check)
            // Allow decimals, but if it's just digits and dot, warn them unless it's a very simple step
            // Regex for pure number: start, optional minus, digits, optional dot, digits, end
            const isPureNumber = /^-?\d*\.?\d+$/.test(rawValue);

            // Calculate value
            const calcVal = safeEval(rawValue);
            const targetAns = currentScenario.steps[stepId - 1].ans;

            // If input is pure number AND checks out as correct, we still scold them gently (unless step 3 sometimes is simple copy)
            // But for learning purposes, let's enforce formula for steps 1 & 2 strongly.
            if (isPureNumber && stepId !== 3) { // Allow step 3 to be a number sometimes if it's just copying
                feedbackEl.innerText = "⚠️ 請輸入「算式過程」喔！(例如: 300 * 60)";
                feedbackEl.className = "text-sm font-bold h-6 transition-all text-orange-500";
                return;
            }

            if (calcVal === null) {
                feedbackEl.innerText = "❌ 算式格式錯誤";
                feedbackEl.className = "text-sm font-bold h-6 transition-all text-red-500";
                return;
            }

            // Check correctness
            // Use epsilon for float comparison
            if (Math.abs(calcVal - targetAns) < 0.01) {
                completedSteps[stepId] = calcVal;

                // Success Feedback
                feedbackEl.innerText = "✅ 正確！";
                feedbackEl.className = "text-sm font-bold h-6 transition-all text-green-600";
                inputEl.value = rawValue + " = " + calcVal; // Show result
                inputEl.disabled = true;

                // Add to Trace
                addTraceItem(currentScenario.steps[stepId - 1].label, rawValue, calcVal);

                // Delay to next step
                setTimeout(() => {
                    if (stepId < 3) {
                        updateStepUI(stepId + 1);
                    } else {
                        document.getElementById('step-3').classList.add('hidden');
                        document.getElementById('step-success').classList.remove('hidden');
                        document.getElementById('final-insight').innerText = currentScenario.finalMsg;
                        document.getElementById('node-3').classList.add('completed');
                    }
                }, 1000);

            } else {
                inputEl.classList.add('ring-4', 'ring-red-300');
                setTimeout(() => inputEl.classList.remove('ring-4', 'ring-red-300'), 1000);
                feedbackEl.innerText = "❌ 答案不對，再想想看";
                feedbackEl.className = "text-sm font-bold h-6 transition-all text-red-500";
                hintEl.innerText = "💡 提示：" + currentScenario.steps[stepId - 1].hint;
            }
        }

        function addTraceItem(label, formula, result) {
            const container = document.getElementById('formula-trace-container');
            const placeholder = document.getElementById('trace-placeholder');
            if (placeholder) placeholder.remove();

            const item = document.createElement('div');
            item.className = 'trace-item';
            item.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <span class="text-xs font-bold text-slate-500 bg-slate-200 px-2 py-0.5 rounded">${label}</span>
                    <i data-lucide="check" class="w-3 h-3 text-green-500"></i>
                </div>
                <div class="font-mono text-blue-700 font-bold text-lg">${formula}</div>
                <div class="text-right text-slate-400 text-sm font-mono">= ${result}</div>
            `;
            container.appendChild(item);
            container.scrollTop = container.scrollHeight; // Auto scroll to bottom
            lucide.createIcons();
        }

        function resetConversionLab() {
            currentScenario = null; completedSteps = {};
            document.getElementById('conversion-workspace').classList.add('hidden');
            document.getElementById('scenario-intro').classList.add('hidden');
            document.getElementById('step-success').classList.add('hidden');
            [1, 2, 3].forEach(i => {
                const el = document.getElementById('ans-' + i);
                el.value = '';
                el.disabled = false;
            });
            document.querySelectorAll('.scenario-btn').forEach(btn => btn.classList.remove('bg-indigo-50', 'border-indigo-500', 'shadow-sm'));
        }

        // --- Scenarios & Life Logic (PRESERVED) ---
        // (Keeping existing functions from previous version to ensure other modules work)
        // Only including necessary parts to make sure the full file works.

        let currentScenProblem = null;
        let currentScenSteps = [];

        function generateScenarioData(type) {
            let data = {};
            if (type === 'distFixed') {
                const dist = randomInt(2, 8) * 50;
                const v1 = randomInt(6, 10);
                const v2 = randomInt(2, 5);
                const t1 = dist / v1;
                const t2 = dist / v2;
                data = {
                    title: "類型 A：距離一定",
                    problem: `一場 ${dist} 公尺賽跑中，小明秒速 ${v1} 公尺，小華秒速 ${v2} 公尺。請問小明比小華快幾秒抵達終點？`,
                    steps: [
                        { q: `步驟一：先列式算出小明花的時間 (${dist} ÷ ${v1})`, ans: parseFloat(t1.toFixed(2)), type: 'divide', nums: [dist, v1] },
                        { q: `步驟二：再列式算出小華花的時間 (${dist} ÷ ${v2})`, ans: parseFloat(t2.toFixed(2)), type: 'divide', nums: [dist, v2] },
                        { q: "步驟三：列式計算兩人的時間差", ans: parseFloat(Math.abs(t2 - t1).toFixed(2)), type: 'minus' }
                    ],
                    conclusion: "距離一定時，速率越快，花費時間越少。公式：時間 = 距離 ÷ 速率。"
                };
            } else if (type === 'timeFixed') {
                const time = randomInt(2, 5);
                const v1 = randomInt(40, 60);
                const v2 = randomInt(65, 90);
                const d1 = v1 * time;
                const d2 = v2 * time;
                data = {
                    title: "類型 B：時間一定",
                    problem: `阿輝騎車 ${time} 小時，時速 ${v1} 公里；阿成騎車 ${time} 小時，時速 ${v2} 公里。請問阿成比阿輝多跑了幾公里？`,
                    steps: [
                        { q: `步驟一：列式算出阿輝跑的距離 (${v1} × ${time})`, ans: d1, type: 'multiply', nums: [v1, time] },
                        { q: `步驟二：列式算出阿成跑的距離 (${v2} × ${time})`, ans: d2, type: 'multiply', nums: [v2, time] },
                        { q: "步驟三：列式計算兩人距離的差", ans: Math.abs(d2 - d1), type: 'minus' }
                    ],
                    conclusion: "時間一定時，速率越快，移動距離越遠。公式：距離 = 速率 × 時間。"
                };
            } else {
                const speed = randomInt(6, 12) * 10;
                const dist = speed * randomFloat(1.5, 4.0, 1);
                const timeHr = dist / speed;
                data = {
                    title: "類型 C：速率一定",
                    problem: `某高鐵列車時速固定為 ${speed} km/h。從 A 地到 B 地距離約 ${dist.toFixed(1)} 公里，請問要花多少分鐘？`,
                    steps: [
                        { q: `步驟一：先列式算出需要多少「小時」 (${dist.toFixed(1)} ÷ ${speed})`, ans: parseFloat(timeHr.toFixed(2)), type: 'divide', nums: [dist.toFixed(1), speed] },
                        { q: "步驟二：列式將小時換算成分鐘 (提示: 一小時 60 分)", ans: parseFloat((timeHr * 60).toFixed(1)), type: 'multiply', nums: [60] }
                    ],
                    conclusion: "速率一定時，時間與距離成正比。記得注意單位換算喔！"
                };
            }
            return data;
        }

        function resetScenarioUI() {
            document.getElementById('scenario-empty-state').classList.remove('hidden');
            document.getElementById('scenario-active-content').classList.add('hidden');
            document.getElementById('scenario-challenge-content').classList.add('hidden');
            document.getElementById('scen-feedback-panel').classList.add('hidden');
            document.querySelectorAll('.problem-btn').forEach(b => b.classList.remove('border-blue-500', 'bg-blue-50'));
        }

        function loadScenarioProblem(type) {
            currentScenProblem = generateScenarioData(type);
            currentScenSteps = currentScenProblem.steps;

            document.getElementById('scenario-empty-state').classList.add('hidden');
            document.getElementById('scenario-challenge-content').classList.add('hidden');
            document.getElementById('scenario-active-content').classList.remove('hidden');
            document.getElementById('scen-feedback-panel').classList.remove('hidden');

            document.getElementById('scenario-problem-text').innerText = currentScenProblem.problem;
            document.getElementById('scenario-success-box').classList.add('hidden');
            document.getElementById('scen-feedback-text').innerText = "點擊題目後，請在下方輸入運算過程（列式），不要只寫答案。例如：100 / 5";

            const pane = document.getElementById('scenario-step-pane');
            pane.innerHTML = '';

            currentScenSteps.forEach((step, index) => {
                const stepNum = index + 1;
                const hiddenClass = index === 0 ? '' : 'hidden opacity-0 transition-all duration-500';
                const nodeClass = index === 0
                    ? "w-8 h-8 rounded-full border-2 border-blue-600 flex items-center justify-center font-bold text-blue-600 mt-1 shrink-0"
                    : "w-8 h-8 rounded-full border-2 border-slate-200 flex items-center justify-center font-bold text-slate-300 mt-1 shrink-0";

                const html = `
                    <div id="scen-step-${stepNum}-container" class="${hiddenClass}">
                        <div class="flex items-start gap-4">
                            <div id="scen-node-${stepNum}" class="${nodeClass}">${stepNum}</div>
                            <div class="flex-1">
                                <p class="text-sm font-bold text-slate-700 mb-3">${step.q}</p>
                                <div class="relative">
                                    <input type="text" id="scen-formula-${stepNum}" onkeyup="if(event.key==='Enter') checkScenarioFormula(${stepNum})" class="w-full input-formula px-4 py-3 bg-slate-50 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 font-bold text-lg" placeholder="請輸入列式" ${index !== 0 ? 'disabled' : ''}>
                                    <div id="scen-calc-${stepNum}" class="mt-2 text-xs font-mono text-slate-400"></div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                pane.innerHTML += html;
            });

            setTimeout(() => document.getElementById('scen-formula-1').focus(), 100);

            document.querySelectorAll('.problem-btn').forEach(b => b.classList.remove('border-blue-500', 'bg-blue-50'));
            event.currentTarget.classList.add('border-blue-500', 'bg-blue-50');
        }

        function checkScenarioFormula(step) {
            const input = document.getElementById('scen-formula-' + step);
            const rawValue = input.value.trim();
            const result = safeEval(rawValue);
            const stepData = currentScenSteps[step - 1];
            const feedbackText = document.getElementById('scen-feedback-text');

            if (!isNaN(rawValue) && rawValue !== "") {
                feedbackText.innerText = "⚠️ 發現你直接輸入答案！請寫出「計算過程（列式）」，讓老師知道你是怎麼算的。";
                input.classList.add('ring-4', 'ring-yellow-300');
                setTimeout(() => input.classList.remove('ring-4', 'ring-yellow-300'), 2000);
                return;
            }

            if (result === null) {
                feedbackText.innerText = "❌ 列式格式似乎有誤，請確認是否包含數字與運算符號 (+, -, *, /)。";
                return;
            }

            const isCorrectValue = Math.abs(result - stepData.ans) < 0.1;

            if (isCorrectValue) {
                document.getElementById('scen-calc-' + step).innerText = "✅ 計算結果：" + result;
                document.getElementById('scen-node-' + step).classList.replace('border-blue-600', 'bg-green-500');
                document.getElementById('scen-node-' + step).classList.replace('text-blue-600', 'text-white');
                document.getElementById('scen-node-' + step).innerHTML = '<i data-lucide="check" class="w-4 h-4"></i>';
                lucide.createIcons();
                input.disabled = true;
                feedbackText.innerText = "✨ 太棒了！列式與結果都正確。";

                if (step < currentScenSteps.length) {
                    const next = step + 1;
                    const nextCont = document.getElementById('scen-step-' + next + '-container');
                    nextCont.classList.remove('hidden');
                    setTimeout(() => nextCont.classList.remove('opacity-0'), 50);
                    const nextInput = document.getElementById('scen-formula-' + next);
                    nextInput.disabled = false;
                    nextInput.focus();
                    document.getElementById('scen-node-' + next).className = "w-8 h-8 rounded-full border-2 border-blue-600 flex items-center justify-center font-bold text-blue-600 mt-1 shrink-0";
                } else {
                    document.getElementById('scenario-success-box').classList.remove('hidden');
                    document.getElementById('scenario-conclusion').innerText = currentScenProblem.conclusion;
                }
            } else {
                input.classList.add('ring-4', 'ring-red-300');
                setTimeout(() => input.classList.remove('ring-4', 'ring-red-300'), 1000);

                let hint = "❌ 計算結果不正確。";
                if (stepData.type === 'divide') hint += " 提示：速率公式中，常涉及「除法」運算。";
                if (stepData.type === 'multiply') hint += " 提示：求距離通常需要用「乘法」。";
                if (stepData.type === 'minus') hint += " 提示：比較差距需要用「減法」。";
                feedbackText.innerText = hint;
            }
        }

        // --- Challenge Mode Generator (MULTI-STEP) ---
        let currentChallenge = null;
        let challengeScore = 0;

        function generateChallengeQuestion() {
            const types = ['basic', 'chase', 'meet', 'echo', 'avg', 'train', 'stream', 'delay_chase'];
            const type = types[randomInt(0, types.length - 1)];
            let q, ans, formulaHint;

            if (type === 'basic') {
                const s = randomInt(60, 100);
                const t_min = randomInt(15, 45);
                q = `爸爸開車時速 ${s} 公里，開了 ${t_min} 分鐘，請問走了幾公里？`;
                ans = s * (t_min / 60);
                formulaHint = `需先將分鐘換算成小時：${s} * (${t_min}/60)`;
            } else if (type === 'chase') {
                const vFast = randomInt(12, 18);
                const vSlow = randomInt(5, 10);
                const t_catch = randomInt(10, 30);
                const dist = (vFast - vSlow) * t_catch;
                q = `警察秒速 ${vFast} m，小偷秒速 ${vSlow} m。若警察在 ${t_catch} 秒後追上小偷，請問原本兩人相距多遠？`;
                ans = dist;
                formulaHint = `先算速率差 (${vFast} - ${vSlow})，再乘以時間 ${t_catch}`;
            } else if (type === 'meet') {
                const v1 = randomInt(40, 60);
                const v2 = randomInt(50, 70);
                const dist = randomInt(100, 300);
                q = `甲乙兩地相距 ${dist} 公里。A車時速 ${v1} km，B車時速 ${v2} km，兩人同時相向出發，幾小時後相遇？`;
                ans = dist / (v1 + v2);
                formulaHint = `先算速率和 (${v1} + ${v2})，再用總距離 ${dist} 除以它`;
            } else if (type === 'echo') {
                const v = 340;
                const oneWayDist = randomInt(2, 6) * 170; // 確保時間是整數或簡單小數 (170*2/340=1)
                q = `小明站在距離山壁 ${oneWayDist} 公尺處大喊一聲。已知聲速為 340 m/s，請問他幾秒後會聽到回聲？`;
                ans = (oneWayDist * 2) / v;
                formulaHint = `關鍵：回聲是聲音「來回」走。總距離 = 單趟 ${oneWayDist} × 2，再除以聲速。`;
            } else if (type === 'avg') {
                const t1 = randomInt(2, 5);
                const t2 = randomInt(3, 6);
                const v1 = randomInt(10, 20);
                const v2 = randomInt(20, 30);
                const totalD = (v1 * t1) + (v2 * t2);
                q = `小明跑步，前 ${t1} 秒秒速 ${v1} m，後 ${t2} 秒秒速 ${v2} m。請問全程平均速率 (m/s)？`;
                ans = totalD / (t1 + t2);
                formulaHint = `總距離 (${v1}*${t1} + ${v2}*${t2}) 除以 總時間 (${t1}+${t2})`;
            } else if (type === 'train') {
                const lenTrain = randomInt(100, 200);
                const lenTunnel = randomInt(300, 800);
                const v = randomInt(15, 25);
                q = `一列火車長 ${lenTrain} 公尺，以秒速 ${v} 公尺通過長 ${lenTunnel} 公尺的隧道。從車頭進洞到車尾離開，共需幾秒？`;
                ans = (lenTrain + lenTunnel) / v;
                formulaHint = `總距離是 (車長+隧道長) = ${lenTrain + lenTunnel}，再除以速率 ${v}`;
            } else if (type === 'stream') {
                const vBoat = randomInt(20, 30);
                const vWater = randomInt(2, 5);
                const dist = (vBoat + vWater) * randomInt(2, 4);
                q = `船在靜水時速 ${vBoat} km，水流時速 ${vWater} km。船順流而下行駛 ${dist} 公里，需要幾小時？`;
                ans = dist / (vBoat + vWater);
                formulaHint = `順流速率是 (船速+水速) = ${vBoat + vWater}，再用距離除以它`;
            } else if (type === 'delay_chase') {
                const v1 = randomInt(60, 80);
                const v2 = randomInt(90, 120);
                const delay = randomInt(1, 3);
                q = `甲車時速 ${v1} km 先出發，${delay} 小時後乙車以時速 ${v2} km 從同地追趕。乙車出發幾小時後追上甲車？`;
                ans = (v1 * delay) / (v2 - v1);
                formulaHint = `先算甲先走的距離 (${v1}*${delay})，再除以速率差 (${v2}-${v1})`;
            }
            return { q, ans, hint: formulaHint };
        }

        function startMixedChallenge() {
            challengeScore = 0;
            document.getElementById('scenario-empty-state').classList.add('hidden');
            document.getElementById('scenario-active-content').classList.add('hidden');
            document.getElementById('scenario-challenge-content').classList.remove('hidden');
            document.getElementById('scen-feedback-panel').classList.remove('hidden');
            document.getElementById('scen-feedback-text').innerText = "挑戰開始！請使用多個算式來解決問題，系統會自動核對最後一個算式的結果。";
            document.getElementById('challenge-score').innerText = "0";
            loadNextChallenge();
        }

        function loadNextChallenge() {
            currentChallenge = generateChallengeQuestion();
            document.getElementById('challenge-q-text').innerText = currentChallenge.q;
            document.getElementById('challenge-feedback').innerText = "";
            document.getElementById('challenge-feedback').className = "text-center h-16 transition-all font-bold text-lg";

            const container = document.getElementById('challenge-steps-container');
            container.innerHTML = '';
            addChallengeStep(); // Add first step
        }

        function addChallengeStep() {
            const container = document.getElementById('challenge-steps-container');
            const stepCount = container.children.length + 1;

            const div = document.createElement('div');
            div.className = "challenge-step-row relative flex items-center gap-2 group mb-2";
            div.innerHTML = `
                <div class="step-index w-6 h-6 rounded-full bg-slate-700 text-slate-400 flex items-center justify-center text-xs font-bold shrink-0">${stepCount}</div>
                <div class="flex-1 relative">
                    <input type="text" class="challenge-step-input w-full input-formula bg-slate-700 border-none rounded-xl px-4 py-3 text-lg font-bold focus:ring-2 focus:ring-blue-400 outline-none text-white" placeholder="輸入算式..." onkeyup="handleInputKeyup(event, this)">
                    <div class="calc-result absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 font-mono text-sm"></div>
                </div>
                <button onclick="removeChallengeStep(this)" class="p-2 text-slate-500 hover:text-red-400 transition-colors" title="刪除此行"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
            `;
            container.appendChild(div);
            div.querySelector('input').focus();
            lucide.createIcons();
        }

        function removeChallengeStep(btn) {
            const row = btn.closest('.challenge-step-row');
            row.remove();
            const rows = document.querySelectorAll('.challenge-step-row');
            rows.forEach((r, idx) => {
                r.querySelector('.step-index').innerText = idx + 1;
            });
        }

        function handleInputKeyup(event, input) {
            if (event.key === 'Enter') {
                calculateSingleStep(input);
            }
        }

        function calculateSingleStep(input) {
            const val = input.value.trim();
            const resDiv = input.parentElement.querySelector('.calc-result');
            if (!val) {
                resDiv.innerText = '';
                return;
            }
            const result = safeEval(val);
            if (result !== null) {
                resDiv.innerText = "= " + result;
                resDiv.className = "calc-result absolute right-4 top-1/2 -translate-y-1/2 text-green-400 font-mono text-sm font-bold";
            } else {
                resDiv.innerText = "格式錯誤";
                resDiv.className = "calc-result absolute right-4 top-1/2 -translate-y-1/2 text-red-400 font-mono text-sm";
            }
        }

        function submitChallenge() {
            const rows = document.querySelectorAll('.challenge-step-row');
            if (rows.length === 0) return;

            let lastResult = null;
            rows.forEach(row => {
                const input = row.querySelector('input');
                calculateSingleStep(input);
                const val = safeEval(input.value.trim());
                if (val !== null) lastResult = val;
            });

            const feedback = document.getElementById('challenge-feedback');

            if (lastResult === null) {
                feedback.innerHTML = `<span class="text-yellow-400 font-bold">⚠️ 請輸入有效的算式並按下 Enter 計算後再提交。</span>`;
                return;
            }

            if (Math.abs(lastResult - currentChallenge.ans) < 0.5) {
                challengeScore += 10;
                document.getElementById('challenge-score').innerText = challengeScore;
                feedback.innerHTML = `<span class="text-green-400 text-xl font-bold animate-bounce">✅ 正確！答案是 ${lastResult}</span>`;
                document.querySelectorAll('.challenge-step-input').forEach(i => i.disabled = true);
                setTimeout(loadNextChallenge, 2000);
            } else {
                feedback.innerHTML = `<span class="text-red-400 font-bold">❌ 答案不正確。提示：${currentChallenge.hint}</span>`;
            }
        }

        // --- Life Literacy Logic ---
        let currentLitUnit = null;
        let currentLitChallenge = null;

        function generateLiteracyData(type) {
            let data = {};
            if (type === 'back_to_back') {
                const vA = randomInt(60, 80); // m/min
                const vB = randomInt(40, 60); // m/min
                const time = randomInt(5, 15); // min
                const dist = (vA + vB) * time;
                data = {
                    story: `小明和小華在公園溜冰。兩人在同一地點，同時背向而行。小明分速 ${vA} 公尺，小華分速 ${vB} 公尺。請問 ${time} 分鐘後，兩人相距多遠？`,
                    steps: [
                        { q: "步驟一：兩人是背向而行，每分鐘兩人的距離會拉大多少？（速率和）", ans: vA + vB, hint: `速率和 = ${vA} + ${vB}` },
                        { q: `步驟二：小明 ${time} 分鐘走了多遠？`, ans: vA * time, hint: `距離 = 小明速率 (${vA}) × 時間 (${time})` },
                        { q: `步驟三：小華 ${time} 分鐘走了多遠？`, ans: vB * time, hint: `距離 = 小華速率 (${vB}) × 時間 (${time})` }
                    ],
                    conclusion: `答對了！總距離為 ${dist} 公尺。你可以把兩人的距離加起來，或者直接用 (速率和 × 時間) 算出來喔！`,
                    svg: `<svg viewBox="0 0 300 100" class="w-full h-32"><line x1="150" y1="50" x2="50" y2="50" stroke="#3b82f6" stroke-width="4" marker-end="url(#arrow)" /><line x1="150" y1="50" x2="250" y2="50" stroke="#f97316" stroke-width="4" marker-end="url(#arrow)" /><circle cx="150" cy="50" r="5" fill="#64748b" /><text x="80" y="40" class="text-xs" fill="#3b82f6">小明 ${vA}m</text><text x="200" y="40" class="text-xs" fill="#f97316">小華 ${vB}m</text><defs><marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#64748b" /></marker></defs></svg>`
                };
            } else if (type === 'circle_chase') {
                const vFast = randomInt(6, 8); // m/s
                const vSlow = randomInt(3, 5); // m/s
                const trackLen = 400; // m
                const vDiff = vFast - vSlow;
                const time = parseFloat((trackLen / vDiff).toFixed(1));
                data = {
                    story: `甲乙兩人在 400 公尺的圓形操場練跑。甲秒速 ${vFast} m，乙秒速 ${vSlow} m。兩人同時同地同向出發，請問甲多久後會追上乙一圈？`,
                    steps: [
                        { q: "步驟一：同向跑步，每秒鐘甲會領先乙多少公尺？（速率差）", ans: vDiff, hint: `速率差 = 快 (${vFast}) - 慢 (${vSlow})` },
                        { q: "步驟二：甲要追上乙一圈，代表甲要多跑多少距離？", ans: trackLen, hint: `追上一圈就是多跑操場一圈的長度` },
                        { q: "步驟三：列式求解。需要幾秒鐘才能拉開這 400 公尺的差距？", ans: time, hint: `時間 = 領先距離 (${trackLen}) ÷ 速率差 (${vDiff})` }
                    ],
                    conclusion: `正確！${time}秒後追上。繞圈追趕問題的關鍵在於：追上一圈 = 多跑一圈的距離。`,
                    svg: `<svg viewBox="0 0 300 150" class="w-full h-32"><circle cx="150" cy="75" r="50" fill="none" stroke="#e2e8f0" stroke-width="4" /><path d="M 150 25 A 50 50 0 0 1 200 75" stroke="#3b82f6" stroke-width="3" fill="none" marker-end="url(#arrow-blue)" /><path d="M 150 25 A 50 50 0 0 1 180 40" stroke="#f97316" stroke-width="3" fill="none" marker-end="url(#arrow-orange)" /><circle cx="150" cy="25" r="4" fill="#64748b" /><text x="130" y="20" class="text-xs">起點</text><defs><marker id="arrow-blue" markerWidth="10" markerHeight="10" refX="6" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#3b82f6" /></marker><marker id="arrow-orange" markerWidth="10" markerHeight="10" refX="6" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#f97316" /></marker></defs></svg>`
                };
            } else if (type === 'circle_meet') {
                const vA = randomInt(4, 6); // m/s
                const vB = randomInt(3, 5); // m/s
                const trackLen = 400; // m
                const vSum = vA + vB;
                const time = parseFloat((trackLen / vSum).toFixed(1));
                data = {
                    story: `兩人在 400 公尺操場熱身。兩人同時同地「反向」而跑。A 秒速 ${vA} m，B 秒速 ${vB} m。請問多久後兩人會第一次相遇？`,
                    steps: [
                        { q: "步驟一：反向跑步，每秒鐘兩人合力縮短多少距離？（速率和）", ans: vSum, hint: `速率和 = ${vA} + ${vB}` },
                        { q: "步驟二：兩人相遇時，代表兩人合力跑了多遠？", ans: trackLen, hint: `相遇代表合力跑完一圈` },
                        { q: "步驟三：列式求解。需要幾秒鐘？", ans: time, hint: `時間 = 總距離 (${trackLen}) ÷ 速率和 (${vSum})` }
                    ],
                    conclusion: `沒錯！${time}秒後相遇。繞圈相遇問題其實就等於直線相遇問題，總距離就是跑道長度！`,
                    svg: `<svg viewBox="0 0 300 150" class="w-full h-32"><circle cx="150" cy="75" r="50" fill="none" stroke="#e2e8f0" stroke-width="4" /><path d="M 150 25 A 50 50 0 0 1 200 75" stroke="#3b82f6" stroke-width="3" fill="none" marker-end="url(#arrow-blue)" /><path d="M 150 25 A 50 50 0 0 0 100 75" stroke="#f97316" stroke-width="3" fill="none" marker-end="url(#arrow-orange)" /><circle cx="150" cy="25" r="4" fill="#64748b" /><text x="130" y="20" class="text-xs">起點</text><text x="180" y="40" class="text-[10px]" fill="#3b82f6">A往右</text><text x="90" y="40" class="text-[10px]" fill="#f97316">B往左</text><defs><marker id="arrow-blue" markerWidth="10" markerHeight="10" refX="6" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#3b82f6" /></marker><marker id="arrow-orange" markerWidth="10" markerHeight="10" refX="6" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#f97316" /></marker></defs></svg>`
                };
            } else if (type === 'chase') {
                const vThief = randomInt(10, 15);
                const vPolice = randomInt(18, 25);
                const tLead = randomInt(5, 20);
                const distLead = vThief * tLead;
                const vDiff = vPolice - vThief;
                const tCatch = distLead / vDiff;
                data = {
                    story: `一名大盜騎摩托車以秒速 ${vThief} 公尺逃逸。${tLead} 秒後，巡邏警車以秒速 ${vPolice} 公尺開始追捕。這是一場時間的競賽，警官需要計算出多久能追上。`,
                    steps: [
                        { q: `步驟一：在大盜獨自逃跑的 ${tLead} 秒內，他領先了多少公尺？`, ans: distLead, hint: `距離 = 速率 (${vThief}) × 時間 (${tLead})` },
                        { q: "步驟二：警車每秒鐘比大盜多跑多少公尺？（速率差）", ans: vDiff, hint: `速率差 = 快 (${vPolice}) - 慢 (${vThief})` },
                        { q: `步驟三：要追上這 ${distLead} 公尺的差距，警車需要幾秒鐘？`, ans: tCatch, hint: `追及時間 = 領先距離 (${distLead}) ÷ 速率差 (${vDiff})` }
                    ],
                    conclusion: `分析正確！${tCatch}秒後警車就能追上。追趕問題的核心在於利用「速率差」來消化「領先距離」。`,
                    svg: `<svg viewBox="0 0 300 100" class="w-full h-32"><line x1="50" y1="70" x2="280" y2="70" stroke="#cbd5e1" stroke-width="2" /><circle cx="50" cy="70" r="4" fill="#3b82f6" /><text x="30" y="90" class="text-xs" fill="#3b82f6">警車</text><line x1="50" y1="70" x2="100" y2="70" stroke="#3b82f6" stroke-width="3" marker-end="url(#arrow-blue)" /><circle cx="150" cy="70" r="4" fill="#000" /><text x="140" y="90" class="text-xs">大盜</text><line x1="150" y1="70" x2="180" y2="70" stroke="#000" stroke-width="2" marker-end="url(#arrow-black)" /><line x1="50" y1="40" x2="150" y2="40" stroke="#94a3b8" stroke-dasharray="4" /><text x="80" y="35" class="text-xs text-slate-500">領先距離 ${distLead}m</text><defs><marker id="arrow-blue" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#3b82f6" /></marker><marker id="arrow-black" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#000" /></marker></defs></svg>`
                };
            } else if (type === 'meet') {
                const vA = randomInt(50, 80);
                const vB = randomInt(40, 70);
                const tMeet = randomInt(10, 30);
                const totalDist = (vA + vB) * tMeet;
                data = {
                    story: `小明和小華約好在圖書館見面。兩人同時從相距 ${totalDist} 公尺的家中出發，相向而行。小明分速 ${vA} 公尺，小華分速 ${vB} 公尺。他們多久會相遇？`,
                    steps: [
                        { q: "步驟一：兩人相向而行，每分鐘彼此的距離會縮短多少？（速率和）", ans: vA + vB, hint: `速率和 = ${vA} + ${vB}` },
                        { q: `步驟二：總距離 ${totalDist} 公尺，幾分鐘後會縮短為 0（相遇）？`, ans: tMeet, hint: `相遇時間 = 總距離 (${totalDist}) ÷ 速率和 (${vA + vB})` },
                        { q: "步驟三：相遇時，小明走了多少公尺？", ans: vA * tMeet, hint: `距離 = 小明速率 (${vA}) × 相遇時間 (${tMeet})` }
                    ],
                    conclusion: `太棒了！${tMeet}分鐘後相遇。相向問題的關鍵是兩人共同縮短距離，所以速率要相加喔！`,
                    svg: `<svg viewBox="0 0 300 100" class="w-full h-32"><line x1="20" y1="50" x2="280" y2="50" stroke="#cbd5e1" stroke-width="2" /><circle cx="20" cy="50" r="5" fill="#3b82f6" /><circle cx="280" cy="50" r="5" fill="#f97316" /><line x1="20" y1="50" x2="80" y2="50" stroke="#3b82f6" stroke-width="3" marker-end="url(#arrow-blue)" /><line x1="280" y1="50" x2="220" y2="50" stroke="#f97316" stroke-width="3" marker-end="url(#arrow-orange)" /><text x="20" y="80" class="text-xs" fill="#3b82f6">小明</text><text x="260" y="80" class="text-xs" fill="#f97316">小華</text><text x="130" y="30" class="text-xs text-slate-500">總距離 ${totalDist}m</text><defs><marker id="arrow-blue" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#3b82f6" /></marker><marker id="arrow-orange" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#f97316" /></marker></defs></svg>`
                };
            } else if (type === 'avg') {
                const tUp = randomInt(2, 5);
                const tDown = randomInt(1, tUp - 1);
                const oneWayDist = randomInt(3, 12); // km
                const totalDist = oneWayDist * 2;
                const totalTime = tUp + tDown;
                const avgSpeed = parseFloat((totalDist / totalTime).toFixed(2));
                data = {
                    story: `全家去登山，上山路程 ${oneWayDist} 公里，走了 ${tUp} 小時；原路下山比較快，只花了 ${tDown} 小時。請問這趟登山行程的平均速率是多少？`,
                    steps: [
                        { q: `步驟一：計算總距離。上山 ${oneWayDist} 公里，原路下山也是 ${oneWayDist} 公里，全程幾公里？`, ans: totalDist, hint: `總距離 = 上山 + 下山` },
                        { q: `步驟二：計算總時間。上山 ${tUp} 小時，下山 ${tDown} 小時，總共花了幾小時？`, ans: totalTime, hint: `總時間 = 上山時間 + 下山時間` },
                        { q: "步驟三：平均速率 = 總距離 ÷ 總時間。", ans: avgSpeed, hint: `${totalDist} ÷ ${totalTime}` }
                    ],
                    conclusion: `正確！平均速率是 ${avgSpeed} km/h。記得喔，平均速率絕對不是直接將速率相加除以二！`,
                    svg: `<svg viewBox="0 0 300 150" class="w-full h-32"><path d="M 50 120 L 150 20 L 250 120" stroke="#64748b" stroke-width="2" fill="none" /><line x1="50" y1="120" x2="250" y2="120" stroke="#cbd5e1" stroke-dasharray="4" /><line x1="60" y1="110" x2="100" y2="70" stroke="#ef4444" stroke-width="3" marker-end="url(#arrow-red)" /><text x="30" y="100" class="text-xs" fill="#ef4444">上山 ${tUp}h</text><line x1="160" y1="30" x2="200" y2="70" stroke="#22c55e" stroke-width="3" marker-end="url(#arrow-green)" /><text x="210" y="60" class="text-xs" fill="#22c55e">下山 ${tDown}h</text><text x="120" y="140" class="text-xs text-slate-500">單程 ${oneWayDist}km</text><defs><marker id="arrow-red" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#ef4444" /></marker><marker id="arrow-green" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#22c55e" /></marker></defs></svg>`
                };
            } else if (type === 'train') {
                const lenTrain = randomInt(100, 200);
                const lenTunnel = randomInt(400, 800);
                const v = randomInt(20, 30);
                const totalDist = lenTrain + lenTunnel;
                const time = totalDist / v;
                data = {
                    story: `一列長 ${lenTrain} 公尺的火車，以秒速 ${v} 公尺的速率通過長 ${lenTunnel} 公尺的隧道。請問從車頭進洞到車尾完全離開，需要幾秒鐘？`,
                    steps: [
                        { q: "步驟一：火車要完全通過隧道，實際走的距離是「隧道長」加上什麼？", ans: totalDist, hint: `總距離 = 隧道長 (${lenTunnel}) + 車長 (${lenTrain})` },
                        { q: `步驟二：有了總距離，速率是 ${v} m/s，需要幾秒鐘？`, ans: time, hint: `時間 = 總距離 (${totalDist}) ÷ 速率 (${v})` },
                        { q: "步驟三：(進階) 如果只算車頭進洞到車頭出洞，距離是多少？", ans: lenTunnel, hint: `車頭對車頭，距離就是隧道長度喔！` }
                    ],
                    conclusion: `完全正確！${time}秒。火車過山洞這類題目，千萬別忘了加上火車本身的長度喔！`,
                    svg: `<svg viewBox="0 0 300 100" class="w-full h-32"><rect x="100" y="30" width="180" height="40" fill="#e2e8f0" stroke="#64748b" /><text x="160" y="55" class="text-xs text-slate-500">隧道 ${lenTunnel}m</text><rect x="20" y="40" width="60" height="20" fill="#3b82f6" rx="2" /><text x="25" y="35" class="text-xs" fill="#3b82f6">火車 ${lenTrain}m</text><line x1="80" y1="50" x2="95" y2="50" stroke="#3b82f6" stroke-width="2" marker-end="url(#arrow-blue)" /><defs><marker id="arrow-blue" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#3b82f6" /></marker></defs></svg>`
                };
            } else if (type === 'earthquake') {
                const vP = 6; // km/s
                const vS = 4; // km/s
                const dist = randomInt(10, 50) * 12; // distance
                const tDiff = dist / vS - dist / vP;
                data = {
                    story: `地震發生時會產生 P 波 (秒速 6 km) 和 S 波 (秒速 4 km)。某觀測站偵測到 P 波後，過了 ${tDiff} 秒才偵測到 S 波。請問震央距離該站多遠？`,
                    steps: [
                        { q: "步驟一：計算每過一秒，P 波會領先 S 波幾公里？（速率差）", ans: 2, hint: `速率差 = 6 - 4` },
                        { q: `步驟二：總共領先了 ${tDiff} 秒的距離，若換算成距離差是多少？(思考一下)`, ans: -1, hint: `這裡的邏輯比較複雜，我們換個方式：時間差 = 距離/慢速 - 距離/快速。` },
                        { q: `修正引導：讓我們直接列式。設距離為 D。D/4 - D/6 = ${tDiff}。算出 D 是多少？`, ans: dist, hint: `通分計算：(3D - 2D)/12 = ${tDiff}，所以 D = 12 × ${tDiff}` }
                    ],
                    conclusion: `答對了！震央距離 ${dist} 公里。這就是利用波速差異來進行地震預警的原理！`,
                    svg: `<svg viewBox="0 0 300 100" class="w-full h-32"><circle cx="30" cy="50" r="5" fill="#ef4444" /><text x="20" y="70" class="text-xs" fill="#ef4444">震央</text><path d="M 40 50 Q 60 20 80 50 T 120 50" stroke="#ef4444" stroke-width="2" fill="none" /><text x="70" y="40" class="text-[10px]" fill="#ef4444">P波 (快)</text><path d="M 40 60 Q 50 50 60 60 T 80 60" stroke="#f97316" stroke-width="2" fill="none" /><text x="50" y="80" class="text-[10px]" fill="#f97316">S波 (慢)</text><rect x="250" y="35" width="30" height="30" fill="#64748b" /><text x="250" y="80" class="text-xs">測站</text><line x1="30" y1="20" x2="265" y2="20" stroke="#cbd5e1" stroke-dasharray="4" marker-end="url(#arrow-gray)" /><text x="130" y="15" class="text-xs text-slate-400">距離 D = ?</text><defs><marker id="arrow-gray" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#cbd5e1" /></marker></defs></svg>`
                };
            } else if (type === 'stream') {
                const vBoat = randomInt(20, 30);
                const vWater = randomInt(2, 5);
                const dist = (vBoat + vWater) * randomInt(2, 4);
                const tDown = dist / (vBoat + vWater);
                const tUp = parseFloat((dist / (vBoat - vWater)).toFixed(2));
                data = {
                    story: `一艘觀光船在河中行駛。靜水時速 ${vBoat} km/h，水流時速 ${vWater} km/h。船長要計畫從上游碼頭開到下游 ${dist} 公里處的景點，再原路返回。順流去程和逆流回程各需要多久？`,
                    steps: [
                        { q: "步驟一：計算順流速率。", ans: vBoat + vWater, hint: `順流速率 = 船速 (${vBoat}) + 水速 (${vWater})` },
                        { q: "步驟二：計算去程（順流）需要幾小時？", ans: tDown, hint: `時間 = 距離 (${dist}) ÷ 順流速率` },
                        { q: "步驟三：計算回程（逆流）需要幾小時？(提示：逆流速率 = 船速 - 水速)", ans: tUp, hint: `逆流速率 = ${vBoat - vWater}。時間 = ${dist} ÷ ${vBoat - vWater}` }
                    ],
                    conclusion: `答對了！順流需 ${tDown} 小時，逆流需 ${tUp} 小時。水流在順流時是助力，逆流時是阻力。`,
                    svg: `<svg viewBox="0 0 300 100" class="w-full h-32"><path d="M 0 60 Q 50 40 100 60 T 200 60 T 300 60" stroke="#38bdf8" stroke-width="2" fill="none" /><path d="M 0 70 Q 50 50 100 70 T 200 70 T 300 70" stroke="#38bdf8" stroke-width="2" fill="none" /><path d="M 50 50 L 90 50 L 80 70 L 60 70 Z" fill="#f97316" /><line x1="90" y1="50" x2="130" y2="50" stroke="#f97316" stroke-width="3" marker-end="url(#arrow-orange)" /><text x="50" y="40" class="text-xs" fill="#f97316">船速</text><line x1="150" y1="80" x2="180" y2="80" stroke="#38bdf8" stroke-width="2" marker-end="url(#arrow-cyan)" /><text x="150" y="95" class="text-[10px]" fill="#38bdf8">水流</text><defs><marker id="arrow-orange" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#f97316" /></marker><marker id="arrow-cyan" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#38bdf8" /></marker></defs></svg>`
                };
            }
            return data;
        }

        function resetLiteracyUI() {
            document.getElementById('lit-empty-state').classList.remove('hidden');
            document.getElementById('lit-active-content').classList.add('hidden');
            document.getElementById('lit-challenge-content').classList.add('hidden');
            document.querySelectorAll('.lit-btn').forEach(b => b.classList.remove('bg-slate-100', 'border-slate-400'));
        }

        function loadLiteracyUnit(id) {
            currentLitUnit = generateLiteracyData(id);
            document.getElementById('lit-empty-state').classList.add('hidden');
            document.getElementById('lit-challenge-content').classList.add('hidden');
            document.getElementById('lit-active-content').classList.remove('hidden');
            document.getElementById('lit-story-text').innerText = currentLitUnit.story;
            document.getElementById('lit-story-image').innerHTML = currentLitUnit.svg; // Inject SVG
            document.getElementById('lit-success-msg').classList.add('hidden');
            const container = document.getElementById('lit-steps-container');
            container.innerHTML = '';
            currentLitUnit.steps.forEach((step, idx) => {
                const num = idx + 1;
                const div = document.createElement('div');
                div.className = idx === 0 ? "step-block opacity-100" : "step-block opacity-50 pointer-events-none";
                div.id = `lit-step-block-${num}`;
                div.innerHTML = `
                    <div class="flex gap-4 items-start lit-step-row">
                        <div class="w-8 h-8 rounded-full bg-slate-200 text-slate-500 font-bold flex items-center justify-center shrink-0 step-idx">${num}</div>
                        <div class="flex-1 space-y-2">
                            <p class="font-bold text-slate-700 text-sm">${step.q}</p>
                            <div class="relative">
                                <input type="text" id="lit-ans-${num}" class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 font-mono input-formula" placeholder="輸入列式..." onkeyup="if(event.key==='Enter') checkLiteracyFormula(${num})">
                                <div class="absolute right-3 top-1/2 -translate-y-1/2 text-xs font-mono text-slate-400 lit-calc-res" id="lit-calc-${num}"></div>
                            </div>
                            <div class="flex justify-end">
                                <button onclick="checkLiteracyFormula(${num})" class="px-4 py-2 bg-slate-800 text-white rounded-lg text-sm font-bold hover:bg-slate-700">確認</button>
                            </div>
                            <p id="lit-hint-${num}" class="text-xs text-red-500 hidden font-bold"></p>
                        </div>
                    </div>`;
                container.appendChild(div);
            });
            document.querySelectorAll('.lit-btn').forEach(b => b.classList.remove('bg-slate-100', 'border-slate-400'));
        }

        function checkLiteracyFormula(stepNum) {
            const input = document.getElementById(`lit-ans-${stepNum}`);
            const rawVal = input.value.trim();
            const resDiv = document.getElementById(`lit-calc-${stepNum}`);
            const hintEl = document.getElementById(`lit-hint-${stepNum}`);
            const stepData = currentLitUnit.steps[stepNum - 1];
            const calcVal = safeEval(rawVal);
            if (calcVal === null) {
                resDiv.innerText = "格式錯誤";
                resDiv.className = "absolute right-3 top-1/2 -translate-y-1/2 text-xs font-mono text-red-500 font-bold";
                return;
            }
            resDiv.innerText = "= " + calcVal;
            resDiv.className = "absolute right-3 top-1/2 -translate-y-1/2 text-xs font-mono text-green-600 font-bold";
            if (Math.abs(calcVal - stepData.ans) < 0.1) {
                input.classList.add('border-green-500', 'bg-green-50');
                input.disabled = true;
                hintEl.classList.add('hidden');
                const block = document.getElementById(`lit-step-block-${stepNum}`);
                block.querySelector('.step-idx').classList.replace('bg-slate-200', 'bg-green-500');
                block.querySelector('.step-idx').classList.replace('text-slate-500', 'text-white');
                block.querySelector('.step-idx').innerHTML = '<i data-lucide="check" class="w-4 h-4"></i>';
                lucide.createIcons();
                if (stepNum < currentLitUnit.steps.length) {
                    const nextBlock = document.getElementById(`lit-step-block-${stepNum + 1}`);
                    nextBlock.classList.remove('opacity-50', 'pointer-events-none');
                    nextBlock.querySelector('input').focus();
                } else {
                    document.getElementById('lit-success-msg').classList.remove('hidden');
                    document.getElementById('lit-conclusion').innerText = currentLitUnit.conclusion;
                }
            } else {
                input.classList.add('ring-2', 'ring-red-400');
                setTimeout(() => input.classList.remove('ring-2', 'ring-red-400'), 1000);
                hintEl.innerText = `💡 提示：${stepData.hint}`;
                hintEl.classList.remove('hidden');
            }
        }

        function startLiteracyChallenge() {
            document.getElementById('lit-empty-state').classList.add('hidden');
            document.getElementById('lit-active-content').classList.add('hidden');
            document.getElementById('lit-challenge-content').classList.remove('hidden');
            loadLitChallengeQuestion();
        }

        function generateComplexLiteracyChallenge() {
            const scenarios = [
                {
                    type: 'back_to_back',
                    gen: () => {
                        const v1 = randomInt(50, 70);
                        const v2 = randomInt(40, 60);
                        const t = randomInt(10, 20);
                        const q = `【公園探險】\n小明和小華在公園中央噴水池背對背同時出發探險。小明分速 ${v1} 公尺，小華分速 ${v2} 公尺。請問經過 ${t} 分鐘後，兩人相距多遠？`;
                        const ans = (v1 + v2) * t;
                        return { q, ans, hint: "兩人背向而行，距離會越來越遠。總距離 = (速率和) × 時間。" };
                    }
                },
                {
                    type: 'circle_chase',
                    gen: () => {
                        const track = 400;
                        const vSlow = randomInt(3, 5);
                        const vFast = vSlow + randomInt(1, 3);
                        const q = `【操場競賽】\n甲乙兩人在 ${track} 公尺的圓形跑道上練習長跑。甲秒速 ${vFast} m，乙秒速 ${vSlow} m。兩人同時同地「同向」出發。請問甲最快幾秒後可以追上乙一圈？(計算至小數點後一位)`;
                        const ans = parseFloat((track / (vFast - vSlow)).toFixed(1));
                        return { q, ans, hint: "追上一圈的意思，就是甲比乙多跑了 400 公尺。 時間 = 400 ÷ 速率差。" };
                    }
                },
                {
                    type: 'circle_meet',
                    gen: () => {
                        const track = 400;
                        const v1 = randomInt(4, 6);
                        const v2 = randomInt(3, 5);
                        const q = `【反向熱身】\n體育課暖身，老師要求同學在 ${track} 公尺操場同時同地「反向」而跑。A 生秒速 ${v1} m，B 生秒速 ${v2} m。請問出發後幾秒兩人會第一次相遇？(計算至小數點後一位)`;
                        const ans = parseFloat((track / (v1 + v2)).toFixed(1));
                        return { q, ans, hint: "反向而行相遇，代表兩人合力跑完了一圈。 時間 = 400 ÷ 速率和。" };
                    }
                },
                {
                    type: 'police_chase',
                    gen: () => {
                        const vThief = randomInt(20, 25);
                        const vPolice = vThief + randomInt(5, 10);
                        const tDelay = randomInt(10, 30); // seconds delay
                        const q = `【高速追逐】\n高速公路上發生警匪追逐。嫌犯車輛以秒速 ${vThief} 公尺逃逸，經過 ${tDelay} 秒後，警車才從同一個交流道駛入主線開始追趕，警車速率為秒速 ${vPolice} 公尺。假設雙方都維持等速行駛，請問警車需要幾秒鐘才能追上嫌犯？(計算至小數點後一位)`;
                        const lead = vThief * tDelay;
                        const diff = vPolice - vThief;
                        const ans = parseFloat((lead / diff).toFixed(1));
                        return { q, ans, hint: "這是典型的追趕問題。先算嫌犯偷跑了多遠（領先距離），再除以警車每秒能追回的距離（速率差）。" };
                    }
                },
                {
                    type: 'city_meet',
                    gen: () => {
                        const dist = randomInt(200, 400); // km
                        const vA = randomInt(80, 100);
                        const vB = randomInt(60, 90);
                        const q = `【雙城會面】\nA城與B城相距 ${dist} 公里。甲車從A城出發時速 ${vA} km，乙車從B城出發時速 ${vB} km，兩人同時出發相向而行。請問經過幾小時後兩車會相遇？(計算至小數點後一位)`;
                        const ans = parseFloat((dist / (vA + vB)).toFixed(1));
                        return { q, ans, hint: "相遇問題：時間 = 總距離 ÷ (甲速 + 乙速)。" };
                    }
                },
                {
                    type: 'avg_speed',
                    gen: () => {
                        const k = randomInt(1, 3);
                        const D = 12 * k; // Distance is a multiple of 12
                        const S_up = 3 * k; // t_up = 4
                        const S_down = 4 * k; // t_down = 3
                        const q = `【極限登山】\n週末小明挑戰登山步道，單程長度 ${D} 公里。上山時坡度陡峭，時速僅 ${S_up} 公里；下山時輕鬆許多，時速加快為 ${S_down} 公里。請問：整趟往返行程的「平均速率」是多少 km/h？(計算至小數點後一位)`;
                        const totalDist = D * 2;
                        const totalTime = (D / S_up) + (D / S_down);
                        const ans = parseFloat((totalDist / totalTime).toFixed(1));
                        return { q, ans, hint: "平均速率 = 總距離 ÷ 總時間。注意：絕對不能直接把上山和下山的速率相加除以二！" };
                    }
                },
                {
                    type: 'train_tunnel',
                    gen: () => {
                        const v = randomInt(15, 25); // m/s
                        const t = randomInt(20, 40); // total seconds
                        const totalDist = v * t;
                        const trainLen = randomInt(100, 300);
                        const tunnelLen = totalDist - trainLen;
                        const q = `【高鐵工程】\n工程師在計算列車通過隧道的數據。已知列車長度 ${trainLen} 公尺，行駛速率秒速 ${v} 公尺。若從車頭進洞到車尾完全離開隧道，總共耗時 ${t} 秒。請問這座隧道長度是多少公尺？`;
                        return { q, ans: tunnelLen, hint: "火車通過隧道的總距離 = 隧道長 + 車長。先算出火車總共跑了多遠 (速率 × 時間)，再扣掉車長。" };
                    }
                },
                {
                    type: 'echo_cliff',
                    gen: () => {
                        const vSound = 340;
                        const t = randomFloat(1.5, 3.5, 1); // 1.5 ~ 3.5 sec
                        const q = `【峽谷回音】\n探險家對著遠處的山壁大喊一聲，經過 ${t} 秒後聽到了回聲。已知當時氣溫下的聲音傳播速率約為 340 m/s。請問探險家距離山壁大約多少公尺？(計算至小數點後一位)`;
                        const ans = parseFloat(((vSound * t) / 2).toFixed(1));
                        return { q, ans, hint: "聲音走的是「來回」兩趟（去程+回程），所以計算單程距離時，算出來的總距離記得要除以 2。" };
                    }
                },
                {
                    type: 'stream_boat',
                    gen: () => {
                        const vWater = randomInt(2, 4);
                        const vBoat = vWater * randomInt(4, 6);
                        const dist = (vBoat + vWater) * randomInt(2, 4);
                        const q = `【泛舟之旅】\n一艘遊艇在河流中航行，船本身的動力速率為時速 ${vBoat} 公里，當天的水流速率為時速 ${vWater} 公里。船長計畫從上游甲地開往下游乙地，兩地距離 ${dist} 公里。請問：如果船要從乙地逆流返回甲地，需要花費多少小時？(計算至小數點後一位)`;
                        const vUp = vBoat - vWater;
                        const ans = parseFloat((dist / vUp).toFixed(1));
                        return { q, ans, hint: "逆流時，水流是阻力。逆流速率 = 船原本的速率 - 水流速率。" };
                    }
                }
            ];
            const scenario = scenarios[randomInt(0, scenarios.length - 1)];
            return scenario.gen();
        }

        function loadLitChallengeQuestion() {
            currentLitChallenge = generateComplexLiteracyChallenge();
            document.getElementById('lit-challenge-q').innerText = currentLitChallenge.q;
            document.getElementById('lit-challenge-feedback').innerText = "";
            document.getElementById('lit-challenge-steps').innerHTML = "";
            addLitChallengeStep();
        }

        function addLitChallengeStep() {
            const container = document.getElementById('lit-challenge-steps');
            const idx = container.children.length + 1;
            const div = document.createElement('div');
            div.className = "flex items-center gap-2 mb-2 lit-step-row";
            div.innerHTML = `
                <div class="w-6 h-6 rounded-full bg-slate-200 text-slate-500 font-bold flex items-center justify-center shrink-0 text-xs">${idx}</div>
                <div class="flex-1 relative">
                    <input type="text" class="lit-challenge-input w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-purple-500 font-mono text-sm" placeholder="輸入算式..." onkeyup="if(event.key==='Enter') calcLitStep(this)">
                    <div class="absolute right-3 top-1/2 -translate-y-1/2 text-xs font-mono text-slate-400 calc-res"></div>
                </div>
                <button onclick="this.parentElement.remove()" class="text-slate-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
            container.appendChild(div);
            div.querySelector('input').focus();
            lucide.createIcons();
        }

        function calcLitStep(input) {
            const val = input.value.trim();
            const resDiv = input.parentElement.querySelector('.calc-res');
            if (!val) { resDiv.innerText = ""; return; }
            const res = safeEval(val);
            if (res !== null) { resDiv.innerText = "= " + res; resDiv.classList.add('text-green-600', 'font-bold'); }
            else { resDiv.innerText = "格式錯誤"; resDiv.classList.add('text-red-500'); }
        }

        function submitLitChallenge() {
            const inputs = document.querySelectorAll('.lit-challenge-input');
            if (inputs.length === 0) return;
            let lastVal = null;
            inputs.forEach(input => { calcLitStep(input); lastVal = safeEval(input.value.trim()); });
            const feedback = document.getElementById('lit-challenge-feedback');
            if (lastVal !== null && Math.abs(lastVal - currentLitChallenge.ans) < 0.5) {
                feedback.innerText = "🎉 正確答案！太厲害了！"; feedback.className = "text-center h-12 mt-4 font-bold text-lg text-green-600 animate-bounce"; setTimeout(loadLitChallengeQuestion, 2000);
            } else {
                feedback.innerText = `❌ 答案不對喔... ${currentLitChallenge.hint}`; feedback.className = "text-center h-12 mt-4 font-bold text-sm text-red-500";
            }
        }

        switchModule('welcome');
    </script>
</body>

</html>